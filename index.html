<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=yes">
    <title>My Life - Gestor Dom√©stico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --primary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --success: #2ecc71;
            --border: #dfe6e9;
            --love: #e84393;
            --star: #ffd700;
            --heart: #e84393;
            --event-yellow: #e67e22;
            --gasto: #9b59b6;
            --report: #1abc9c;
            --calendar: #e74c3c;
            --purple: #9b59b6;
            --purple-light: #d7bde2;
            --purple-dark: #8e44ad;
            --bg-vencida: #ffe6e6;
            --bg-pendente: #e8f5e8;
            --bg-evento: #fff9e6;
            --bg-amor: #ffe6f2;
            --bg-gasto: #f2e6ff;
            --rotina: #3498db;
            --medico: #2c3e50;
            --bg-pago: #f0f0f0;
            --text-pago: #7f8c8d;
            --semanal: #16a085;
            --anual: #d35400;
            --bg-success-light: #d4edda;
            --text-success: #155724;
            --bg-danger-light: #f8d7da;
            --text-danger: #721c24;
            --bg-warning-light: #fff3cd;
            --text-warning: #856404;
            --green-dark: #2e7d32;
            --mp: #009ee3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            color: var(--dark);
            line-height: 1.4;
            font-size: 14px;
            overflow-x: hidden;
            padding-bottom: 70px
        }

        @media (min-width: 1024px) {
            body {
                max-width: 900px;
                margin: 0 auto;
                background: #e0e0e0;
            }
            
            .calendar-section, .filters, .content-area {
                max-width: 860px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        #authContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000
        }

        .auth-box {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
            width: 90%;
            max-width: 350px
        }

        .auth-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--purple-dark);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        .form-group {
            margin-bottom: 16px
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color .2s;
            background: #fff
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 0;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(155, 89, 182, .1)
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn {
            padding: 10px 16px;
            border: 0;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .2s;
            font-size: 14px;
            min-height: 44px
        }

        .btn:hover {
            opacity: .9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: #fff
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: #fff
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: #fff
        }

        .btn-love {
            background: linear-gradient(135deg, var(--love), #fd79a8);
            color: #fff
        }

        .btn-gasto {
            background: linear-gradient(135deg, var(--gasto), var(--purple-dark));
            color: #fff
        }

        .btn-pagarme {
            background: linear-gradient(135deg, var(--mp), #0077b3);
            color: #fff
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 36px
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            color: var(--gray);
            font-size: 13px
        }

        .auth-link {
            color: var(--purple);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer
        }

        .forgot-password-link {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            margin-bottom: 16px;
        }
        
        .forgot-password-link a {
            color: var(--purple);
            font-size: 13px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .forgot-password-link a:hover {
            text-decoration: underline;
        }

        #mainContainer {
            display: none
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 0 8px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
            height: 56px
        }

        @media (min-width: 1024px) {
            .header {
                max-width: 900px;
                margin: 0 auto;
                border-radius: 0 0 8px 8px;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            gap: 4px
        }

        .header h1 {
            font-size: clamp(0.9rem, 4vw, 1.1rem);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 110px
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 1;
            min-width: 0
        }

        .header-today-btn {
            background: rgba(255, 255, 255, .2);
            color: #fff;
            border: 0;
            border-radius: 16px;
            padding: 4px 8px;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
            cursor: pointer;
            white-space: nowrap
        }

        .saldo-header {
            background: rgba(255, 255, 255, .15);
            color: #fff;
            border: 0;
            border-radius: 20px;
            padding: 4px 8px;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0
        }

        .usuario-header {
            background: var(--purple-dark);
            color: #fff;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .header-btn {
            background: rgba(255, 255, 255, .15);
            color: #fff;
            border: 0;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0
        }

        .assinatura-badge {
            background: var(--warning);
            color: var(--dark);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 4px;
            display: inline-block;
        }

        .assinatura-expirada {
            background: var(--danger);
            color: white;
        }

        .calendar-section {
            background: #fff;
            padding: 10px;
            margin: 6px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            cursor: pointer;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1em;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff;
            padding: 4px 12px;
            border-radius: 16px;
            cursor: pointer
        }

        .calendar-nav button {
            background: 0 0;
            border: 0;
            color: var(--purple);
            font-size: 1.1em;
            cursor: pointer;
            padding: 2px 6px
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            min-height: 280px
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 3px 2px;
            color: var(--gray);
            font-size: .8em;
            background: #f8f9fa;
            border-radius: 3px
        }

        .calendar-day {
            padding: 3px 2px;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            min-height: 38px;
            display: flex;
            flex-direction: column;
            background: #fff;
            font-size: 11px
        }

        .calendar-day:hover {
            background: #f8f9fa
        }

        .calendar-day.today {
            background: linear-gradient(135deg, var(--purple-light), var(--purple)) !important;
            color: #fff !important
        }

        .calendar-day.today .day-number {
            color: #fff !important
        }

        .calendar-day.selected {
            border: 2px solid var(--warning)
        }

        .day-number {
            font-weight: 600;
            text-align: left;
            margin-bottom: 2px;
            font-size: 11px;
            padding-left: 2px
        }

        .calendar-events-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: auto;
            width: 100%
        }

        .contas-badges-line {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: flex-end;
            align-items: center;
            position: absolute;
            top: 2px;
            right: 2px
        }

        .eventos-emojis-line {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            line-height: 1;
            margin-top: 12px
        }

        .event-emoji-calendar {
            font-size: 1.1em;
            margin: 0 1px
        }

        .day-badge {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: .7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .2)
        }

        .badge-conta {
            background: var(--success)
        }

        .badge-conta-vencida {
            background: var(--danger)
        }

        .badge-evento {
            background: var(--warning)
        }

        .badge-amor {
            background: var(--love)
        }

        .badge-rotina {
            background: var(--rotina)
        }

        .badge-medico {
            background: var(--medico)
        }

        .filters {
            background: #fff;
            padding: 10px;
            margin: 6px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08)
        }

        .filter-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            position: relative
        }

        .filter-btn {
            padding: 12px 8px;
            border: 2px solid #e8e8e8;
            background: #fafafa;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-size: 13px;
            min-height: 60px;
            transition: all 0.2s;
            position: relative;
            width: 120px
        }

        @media (max-width: 768px) {
            .filter-btn {
                width: 100%;
            }
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff;
            border-color: var(--purple-dark);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3)
        }

        .filter-btn i {
            font-size: 18px
        }

        .filter-check {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.2s
        }

        .filter-btn.active .filter-check {
            opacity: 1
        }

        .content-area {
            padding: 6px
        }

        .filter-info {
            margin-bottom: 10px;
            color: var(--purple);
            font-weight: 600;
            font-size: 13px;
            padding: 8px 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            cursor: pointer;
        }

        .items-list {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            overflow: hidden
        }

        .item-card {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-left: 3px solid var(--purple);
            min-height: 52px;
            transition: all 0.2s
        }

        .item-card.vencida {
            border-left-color: var(--danger);
            background-color: var(--bg-vencida)
        }

        .item-card.pendente {
            border-left-color: var(--success);
            background-color: var(--bg-pendente)
        }

        .item-card.paga {
            border-left-color: var(--gray);
            background-color: var(--bg-pago);
            color: var(--text-pago);
            opacity: .7
        }

        .item-card.paga .item-title {
            text-decoration: line-through
        }

        .item-card.gasto {
            border-left-color: var(--gasto);
            background-color: var(--bg-gasto)
        }

        .item-card.evento {
            border-left-color: var(--warning);
            background-color: var(--bg-evento)
        }

        .item-card.giro {
            border-left-color: var(--success);
            background-color: var(--bg-pendente)
        }

        .item-info {
            flex: 1;
            min-width: 0
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--purple);
            flex-wrap: wrap
        }

        .item-details {
            font-size: .8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--gray)
        }

        .item-value {
            font-weight: 600;
            font-size: 1.1em;
            margin-left: 6px;
            white-space: nowrap;
            color: var(--purple)
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-left: 6px;
            flex-shrink: 0
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 0;
            color: #fff;
            font-size: .8em;
            transition: all 0.2s
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2)
        }

        .action-btn.edit {
            background: var(--purple)
        }

        .action-btn.delete {
            background: var(--danger)
        }

        .action-btn.pay {
            background: var(--success)
        }

        .action-btn.update {
            background: var(--warning)
        }

        .action-btn.undo {
            background: var(--warning)
        }

        .action-btn.extract {
            background: var(--purple-dark)
        }

        .action-btn.activate {
            background: var(--success)
        }

        .action-btn.deactivate {
            background: var(--gray)
        }

        .item-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: .7em;
            font-weight: 700;
            background: #e8e0f5;
            color: var(--purple);
            white-space: nowrap
        }

        .badge-recorrente {
            background: var(--purple-light);
            color: var(--purple-dark)
        }

        .section-divider {
            background: #f8f9fa;
            padding: 8px 12px;
            margin: 12px 0 6px;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 1px solid #eee;
            font-size: .85em
        }

        .loading-spinner {
            text-align: center;
            padding: 30px;
            color: var(--gray)
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--gray);
            background: #fff;
            border-radius: 8px
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px)
        }

        .modal-content {
            background: #fff;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15)
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10
        }

        .modal-title {
            font-size: 1.1em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--purple)
        }

        .close-modal {
            background: 0 0;
            border: 0;
            font-size: 1.6em;
            cursor: pointer;
            color: var(--gray);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: var(--danger)
        }

        .modal-body {
            padding: 20px
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .2);
            z-index: 2000;
            max-width: 90%;
            text-align: center
        }

        .toast.success {
            background: var(--success)
        }

        .toast.error {
            background: var(--danger)
        }

        .frequency-btn {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600
        }

        .frequency-btn.active {
            background: var(--purple);
            color: #fff
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px
        }

        .icon-option {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 24px
        }

        .icon-option:hover {
            background: #f0f0f0
        }

        .icon-option.selected {
            background: var(--purple-light);
            border-color: var(--purple)
        }

        .menu-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .menu-item i {
            color: var(--purple);
            font-size: 1.1em;
            width: 24px
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 8px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 998;
            color: #fff
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                max-width: 900px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: 20px 20px 0 0;
            }
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
            padding: 8px 0;
            transition: all 0.2s;
            border: none;
            background: transparent;
            position: relative
        }

        .nav-item i {
            font-size: 20px
        }

        .nav-item.active {
            color: #fff;
            transform: translateY(-2px)
        }

        .nav-add-btn {
            background: var(--purple-dark) !important;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 28px !important;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.5) !important
        }

        .nav-add-btn i {
            font-size: 28px !important;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3)
        }

        .nav-add-btn.active {
            transform: rotate(45deg) scale(0.95);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2)
        }

        .lista-badge {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: #fff;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border: 2px solid #fff;
            font-weight: 700
        }

        .add-options-menu {
            position: fixed;
            bottom: 80px;
            right: 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 12px;
            z-index: 999;
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px
        }

        @media (min-width: 1024px) {
            .add-options-menu {
                right: 50%;
                transform: translateX(50%);
            }
        }

        .add-options-menu.show {
            display: flex
        }

        .add-option {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s
        }

        .add-option:hover {
            background: #f5f5f5
        }

        .add-option i {
            width: 24px;
            text-align: center;
            font-size: 18px
        }

        .add-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #fff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .side-menu {
                left: -280px;
                border-radius: 0 8px 8px 0;
            }
            
            .side-menu.open {
                left: 0;
            }
            
            .side-menu.open ~ .side-menu-overlay {
                display: block;
            }
        }

        .side-menu.open {
            left: 0
        }

        .side-menu-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
        }

        .side-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.2s
        }

        .side-menu-item:hover {
            background: #f5f5f5
        }

        .side-menu-item i {
            color: var(--purple);
            width: 24px;
            font-size: 1.2em
        }

        .side-menu-footer {
            border-top: 1px solid #eee;
            padding: 15px 20px;
            background: #f9f9f9;
            font-size: 12px;
            color: var(--gray);
            text-align: center;
        }

        .side-menu-footer a {
            color: var(--purple);
            text-decoration: none;
            display: block;
            margin: 4px 0;
            font-size: 12px;
        }

        .side-menu-footer a:hover {
            text-decoration: underline;
        }

        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none
        }

        .side-menu-overlay.open {
            display: block
        }

        .delete-option {
            padding: 15px;
            margin: 5px 0;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer
        }

        .delete-option.selected {
            background: var(--purple-light)
        }

        .delete-option.warning {
            background: var(--bg-danger-light)
        }

        .date-range {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .date-range .form-group {
            flex: 1
        }

        .giro-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px
        }

        .giro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px
        }

        .giro-titulo {
            font-weight: 700;
            color: var(--purple);
            font-size: 1.1em
        }

        .giro-saldo {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--purple-dark)
        }

        .giro-historico {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            margin-top: 8px;
            padding-top: 8px;
            font-size: .9em
        }

        .giro-linha {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between
        }

        .usuario-badge {
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--purple-light);
            color: var(--purple-dark);
            font-size: .8em;
            margin-left: 5px
        }

        .notificacao-option {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px
        }

        .notificacao-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer
        }

        .exclusao-opcoes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0
        }

        .exclusao-opcao {
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s
        }

        .exclusao-opcao:hover {
            border-color: var(--purple);
            background: #f8f9fa
        }

        .exclusao-opcao.selected {
            border-color: var(--purple);
            background: var(--purple-light)
        }

        .payment-info {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px
        }

        .payment-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: var(--purple-dark);
            font-weight: 600
        }

        .payment-info-content {
            word-break: break-all;
            background: #fff;
            padding: 8px;
            border-radius: 4px;
            border: 1px dashed var(--purple-light);
            font-family: monospace
        }

        .btn-copy {
            background: var(--purple);
            color: #fff;
            border: 0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px
        }

        .report-chart {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px
        }

        .chart-bar-container {
            margin: 10px 0
        }

        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px
        }

        .chart-bar-bg {
            background: #f0f0f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple), var(--purple-dark));
            border-radius: 10px;
            transition: width 0.3s ease
        }

        .chart-bar-fill.warning {
            background: linear-gradient(90deg, var(--warning), #e67e22)
        }

        .chart-bar-fill.success {
            background: linear-gradient(90deg, var(--success), #27ae60)
        }

        .calendar-input {
            position: relative;
            display: flex;
            align-items: center
        }

        .calendar-input input {
            padding-right: 30px
        }

        .calendar-input i {
            position: absolute;
            right: 10px;
            color: var(--purple);
            pointer-events: none
        }

        .inline-calendar {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto
        }

        .inline-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px
        }

        .inline-calendar-day {
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px
        }

        .inline-calendar-day:hover {
            background: var(--purple-light)
        }

        .inline-calendar-day.selected {
            background: var(--purple);
            color: #fff
        }

        .inline-calendar-day.today {
            border: 1px solid var(--purple)
        }

        .inline-calendar-day.disabled {
            opacity: 0.3;
            pointer-events: none;
            background: #f0f0f0;
            cursor: not-allowed
        }

        .inline-calendar-day.active {
            background: var(--bg-success-light);
            color: var(--text-success);
            font-weight: 600;
            border: 1px solid var(--success)
        }

        .inline-calendar-day.active:hover {
            background: var(--success);
            color: #fff
        }

        .extrato-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .extrato-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: var(--purple)
        }

        .extrato-detalhes {
            font-size: 0.9em;
            color: var(--gray)
        }

        .extrato-tipo {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600
        }

        .extrato-tipo.pagamento {
            background: var(--bg-success-light);
            color: var(--text-success)
        }

        .extrato-tipo.recebimento {
            background: var(--bg-warning-light);
            color: var(--text-warning)
        }

        .historico-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .historico-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: var(--purple)
        }

        .historico-data {
            font-size: 0.8em;
            color: var(--gray)
        }

        .historico-descricao {
            font-size: 0.9em
        }

        .historico-usuario {
            font-size: 0.8em;
            color: var(--purple-dark);
            font-weight: 600
        }

        .plano-card {
            background: linear-gradient(135deg, var(--purple-light), var(--purple));
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .plano-card:hover {
            transform: scale(1.02);
        }

        .plano-card.mensal {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .plano-card.anual {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .plano-preco {
            font-size: 1.5em;
            font-weight: 700;
            margin: 8px 0;
        }

        .plano-periodo {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .plano-destaque {
            position: relative;
            overflow: hidden;
        }

        .plano-destaque::after {
            content: "üî• MAIS VENDIDO";
            position: absolute;
            top: 10px;
            right: -30px;
            background: var(--danger);
            color: white;
            padding: 5px 30px;
            font-size: 0.7em;
            font-weight: 700;
            transform: rotate(45deg);
        }

        .exclusao-gasto-opcao {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .exclusao-gasto-opcao:hover {
            border-color: var(--purple);
            background: var(--purple-light);
        }

        .exclusao-gasto-opcao.selected {
            border-color: var(--purple);
            background: var(--purple-light);
        }

        .toggle-saldo {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            font-size: 11px;
        }

        .toggle-saldo i {
            font-size: 12px;
        }

        .toggle-saldo.active {
            background: var(--success);
        }

        .extract-btn {
            background: var(--purple);
            color: #fff;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="authContainer">
        <div class="auth-box">
            <h2 class="auth-title"><i class="fas fa-home"></i> My Life</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" inputmode="email">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Sua senha">
                </div>
                <div class="forgot-password-link">
                    <a href="#" onclick="handleForgotPassword()">Esqueci minha senha?</a>
                </div>
                <button class="btn btn-primary" id="btnLogin" style="width:100%">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                <div class="auth-toggle">
                    N√£o tem conta? <a class="auth-link" id="linkRegister">Registrar</a>
                </div>
            </div>
            <div id="registerForm" style="display:none">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Nome</label>
                    <input type="text" id="registerName" class="form-input" placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="seu@email.com" inputmode="email">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="M√≠nimo 6 caracteres">
                </div>
                <button class="btn btn-success" id="btnRegister" style="width:100%">
                    <i class="fas fa-user-plus"></i> Criar Conta
                </button>
                <div class="auth-toggle">
                    J√° tem conta? <a class="auth-link" id="linkLogin">Entrar</a>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContainer">
        <div class="side-menu-overlay" id="sideMenuOverlay"></div>
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header"><i class="fas fa-home"></i> My Life</div>
            <div class="side-menu-content">
                <div class="side-menu-item" onclick="abrirMenuRelatorio();fecharSideMenu()"><i class="fas fa-chart-line"></i> Relat√≥rio</div>
                <div class="side-menu-item" onclick="abrirNotificacoes();fecharSideMenu()"><i class="fas fa-bell"></i> Notifica√ß√µes</div>
                <div class="side-menu-item" onclick="abrirMenuSeguranca();fecharSideMenu()"><i class="fas fa-lock"></i> Seguran√ßa</div>
                <div class="side-menu-item" onclick="abrirUltimasAcoes();fecharSideMenu()"><i class="fas fa-history"></i> √öltimas A√ß√µes</div>
                <div class="side-menu-item" onclick="abrirPoliticasTermos();fecharSideMenu()"><i class="fas fa-file-contract"></i> Pol√≠ticas e Termos</div>
                <div class="side-menu-item" onclick="abrirManual();fecharSideMenu()"><i class="fas fa-book"></i> Manual</div>
                <div class="side-menu-item" onclick="abrirModalAssinatura();fecharSideMenu()"><i class="fas fa-crown"></i> <span id="menuAssinaturaStatus">Premium</span></div>
                <div class="side-menu-item" onclick="window.location.href='mailto:hcdtec.mylife@gmail.com'"><i class="fas fa-question-circle"></i> Ajuda</div>
            </div>
            <div class="side-menu-footer">
                Esse √© um APP do Grupo Mundo Carol Ltda.<br>
                Conhe√ßa outras empresas do grupo<br>
                <a href="https://www.mundocarol.com.br" target="_blank">www.mundocarol.com.br</a>
                <a href="https://www.mcembalagens.com.br" target="_blank">www.mcembalagens.com.br</a>
                <a href="https://www.cactodeouro.com.br" target="_blank">www.cactodeouro.com.br</a>
                <a href="https://www.hcdtec.com.br" target="_blank">www.hcdtec.com.br</a>
            </div>
        </div>

        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-home"></i> My Life</h1>
                <div class="header-center">
                    <button class="header-today-btn" id="btnToday"><i class="fas fa-calendar-day"></i> Hoje</button>
                    <div class="saldo-header" id="btnSaldoHeader" style="display:flex;">
                        <i class="fas fa-wallet"></i><span id="saldoHeaderValue">R$ 0,00</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="usuario-header" id="btnUsuarioHeader">
                        <i class="fas fa-user"></i><span id="usuarioHeaderNome">Selecionar</span>
                    </div>
                    <button class="header-btn" id="btnLogout" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>

        <div class="calendar-section" onclick="voltarParaCalendario()">
            <div class="calendar-header">
                <div class="calendar-title" id="calendarTitle">Carregando...</div>
                <div class="calendar-nav">
                    <button id="btnPrevMonth" onclick="event.stopPropagation()"><i class="fas fa-chevron-left"></i></button>
                    <button id="btnNextMonth" onclick="event.stopPropagation()"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid" onclick="event.stopPropagation()"></div>
        </div>

        <div class="filters">
            <div class="filter-buttons" id="filterButtons">
                <button class="filter-btn" data-filter="contas">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Contas</span>
                    <span class="filter-check"><i class="fas fa-check"></i></span>
                </button>
                <button class="filter-btn" data-filter="eventos">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Eventos</span>
                    <span class="filter-check"><i class="fas fa-check"></i></span>
                </button>
            </div>
        </div>

        <div class="content-area">
            <div class="filter-info" id="filterInfo" onclick="voltarParaCalendario()"></div>
            <div class="loading-spinner" id="loadingState" style="display:none">
                <i class="fas fa-spinner fa-spin"></i>
                <div>Carregando...</div>
            </div>
            <div id="contentArea">
                <div id="dynamicContent"></div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item" id="navMenu"><i class="fas fa-bars"></i><span>Menu</span></button>
            <button class="nav-item" id="navSaldos"><i class="fas fa-wallet"></i><span>Saldos</span></button>
            <button class="nav-item" id="navGastos"><i class="fas fa-shopping-bag"></i><span>Gastos</span></button>
            <button class="nav-item" id="navGiros"><i class="fas fa-hand-holding-usd"></i><span>Giros</span></button>
            <button class="nav-item" id="navLista"><i class="fas fa-shopping-cart"></i><span>Lista</span><span class="lista-badge" id="listaBadge" style="display:none">0</span></button>
            <button class="nav-item nav-add-btn" id="navAdd"><i class="fas fa-plus"></i></button>
        </div>

        <div class="add-options-menu" id="addOptionsMenu">
            <div class="add-option contas" onclick="verificarEAcao('conta')"><i class="fas fa-file-invoice-dollar"></i><span>Nova Conta</span></div>
            <div class="add-option eventos" onclick="verificarEAcao('evento')"><i class="fas fa-calendar-plus"></i><span>Novo Evento</span></div>
            <div class="add-option gastos" onclick="verificarEAcao('gasto')"><i class="fas fa-shopping-bag"></i><span>Novo Gasto</span></div>
            <div class="add-option lista" onclick="verificarEAcao('lista')"><i class="fas fa-shopping-cart"></i><span>Novo Item na Lista</span></div>
            <div class="add-option giro" onclick="verificarEAcao('giro')"><i class="fas fa-hand-holding-usd"></i><span>Novo Giro</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <div id="toast" class="toast" style="display:none"></div>

    <script>
        const CONFIG = {
            supabase: {
                url: 'https://rirvrrlgjetsgwhqqfvq.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcnZycmxnamV0c2d3aHFxZnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDM2MzgsImV4cCI6MjA4NjIxOTYzOH0.1T5eQnQXMCRqOSxtYFIHMedAF_D0Jo4Mg36LZHLJ2ds'
            },
            mercadopago: {
                links: {
                    mensal: 'https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=9a30d25477b445028fd6374c1b5d51f9',
                    anual: 'https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=59d5d72cfcee476b99776abcbddc4adf'
                }
            },
            meses: ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            diasSemana: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'],
            categoriasGastos: [
                { id: 'mercado', nome: 'Mercado', icon: 'fa-shopping-cart' },
                { id: 'lazer', nome: 'Lazer', icon: 'fa-film' },
                { id: 'fastfood', nome: 'Fastfood', icon: 'fa-hamburger' },
                { id: 'medicos', nome: 'M√©dicos', icon: 'fa-user-md' },
                { id: 'emergencias', nome: 'Emerg√™ncias', icon: 'fa-ambulance' },
                { id: 'oficina', nome: 'Oficina', icon: 'fa-car' },
                { id: 'outros', nome: 'Outros', icon: 'fa-ellipsis-h' }
            ],
            iconesEventos: [
                { nome: 'Estrela', icon: 'fa-star', cor: '#ffd700' },
                { nome: 'Cora√ß√£o', icon: 'fa-heart', cor: '#e84393' },
                { nome: 'Seta', icon: 'fa-redo', cor: '#3498db' },
                { nome: 'M√©dico', icon: 'fa-user-md', cor: '#e67e22' },
                { nome: 'Carro', icon: 'fa-car', cor: '#e67e22' },
                { nome: 'Avi√£o', icon: 'fa-plane', cor: '#3498db' },
                { nome: 'Carrinho', icon: 'fa-shopping-cart', cor: '#9b59b6' },
                { nome: 'Bicicleta', icon: 'fa-bicycle', cor: '#e67e22' },
                { nome: 'Futebol', icon: 'fa-futbol', cor: '#2c3e50' },
                { nome: 'Peteca', icon: 'fa-feather-alt', cor: '#e74c3c' },
                { nome: 'V√¥lei', icon: 'fa-volleyball-ball', cor: '#f39c12' },
                { nome: 'Anivers√°rio', icon: 'fa-birthday-cake', cor: '#e84393' },
                { nome: 'Rel√≥gio', icon: 'fa-clock', cor: '#34495e' },
                { nome: 'Pizza', icon: 'fa-pizza-slice', cor: '#d35400' },
                { nome: 'Diamante', icon: 'fa-gem', cor: '#3498db' },
                { nome: 'Floco', icon: 'fa-snowflake', cor: '#3498db' },
                { nome: 'Rem√©dio', icon: 'fa-capsules', cor: '#e74c3c' },
                { nome: 'Pasta', icon: 'fa-folder', cor: '#f39c12' },
                { nome: 'Praia', icon: 'fa-umbrella-beach', cor: '#f1c40f' },
                { nome: 'Igreja', icon: 'fa-church', cor: '#8e44ad' },
                { nome: 'C√©u', icon: 'fa-cloud-sun', cor: '#3498db' },
                { nome: 'Montanha', icon: 'fa-mountain', cor: '#27ae60' },
                { nome: 'Sol', icon: 'fa-sun', cor: '#f39c12' },
                { nome: 'Lua', icon: 'fa-moon', cor: '#34495e' }
            ],
            frequenciasConta: ['unico', 'semanal', 'quinzenal', 'mensal', 'semestral', 'anual'],
            frequenciasEvento: ['unico', 'semanal', 'quinzenal', 'mensal', 'semestral', 'anual'],
            notificacaoAntecedencia: [
                { valor: 0, label: 'No dia' },
                { valor: 1, label: '1 dia antes' },
                { valor: 2, label: '2 dias antes' },
                { valor: 3, label: '3 dias antes' },
                { valor: 7, label: '1 semana antes' },
                { valor: 14, label: '2 semanas antes' },
                { valor: 30, label: '1 m√™s antes' }
            ],
            anosLimite: {
                passado: 3,
                futuro: 5
            },
            mesesParaLimpar: 3
        };

        const App = {
            supabase: null,
            currentUser: null,
            currentMonthOffset: 0,
            activeFilters: { contas: true, eventos: true },
            selectedDay: null,
            selectedMonth: new Date().getMonth() + 1,
            selectedYear: new Date().getFullYear(),
            acessoNovaSenha: '',
            modalHasChanges: false,
            pendingDelete: null,
            saldoCentral: { id: null, valor: 0 },
            historicoAcoes: [],
            notificacoesConfig: {
                contas: true,
                eventos: true,
                lista: true,
                novoItem: false,
                tipo: 'ambos',
                antecedencia: {
                    contas: 0,
                    eventos: 0,
                    lista: 0
                }
            },
            currentFilter: 'all',
            dataCache: {
                contas: [], regrasContas: [], eventos: [], eventosIndividuais: [], regrasEventos: [],
                gastos: [], lista: [], saldos: [], historico: [], excecoesRecorrencia: [],
                giros: [], movimentacoesGiro: []
            },
            notificacoesAgendadas: [],
            serviceWorkerRegistration: null,
            processandoPagamento: false,
            assinaturaAtiva: true,
            dataExpiracao: null,
            usuarioAtual: null,
            processandoLinkPagamento: false,
            cacheLoaded: false,
            exibirSaldoHeader: true
        };

        // Fun√ß√£o para recuperar senha
        async function handleForgotPassword() {
            const email = prompt("Digite seu e-mail para recuperar a senha:");
            if (!email) return;

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor, digite um e-mail v√°lido.');
                return;
            }

            try {
                const { error } = await App.supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: 'https://mylife.app.br/redefinir-senha.html'
                });

                if (error) throw error;
                
                alert('‚úÖ E-mail de recupera√ß√£o enviado! Verifique sua caixa de entrada (e a pasta de spam).');
                
            } catch (error) {
                alert('Erro ao enviar: ' + error.message);
            }
        }

        // Fun√ß√£o para voltar ao calend√°rio (ajuste 7)
        function voltarParaCalendario() {
            App.currentFilter = 'all';
            mostrarConteudo();
        }

        // Fun√ß√µes auxiliares
        function showToast(mensagem, tipo) {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function formatCurrency(valor) {
            return 'R$ ' + (valor || 0).toFixed(2).replace('.', ',');
        }

        function parseCurrency(valor) {
            if (!valor) return 0;
            if (typeof valor === 'string') return parseFloat(valor.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            return parseFloat(valor) || 0;
        }

        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getNomeMes(numero) {
            return CONFIG.meses[numero - 1] || '';
        }

        function getMesAnoAtual() {
            const hoje = new Date();
            const data = new Date(hoje.getFullYear(), hoje.getMonth() + App.currentMonthOffset, 1);
            return { mes: data.getMonth() + 1, ano: data.getFullYear() };
        }

        function dataValida(ano, mes, dia) {
            return dia >= 1 && dia <= getDiasNoMes(ano, mes);
        }

        function criarData(ano, mes, dia) {
            return new Date(ano, mes - 1, dia, 12, 0, 0);
        }

        function dataParaString(ano, mes, dia) {
            return `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        }

        function stringParaData(str) {
            return new Date(str + 'T12:00:00');
        }

        function atualizarSaldoHeader() {
            const saldoElement = document.getElementById('btnSaldoHeader');
            const valorElement = document.getElementById('saldoHeaderValue');
            
            if (App.saldoCentral) {
                saldoElement.style.display = 'flex';
                valorElement.textContent = formatCurrency(App.saldoCentral.valor);
            } else {
                saldoElement.style.display = 'none';
            }
        }

        async function verificarNotificacoes(item, tipo) {
            if (!App.currentUser || !('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            
            let config = App.notificacoesConfig;
            if (!config[tipo] && tipo !== 'novoItem') return;
            if (tipo === 'novoItem' && !config.novoItem) return;
            
            let corpo = `${item.descricao || item.titulo || item} - ${App.usuarioAtual}`;
            
            if (config.tipo === 'banner' || config.tipo === 'ambos') {
                showToast(`üîî ${corpo}`, 'info');
            }
            
            if (config.tipo === 'bloqueio' || config.tipo === 'ambos') {
                new Notification('My Life', {
                    body: corpo,
                    icon: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/home.svg',
                    badge: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/bell.svg',
                    vibrate: [200, 100, 200],
                    requireInteraction: true
                });
            }
        }

        async function verificarECriarSaldoCentral() {
            if (!App.currentUser) return;
            
            try {
                const { data: saldos, error } = await App.supabase
                    .from('saldos')
                    .select('*')
                    .eq('user_id', App.currentUser.id);
                
                if (error) throw error;
                
                if (!saldos || saldos.length === 0) {
                    console.log('Criando saldo central automaticamente');
                    
                    const { data: novoSaldo, error: insertError } = await App.supabase
                        .from('saldos')
                        .insert({
                            user_id: App.currentUser.id,
                            nome: 'Saldo Central',
                            valor: 0,
                            is_central: true,
                            added_by: 'sistema',
                            created_at: new Date().toISOString()
                        })
                        .select();
                    
                    if (insertError) throw insertError;
                    
                    if (novoSaldo && novoSaldo[0]) {
                        App.saldoCentral.id = novoSaldo[0].id;
                        App.saldoCentral.valor = 0;
                        atualizarSaldoHeader();
                        showToast('Saldo central criado automaticamente', 'info');
                    }
                } else {
                    const central = saldos.find(s => s.is_central) || saldos[0];
                    App.saldoCentral.id = central.id;
                    App.saldoCentral.valor = central.valor;
                }
            } catch (error) {
                console.error('Erro ao verificar/criar saldo central:', error);
            }
        }

        async function registrarHistorico(tipo, descricao, detalhes) {
            if (!App.currentUser) return;
            try {
                const { data, error } = await App.supabase.from('historico_acoes').insert({
                    user_id: App.currentUser.id,
                    tipo,
                    descricao,
                    detalhes: JSON.stringify(detalhes),
                    data: new Date().toISOString(),
                    usuario: App.usuarioAtual || 'desconhecido'
                }).select();
                
                if (!error && data) {
                    App.historicoAcoes.unshift({
                        id: data[0].id,
                        tipo,
                        descricao,
                        detalhes,
                        data: new Date().toISOString(),
                        usuario: App.usuarioAtual || 'desconhecido'
                    });
                    if (App.historicoAcoes.length > 100) App.historicoAcoes.pop();
                }
            } catch (e) { }
        }

        async function carregarAssinatura() {
            if (!App.currentUser) return;
            
            try {
                const { data, error } = await App.supabase
                    .from('assinaturas')
                    .select('data_expiracao, status')
                    .eq('user_id', App.currentUser.id)
                    .maybeSingle();

                if (data && data.status === 'ativo') {
                    let dataExpiracao = new Date(data.data_expiracao);
                    let hoje = new Date();
                    
                    if (dataExpiracao >= hoje) {
                        App.assinaturaAtiva = true;
                        App.dataExpiracao = dataExpiracao;
                    } else {
                        App.assinaturaAtiva = false;
                        App.dataExpiracao = dataExpiracao;
                    }
                } else {
                    App.assinaturaAtiva = false;
                    App.dataExpiracao = null;
                }
                
                atualizarStatusAssinaturaMenu();
            } catch (error) {
                console.error('Erro ao carregar assinatura:', error);
                App.assinaturaAtiva = false;
            }
        }

        function atualizarStatusAssinaturaMenu() {
            let menuItem = document.getElementById('menuAssinaturaStatus');
            if (!menuItem) return;
            
            if (App.assinaturaAtiva && App.dataExpiracao) {
                let dias = Math.ceil((App.dataExpiracao - new Date()) / (1000 * 60 * 60 * 24));
                menuItem.innerHTML = `Premium <span class="assinatura-badge">${dias} dias</span>`;
            } else {
                menuItem.innerHTML = `Premium <span class="assinatura-badge assinatura-expirada">Expirada</span>`;
            }
        }

        function podeExecutarAcao() {
            return App.assinaturaAtiva;
        }

        function verificarEAcao(acao) {
            if (!App.usuarioAtual) {
                abrirSelecaoUsuario(true, acao);
                return;
            }
            
            if (!podeExecutarAcao()) {
                abrirModalAssinaturaBloqueio();
                return;
            }
            
            executarAcao(acao);
        }

        function verificarEAcaoEdicao(callback) {
            if (!App.assinaturaAtiva) {
                abrirModalAssinaturaBloqueio();
                return;
            }
            callback();
        }

        function executarAcao(acao) {
            fecharAddMenu();
            switch (acao) {
                case 'conta': abrirNovaConta(); break;
                case 'evento': abrirNovoEventoUnificado(); break;
                case 'gasto': abrirNovoGasto(); break;
                case 'lista': abrirNovoItemLista(); break;
                case 'giro': abrirNovoGiro(); break;
            }
        }

        function abrirModalAssinaturaBloqueio() {
            let diasRestantes = App.dataExpiracao ? 
                Math.ceil((App.dataExpiracao - new Date()) / (1000 * 60 * 60 * 24)) : 0;
            
            let conteudo = `
                <div style="padding:16px; text-align:center">
                    <i class="fas fa-lock" style="font-size:48px; color:var(--danger); margin-bottom:16px"></i>
                    <h3 style="color:var(--danger); margin-bottom:16px">Premium Expirado</h3>
                    
                    <p style="margin-bottom:16px">
                        Seu per√≠odo gr√°tis de 30 dias terminou${diasRestantes < 0 ? ` h√° ${Math.abs(diasRestantes)} dias` : ''}.
                    </p>
                    
                    <p style="margin-bottom:16px; background:var(--bg-warning-light); padding:12px; border-radius:8px;">
                        <i class="fas fa-eye"></i> Voc√™ ainda pode visualizar todos os seus dados normalmente.<br>
                        Para <strong>adicionar, editar ou excluir</strong>, assine o Premium.
                    </p>
                    
                    <div style="display:flex; gap:12px; margin:20px 0; flex-wrap:wrap; justify-content:center">
                        <div class="plano-card mensal" onclick="gerarLinkPagamento('mensal')" style="width:160px">
                            <i class="fas fa-crown" style="font-size:28px"></i>
                            <h4 style="margin:8px 0">Mensal</h4>
                            <div class="plano-preco">R$ 17,90</div>
                            <div class="plano-periodo">por m√™s</div>
                        </div>
                        
                        <div class="plano-card anual plano-destaque" onclick="gerarLinkPagamento('anual')" style="width:160px">
                            <i class="fas fa-star" style="font-size:28px"></i>
                            <h4 style="margin:8px 0">Anual</h4>
                            <div class="plano-preco">R$ 189,90</div>
                            <div class="plano-periodo">por ano</div>
                        </div>
                    </div>
                    
                    <div style="text-align:left; background:#f9f9f9; padding:12px; border-radius:8px; margin:16px 0">
                        <p><strong>‚úÖ Plano Gratuito (Visualiza√ß√£o):</strong><br>
                        - Ver todas as contas, eventos e gastos<br>
                        - Acessar relat√≥rios e extrato<br>
                        - Dados sempre dispon√≠veis</p>
                        
                        <p><strong>‚≠ê Premium (Edi√ß√£o):</strong><br>
                        - Adicionar, editar e excluir itens<br>
                        - Criar contas e eventos recorrentes<br>
                        - Controle total de saldos e giros<br>
                        - M√∫ltiplos usu√°rios na mesma conta<br>
                        - Suporte priorit√°rio<br>
                        - <strong>Cancele a qualquer momento, sem multas</strong></p>
                    </div>
                    
                    <p style="font-size:12px; color:var(--gray); margin:16px 0">
                        <i class="fas fa-clock"></i> Ap√≥s a confirma√ß√£o do pagamento, a libera√ß√£o √© imediata e autom√°tica.<br>
                        Voc√™ continua de onde parou, todos os seus dados permanecem.
                    </p>
                    
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Apenas Visualizar</button>
                    </div>
                </div>
            `;
            abrirModal('Premium Necess√°rio', 'fa-crown', conteudo);
        }

        function abrirModalAssinatura() {
            if (!App.assinaturaAtiva) {
                abrirModalAssinaturaBloqueio();
                return;
            }
            
            let dataExpiracao = App.dataExpiracao ? App.dataExpiracao.toLocaleDateString('pt-BR') : 'Desconhecida';
            let diasRestantes = App.dataExpiracao ? 
                Math.ceil((App.dataExpiracao - new Date()) / (1000 * 60 * 60 * 24)) : 0;
            
            let conteudo = `
                <div style="padding:16px; text-align:center">
                    <i class="fas fa-crown" style="font-size:48px; color:var(--warning); margin-bottom:16px"></i>
                    <h3>Premium Ativo</h3>
                    
                    <div style="background:var(--bg-success-light); color:var(--text-success); padding:16px; border-radius:8px; margin:16px 0">
                        <div style="font-size:1.2em">V√°lida at√© ${dataExpiracao}</div>
                        <div style="font-size:2em; font-weight:700">${diasRestantes} dias</div>
                        <div style="font-size:0.9em; margin-top:8px">restantes</div>
                    </div>
                    
                    <p style="margin-bottom:16px">
                        <i class="fas fa-check-circle" style="color:var(--success)"></i> Voc√™ tem acesso a todas as funcionalidades Premium.
                    </p>
                    
                    <div style="display:flex; gap:12px; margin:20px 0; flex-wrap:wrap; justify-content:center">
                        <div class="plano-card mensal" onclick="gerarLinkPagamento('mensal')" style="width:140px">
                            <h4>Renovar Mensal</h4>
                            <div class="plano-preco">R$ 17,90</div>
                        </div>
                        
                        <div class="plano-card anual" onclick="gerarLinkPagamento('anual')" style="width:140px">
                            <h4>Renovar Anual</h4>
                            <div class="plano-preco">R$ 189,90</div>
                        </div>
                    </div>
                    
                    <p style="font-size:12px; color:var(--gray)">
                        <i class="fas fa-clock"></i> Pagamento Mercado Pago do Grupo Mundo Carol.<br>
                        Cancele a qualquer momento sem taxas e multas, confira as pol√≠ticas no Menu/Politicas.<br>
                        Pague via Cart√£o, Boleto ou Mercado Pago
                    </p>
                    
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            `;
            abrirModal('Meu Premium', 'fa-crown', conteudo);
        }

        function abrirPoliticasTermos() {
            let conteudo = `
                <iframe src="https://mcembalagensbh.github.io/mylife/politicas.html" 
                        style="width:100%; height:60vh; border:none;"></iframe>
                <div style="text-align:center; margin-top:16px">
                    <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                </div>
            `;
            abrirModal('Pol√≠ticas e Termos', 'fa-file-contract', conteudo);
        }

        async function gerarLinkPagamento(plano) {
            if (App.processandoLinkPagamento) return;
            
            App.processandoLinkPagamento = true;
            
            try {
                showToast('Gerando link de pagamento...', 'info');
                
                const link = CONFIG.mercadopago.links[plano];
                
                if (!link) {
                    throw new Error('Link n√£o encontrado para o plano selecionado');
                }
                
                window.open(link, '_blank');
                
                showToast('Redirecionando para o Mercado Pago...', 'success');
                
                fecharModal();
                
                setTimeout(() => {
                    carregarAssinatura();
                }, 5000);
                
            } catch (error) {
                console.error('Erro ao gerar link:', error);
                showToast('Erro ao gerar link: ' + error.message, 'error');
            } finally {
                App.processandoLinkPagamento = false;
            }
        }

        async function criarTrialParaNovoUsuario(userId) {
            try {
                const { data } = await App.supabase
                    .from('assinaturas')
                    .select('id')
                    .eq('user_id', userId)
                    .maybeSingle();
                    
                if (data) return;
                
                let dataExpiracao = new Date();
                dataExpiracao.setDate(dataExpiracao.getDate() + 30);
                
                await App.supabase
                    .from('assinaturas')
                    .insert({
                        user_id: userId,
                        data_expiracao: dataExpiracao.toISOString(),
                        status: 'ativo'
                    });
                    
                console.log('Trial de 30 dias criado');
            } catch (error) {
                console.error('Erro ao criar trial:', error);
            }
        }

        async function limparDadosAntigos() {
            if (!App.currentUser) return;
            
            try {
                let dataLimite = new Date();
                dataLimite.setMonth(dataLimite.getMonth() - CONFIG.mesesParaLimpar);
                let dataLimiteStr = dataLimite.toISOString();
                
                console.log('Limpando dados anteriores a', dataLimite.toLocaleDateString('pt-BR'));
                
                await App.supabase
                    .from('gastos')
                    .delete()
                    .eq('user_id', App.currentUser.id)
                    .lt('data', dataLimiteStr);
                
                await App.supabase
                    .from('contas')
                    .delete()
                    .eq('user_id', App.currentUser.id)
                    .eq('status', 'paga')
                    .lt('data', dataLimiteStr);
                
                await App.supabase
                    .from('eventos')
                    .delete()
                    .eq('user_id', App.currentUser.id)
                    .eq('is_recorrente', false)
                    .lt('data_inicio', dataLimiteStr);
                
                await App.supabase
                    .from('historico_acoes')
                    .delete()
                    .eq('user_id', App.currentUser.id)
                    .lt('data', dataLimiteStr);
                
                console.log('Limpeza de dados antigos conclu√≠da');
                
            } catch (error) {
                console.error('Erro ao limpar dados antigos:', error);
            }
        }

        async function carregarDadosDoCache() {
            if (!App.currentUser) return false;
            
            const cacheKey = `mylife_cache_${App.currentUser.id}`;
            const timestampKey = `mylife_cache_timestamp_${App.currentUser.id}`;
            
            try {
                const cached = localStorage.getItem(cacheKey);
                const timestamp = localStorage.getItem(timestampKey);
                
                if (cached && timestamp) {
                    const cacheAge = Date.now() - parseInt(timestamp);
                    
                    if (cacheAge < 5 * 60 * 1000) {
                        App.dataCache = JSON.parse(cached);
                        atualizarListaBadge();
                        atualizarSaldoHeader();
                        App.cacheLoaded = true;
                        return true;
                    }
                }
            } catch (e) {
                console.warn('Erro ao carregar cache:', e);
            }
            
            return false;
        }

        function salvarCacheLocal() {
            if (!App.currentUser) return;
            
            const cacheKey = `mylife_cache_${App.currentUser.id}`;
            const timestampKey = `mylife_cache_timestamp_${App.currentUser.id}`;
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(App.dataCache));
                localStorage.setItem(timestampKey, Date.now().toString());
            } catch (e) {
                console.warn('Erro ao salvar cache:', e);
            }
        }

        async function inicializarNotificacoes() {
            if (!('Notification' in window)) {
                console.log('Notifica√ß√µes n√£o suportadas');
                return;
            }

            const isLocalFile = window.location.protocol === 'file:';
            
            if (isLocalFile) {
                console.log('Ambiente local detectado - Service Worker n√£o ser√° registrado');
                if (Notification.permission === 'default') {
                    await Notification.requestPermission();
                }
                return;
            }

            if (Notification.permission === 'granted') {
                console.log('Permiss√£o de notifica√ß√£o j√° concedida');
            } else if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                console.log('Permiss√£o de notifica√ß√£o:', permission);
            }

            if ('serviceWorker' in navigator && !isLocalFile) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js', { 
                        scope: './' 
                    }).catch(err => {
                        console.warn('Service Worker n√£o p√¥de ser registrado:', err);
                        return null;
                    });
                    
                    if (registration) {
                        App.serviceWorkerRegistration = registration;
                        console.log('Service Worker registrado');
                    }
                } catch (error) {
                    console.warn('Erro ao registrar Service Worker:', error);
                }
            }
        }

        async function agendarNotificacoes() {
            if (!App.currentUser) return;
            
            let config = App.notificacoesConfig;
            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            let notificacoes = [];
            
            if (config.contas) {
                let { mes, ano } = getMesAnoAtual();
                let contas = combinarContasDoMes(mes, ano);
                
                contas.forEach(conta => {
                    if (conta.valor_pago > 0 || conta.status === 'paga') return;
                    
                    let dataVenc = criarData(conta.ano, conta.mes, conta.dia);
                    let diasAntecedencia = config.antecedencia.contas || 0;
                    let dataNotificacao = new Date(dataVenc);
                    dataNotificacao.setDate(dataNotificacao.getDate() - diasAntecedencia);
                    
                    if (dataNotificacao <= hoje) return;
                    
                    notificacoes.push({
                        titulo: 'Conta a vencer',
                        corpo: `${conta.descricao} - ${formatCurrency(conta.valor_original || conta.valor)}`,
                        data: dataNotificacao,
                        tipo: 'conta'
                    });
                });
            }
            
            if (config.eventos) {
                let { mes, ano } = getMesAnoAtual();
                let eventos = combinarEventosDoMes(mes, ano);
                
                eventos.forEach(evento => {
                    let dataEvento = criarData(evento.ano, evento.mes, evento.dia);
                    let diasAntecedencia = config.antecedencia.eventos || 0;
                    let dataNotificacao = new Date(dataEvento);
                    dataNotificacao.setDate(dataNotificacao.getDate() - diasAntecedencia);
                    
                    if (dataNotificacao <= hoje) return;
                    
                    notificacoes.push({
                        titulo: 'Evento pr√≥ximo',
                        corpo: evento.titulo,
                        data: dataNotificacao,
                        tipo: 'evento'
                    });
                });
            }
            
            App.notificacoesAgendadas = notificacoes;
            
            if (App.serviceWorkerRegistration && 'showNotification' in App.serviceWorkerRegistration) {
                notificacoes.forEach(notif => {
                    let agora = new Date();
                    let diffMs = notif.data - agora;
                    
                    if (diffMs > 0 && diffMs <= 30 * 24 * 60 * 60 * 1000) {
                        setTimeout(() => {
                            App.serviceWorkerRegistration.showNotification(notif.titulo, {
                                body: notif.corpo,
                                icon: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/home.svg',
                                badge: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/bell.svg',
                                vibrate: [200, 100, 200],
                                data: { tipo: notif.tipo }
                            });
                        }, diffMs);
                    }
                });
            }
        }

        function calcularProximaData(data, frequencia, diaReferencia = null) {
            let novaData = new Date(data);
            
            switch (frequencia) {
                case 'semanal':
                    novaData.setDate(novaData.getDate() + 7);
                    break;
                case 'quinzenal':
                    novaData.setDate(novaData.getDate() + 14);
                    break;
                case 'mensal':
                    novaData.setMonth(novaData.getMonth() + 1);
                    if (diaReferencia) {
                        let ultimoDia = getDiasNoMes(novaData.getFullYear(), novaData.getMonth() + 1);
                        novaData.setDate(Math.min(diaReferencia, ultimoDia));
                    }
                    break;
                case 'semestral':
                    novaData.setMonth(novaData.getMonth() + 6);
                    if (diaReferencia) {
                        let ultimoDia = getDiasNoMes(novaData.getFullYear(), novaData.getMonth() + 1);
                        novaData.setDate(Math.min(diaReferencia, ultimoDia));
                    }
                    break;
                case 'anual':
                    novaData.setFullYear(novaData.getFullYear() + 1);
                    break;
                default:
                    return null;
            }
            
            return novaData;
        }

        function calcularOcorrenciasConta(regra, mesAlvo, anoAlvo) {
            let ocorrencias = [];
            if (!regra || !regra.data_inicio || !regra.ativo) return ocorrencias;
            
            let dataInicio = stringParaData(regra.data_inicio);
            let dataFim = regra.data_fim ? stringParaData(regra.data_fim) : null;
            
            let anoLimitePassado = new Date().getFullYear() - CONFIG.anosLimite.passado;
            let anoLimiteFuturo = new Date().getFullYear() + CONFIG.anosLimite.futuro;
            
            if (anoAlvo < anoLimitePassado || anoAlvo > anoLimiteFuturo) return ocorrencias;
            
            let dataAtual = new Date(dataInicio);
            
            while (dataAtual.getFullYear() < anoAlvo || (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 < mesAlvo)) {
                let proximaData = calcularProximaData(dataAtual, regra.frequencia, regra.dia_vencimento);
                if (!proximaData) break;
                dataAtual = proximaData;
            }
            
            let contador = 0;
            while (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 === mesAlvo && contador < 100) {
                if (!dataFim || dataAtual <= dataFim) {
                    let dataStr = dataParaString(dataAtual.getFullYear(), dataAtual.getMonth() + 1, dataAtual.getDate());
                    let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regra.id && e.data_excecao === dataStr);
                    
                    if (!excecao || excecao.acao !== 'excluir') {
                        ocorrencias.push({
                            id: `regra_${regra.id}_${dataAtual.getTime()}`,
                            regra_id: regra.id,
                            descricao: `${regra.descricao_base} (${regra.frequencia})`,
                            dia: dataAtual.getDate(),
                            mes: mesAlvo,
                            ano: anoAlvo,
                            valor_original: regra.valor || 0,
                            valor_pago: excecao?.acao === 'pagar' ? regra.valor : 0,
                            status: excecao?.acao === 'pagar' ? 'paga' : 'pendente',
                            frequencia: regra.frequencia,
                            isRecorrente: true,
                            data_original: dataAtual.toISOString(),
                            codigo_pagamento: regra.codigo_pagamento || null
                        });
                    }
                }
                
                let proximaData = calcularProximaData(dataAtual, regra.frequencia, regra.dia_vencimento);
                if (!proximaData) break;
                dataAtual = proximaData;
                contador++;
            }
            
            return ocorrencias;
        }

        function calcularOcorrenciasEvento(regra, mesAlvo, anoAlvo) {
            let ocorrencias = [];
            if (!regra || !regra.data_inicio || !regra.ativo) return ocorrencias;
            
            let dataInicio = stringParaData(regra.data_inicio);
            let dataFim = regra.data_fim ? stringParaData(regra.data_fim) : null;
            
            let anoLimitePassado = new Date().getFullYear() - CONFIG.anosLimite.passado;
            let anoLimiteFuturo = new Date().getFullYear() + CONFIG.anosLimite.futuro;
            
            if (anoAlvo < anoLimitePassado || anoAlvo > anoLimiteFuturo) return ocorrencias;
            
            let dataAtual = new Date(dataInicio);
            
            while (dataAtual.getFullYear() < anoAlvo || (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 < mesAlvo)) {
                let proximaData = calcularProximaData(dataAtual, regra.frequencia, regra.dia);
                if (!proximaData) break;
                dataAtual = proximaData;
            }
            
            let contador = 0;
            while (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 === mesAlvo && contador < 100) {
                if (!dataFim || dataAtual <= dataFim) {
                    let dataStr = dataParaString(dataAtual.getFullYear(), dataAtual.getMonth() + 1, dataAtual.getDate());
                    let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regra.id && e.data_excecao === dataStr);
                    
                    if (!excecao || excecao.acao !== 'excluir') {
                        let eventoIndividual = App.dataCache.eventosIndividuais?.find(e => e.regra_id === regra.id && e.data_original === dataStr);
                        
                        if (eventoIndividual) {
                            ocorrencias.push({
                                id: `evento_individual_${eventoIndividual.id}`,
                                regra_id: regra.id,
                                titulo: eventoIndividual.titulo || regra.titulo_base,
                                descricao: eventoIndividual.descricao || regra.descricao || '',
                                dia: dataAtual.getDate(),
                                mes: mesAlvo,
                                ano: anoAlvo,
                                hora: eventoIndividual.hora || regra.hora || '',
                                local: eventoIndividual.local || regra.local || '',
                                icone: eventoIndividual.icone || regra.icone || 'fa-star',
                                cor_icone: eventoIndividual.cor_icone || regra.cor_icone || '#ffd700',
                                frequencia: regra.frequencia,
                                isRecorrente: false,
                                isIndividual: true,
                                individual_id: eventoIndividual.id,
                                data_original: dataAtual.toISOString(),
                                data_inicio: regra.data_inicio,
                                data_fim: regra.data_fim
                            });
                        } else {
                            ocorrencias.push({
                                id: `regra_evento_${regra.id}_${dataAtual.getTime()}`,
                                regra_id: regra.id,
                                titulo: `${regra.titulo_base} (${regra.frequencia})`,
                                descricao: regra.descricao || '',
                                dia: dataAtual.getDate(),
                                mes: mesAlvo,
                                ano: anoAlvo,
                                hora: regra.hora || '',
                                local: regra.local || '',
                                icone: regra.icone || 'fa-star',
                                cor_icone: regra.cor_icone || '#ffd700',
                                frequencia: regra.frequencia,
                                isRecorrente: true,
                                data_original: dataAtual.toISOString(),
                                data_inicio: regra.data_inicio,
                                data_fim: regra.data_fim
                            });
                        }
                    }
                }
                
                let proximaData = calcularProximaData(dataAtual, regra.frequencia, regra.dia);
                if (!proximaData) break;
                dataAtual = proximaData;
                contador++;
            }
            
            return ocorrencias;
        }

        function combinarContasDoMes(mes, ano) {
            let contasFixas = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano);
            let contasRecorrentes = [];
            App.dataCache.regrasContas.forEach(r => contasRecorrentes.push(...calcularOcorrenciasConta(r, mes, ano)));
            let todas = [...contasFixas, ...contasRecorrentes];
            
            todas = todas.filter(c => {
                if (!c.id.toString().startsWith('regra_') && !c.regra_id) return true;
                let regraId = c.regra_id || (c.id.toString().startsWith('regra_') ? c.id.split('_')[1] : null);
                if (!regraId) return true;
                let dataExcecao = dataParaString(ano, mes, c.dia);
                let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regraId && e.data_excecao === dataExcecao);
                if (excecao && excecao.acao === 'pagar') {
                    c.valor_pago = c.valor_original || c.valor;
                    c.status = 'paga';
                }
                return true;
            });
            
            return todas;
        }

        function combinarEventosDoMes(mes, ano) {
            let eventosFixos = App.dataCache.eventos.filter(e => e.mes === mes && e.ano === ano);
            let eventosInd = App.dataCache.eventosIndividuais.filter(e => e.mes === mes && e.ano === ano);
            let eventosRec = [];
            App.dataCache.regrasEventos.forEach(r => eventosRec.push(...calcularOcorrenciasEvento(r, mes, ano)));
            let todos = [...eventosFixos, ...eventosInd, ...eventosRec];
            
            let idsUnicos = new Set();
            let resultados = [];
            
            todos.forEach(e => {
                let chave = `${e.titulo}_${e.dia}_${e.mes}_${e.ano}`;
                if (!idsUnicos.has(chave)) {
                    idsUnicos.add(chave);
                    resultados.push(e);
                }
            });
            
            return resultados;
        }

        async function carregarDados(forceRefresh) {
            if (!App.currentUser) return;
            
            if (!forceRefresh && App.cacheLoaded) {
                atualizarListaBadge();
                atualizarSaldoHeader();
                return;
            }
            
            document.getElementById('loadingState').style.display = 'block';
            
            await carregarAssinatura();
            await limparDadosAntigos();

            try {
                const promises = [
                    App.supabase.from('contas').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('regras_contas').select('*').eq('user_id', App.currentUser.id).eq('ativo', true),
                    App.supabase.from('eventos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('eventos_individuais').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('regras_eventos').select('*').eq('user_id', App.currentUser.id).eq('ativo', true),
                    App.supabase.from('gastos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('lista_compras').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('saldos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('historico_pagamentos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('historico_acoes').select('*').eq('user_id', App.currentUser.id).order('data', { ascending: false }).limit(500),
                    App.supabase.from('giros').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('movimentacoes_giro').select('*').eq('user_id', App.currentUser.id).order('data', { ascending: false })
                ];

                const results = await Promise.allSettled(promises);

                const contas = results[0].status === 'fulfilled' ? results[0].value.data : [];
                const regrasContas = results[1].status === 'fulfilled' ? results[1].value.data : [];
                const eventos = results[2].status === 'fulfilled' ? results[2].value.data : [];
                const eventosIndividuais = results[3].status === 'fulfilled' ? results[3].value.data : [];
                const regrasEventos = results[4].status === 'fulfilled' ? results[4].value.data : [];
                const gastos = results[5].status === 'fulfilled' ? results[5].value.data : [];
                const lista = results[6].status === 'fulfilled' ? results[6].value.data : [];
                const saldos = results[7].status === 'fulfilled' ? results[7].value.data : [];
                const historico = results[8].status === 'fulfilled' ? results[8].value.data : [];
                const historicoAcoes = results[9].status === 'fulfilled' ? results[9].value.data : [];
                const giros = results[10].status === 'fulfilled' ? results[10].value.data : [];
                const movimentacoes = results[11].status === 'fulfilled' ? results[11].value.data : [];

                let excecoesRecorrencia = [];
                try {
                    const { data: ex } = await App.supabase.from('excecoes_recorrencia').select('*').eq('user_id', App.currentUser.id);
                    if (ex) excecoesRecorrencia = ex;
                } catch (e) { }

                let configuracoes = [];
                try {
                    const { data: configs } = await App.supabase.from('configuracoes').select('*').eq('user_id', App.currentUser.id);
                    if (configs) configuracoes = configs;
                } catch (e) { }

                if (configuracoes) configuracoes.forEach(c => {
                    if (c.chave === 'saldo_senha') App.saldoSenha = c.valor;
                });

                if (historicoAcoes) {
                    App.historicoAcoes = historicoAcoes.map(h => ({ ...h, detalhes: JSON.parse(h.detalhes || '{}') }));
                }

                if (saldos && saldos.length > 0) {
                    let central = saldos.find(s => s.is_central) || saldos[0];
                    App.saldoCentral.id = central.id;
                    App.saldoCentral.valor = central.valor;
                } else {
                    await verificarECriarSaldoCentral();
                }

                App.dataCache = {
                    contas: contas || [], regrasContas: regrasContas || [], eventos: eventos || [],
                    eventosIndividuais: eventosIndividuais || [], regrasEventos: regrasEventos || [],
                    gastos: gastos || [], lista: lista || [], saldos: saldos || [], historico: historico || [],
                    excecoesRecorrencia: excecoesRecorrencia, giros: giros || [], movimentacoesGiro: movimentacoes || []
                };

                salvarCacheLocal();
                atualizarListaBadge();
                atualizarSaldoHeader();
                
                agendarNotificacoes();
                
                document.getElementById('loadingState').style.display = 'none';
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados', 'error');
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function atualizarListaBadge() {
            let totalLista = App.dataCache.lista.filter(i => !i.comprado).length;
            let badge = document.getElementById('listaBadge');
            badge.textContent = totalLista;
            badge.style.display = totalLista > 0 ? 'flex' : 'none';
        }

        async function atualizarCalendario() {
            let { mes, ano } = getMesAnoAtual();
            App.selectedMonth = mes;
            App.selectedYear = ano;
            document.getElementById('calendarTitle').textContent = `${getNomeMes(mes)} ${ano}`;

            let grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            CONFIG.diasSemana.forEach(dia => {
                let h = document.createElement('div');
                h.className = 'calendar-day-header';
                h.textContent = dia;
                grid.appendChild(h);
            });

            let primeiroDia = new Date(ano, mes - 1, 1).getDay();
            let diasNoMes = getDiasNoMes(ano, mes);

            for (let i = 0; i < primeiroDia; i++) {
                let e = document.createElement('div');
                e.className = 'calendar-day empty';
                grid.appendChild(e);
            }

            let todasContas = combinarContasDoMes(mes, ano);
            let todosEventos = combinarEventosDoMes(mes, ano);

            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            for (let dia = 1; dia <= diasNoMes; dia++) {
                let isToday = dia === hoje.getDate() && mes === hoje.getMonth() + 1 && ano === hoje.getFullYear() && App.currentMonthOffset === 0;

                let contasHoje = todasContas.filter(c => c.dia === dia);
                let eventosHoje = todosEventos.filter(e => e.dia === dia);

                let contasPendentes = contasHoje.filter(c => c.valor_pago === 0 && c.status !== 'paga');
                let contasVencidas = contasPendentes.filter(c => {
                    let d = criarData(ano, mes, c.dia);
                    return d < hoje;
                });
                let contasNormais = contasPendentes.filter(c => {
                    let d = criarData(ano, mes, c.dia);
                    return d >= hoje;
                });

                let cell = document.createElement('div');
                cell.className = `calendar-day ${isToday ? 'today' : ''} ${App.selectedDay === dia ? 'selected' : ''}`;
                cell.onclick = (e) => {
                    e.stopPropagation();
                    selecionarDia(dia);
                };

                let contasBadgesHtml = '<div class="contas-badges-line">';
                if (contasVencidas.length > 0) contasBadgesHtml += `<span class="day-badge badge-conta-vencida" title="${contasVencidas.length} conta(s) vencida(s)">${contasVencidas.length}</span>`;
                if (contasNormais.length > 0) contasBadgesHtml += `<span class="day-badge badge-conta" title="${contasNormais.length} conta(s) a pagar">${contasNormais.length}</span>`;
                contasBadgesHtml += '</div>';

                let eventosEmojisHtml = '<div class="eventos-emojis-line">';
                eventosHoje.forEach(e => {
                    let icone = e.icone || 'fa-star';
                    let cor = e.cor_icone || '#ffd700';
                    eventosEmojisHtml += `<span class="event-emoji-calendar" title="${e.titulo}"><i class="fas ${icone}" style="color:${cor}"></i></span>`;
                });
                eventosEmojisHtml += '</div>';

                cell.innerHTML = `<div class="day-number">${dia}</div>${contasBadgesHtml}${eventosEmojisHtml}`;
                grid.appendChild(cell);
            }
        }

        function selecionarDia(dia) {
            App.selectedDay = App.selectedDay === dia ? null : dia;
            App.currentFilter = 'all';
            atualizarCalendario();
            mostrarConteudo();
        }

        async function mostrarConteudo() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('contentArea').style.display = 'none';
            await carregarDados(false);

            let { mes, ano } = getMesAnoAtual();
            let content = document.getElementById('dynamicContent');
            let diaText = App.selectedDay ? ` - Dia ${App.selectedDay}` : '';

            document.getElementById('filterInfo').innerHTML = `<i class="fas fa-calendar-alt"></i> ${getNomeMes(mes)}/${ano}${diaText} | <strong>${Object.entries(App.activeFilters).filter(([k, v]) => v).map(([k]) => k).join(', ') || 'Nenhum'}</strong>`;

            try {
                if (App.currentFilter === 'saldos') await renderizarSaldos(content);
                else if (App.currentFilter === 'lista') await renderizarLista(content);
                else if (App.currentFilter === 'gastos') await renderizarGastos(content, mes, ano);
                else if (App.currentFilter === 'giros') await renderizarGiros(content);
                else await renderizarTudo(content, mes, ano);
            } catch (error) {
                console.error(error);
                content.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><p>Erro ao carregar dados</p></div>';
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
        }

        async function renderizarTudo(content, mes, ano) {
            let todasContas = combinarContasDoMes(mes, ano);
            let todosEventos = combinarEventosDoMes(mes, ano);

            let contasF = App.selectedDay ? todasContas.filter(c => c.dia === App.selectedDay) : todasContas;
            let eventosF = App.selectedDay ? todosEventos.filter(e => e.dia === App.selectedDay) : todosEventos;

            let itens = [];
            if (App.activeFilters.contas) itens.push(...contasF.map(c => ({ ...c, tipo: 'conta' })));
            if (App.activeFilters.eventos) itens.push(...eventosF.map(e => ({ ...e, tipo: 'evento' })));

            itens.sort((a, b) => a.dia - b.dia);

            if (itens.length === 0) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhum item encontrado</p></div>';
                return;
            }

            let html = '<div class="items-list">';
            itens.forEach(i => html += renderizarItemCard(i, mes, ano));
            html += '</div>';
            content.innerHTML = html;
        }

        function renderizarItemCard(item, mes, ano) {
            if (!item) return '';
            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            let classe = '';
            let titulo = '';
            let detalhes = '';
            let valor = '';
            let icone = 'fa-file-invoice-dollar';
            let botoes = '';
            let usuario = item.added_by || item.usuario || App.usuarioAtual || 'desconhecido';
            let usuarioBadge = `<span class="usuario-badge">${usuario}</span>`;
            let podeEditar = App.assinaturaAtiva;

            if (item.tipo === 'conta') {
                let venc = criarData(item.ano || ano, item.mes || mes, item.dia || item.dia_vencimento);
                if (item.valor_pago > 0 || item.status === 'paga') {
                    classe = 'paga';
                } else if (venc < hoje) {
                    classe = 'vencida';
                } else {
                    classe = 'pendente';
                }

                titulo = item.descricao || 'Conta sem descri√ß√£o';
                if (item.frequencia && item.frequencia !== 'unico') titulo += ` <span class="item-badge badge-recorrente">${item.frequencia}</span>`;
                detalhes = `Vence ${item.dia || item.dia_vencimento} ${getNomeMes(item.mes || mes)}/${item.ano || ano}`;
                
                let valorExibicao = item.valor_pago > 0 ? item.valor_pago : (item.valor_original || item.valor || 0);
                valor = formatCurrency(valorExibicao);
                
                if (podeEditar) {
                    if (item.valor_pago > 0 || item.status === 'paga') {
                        botoes += `<button class="action-btn undo" onclick="event.stopPropagation();verificarEAcaoEdicao(() => abrirModalDesfazerPagamento('${item.id}','${item.descricao}',${valorExibicao},'${item.regra_id || ''}',${item.dia || item.dia_vencimento},${item.mes || mes},${item.ano || ano},${item.isRecorrente || false}))"><i class="fas fa-undo-alt"></i></button>`;
                    } else {
                        botoes += `<button class="action-btn pay" onclick="event.stopPropagation();verificarEAcaoEdicao(() => abrirModalPagamento('${item.id}','${item.descricao}',${item.valor_original || item.valor || 0},'${item.regra_id || ''}',${item.dia || item.dia_vencimento},${item.mes || mes},${item.ano || ano},${item.isRecorrente || false}, '${item.codigo_pagamento || ''}'))"><i class="fas fa-dollar-sign"></i></button>`;
                    }
                    
                    botoes += `<button class="action-btn edit" onclick="event.stopPropagation();verificarEAcaoEdicao(() => editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}',${item.dia || item.dia_vencimento},${item.mes || mes},${item.ano || ano}))"><i class="fas fa-edit"></i></button>`;
                    
                    botoes += `<button class="action-btn delete" onclick="event.stopPropagation();verificarEAcaoEdicao(() => confirmarExclusao('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.dia || 0},${item.mes || mes},${item.ano || ano},${item.isIndividual || false},'${item.individual_id || ''}'))"><i class="fas fa-trash"></i></button>`;
                }

                return `<div class="item-card ${classe}" ${podeEditar ? '' : 'style="cursor:default"'}>
                    <div class="item-info">
                        <div class="item-title"><i class="fas ${icone}"></i> ${titulo} ${usuarioBadge}</div>
                        <div class="item-details">${detalhes}</div>
                    </div>
                    <div class="item-value">${valor}</div>
                    <div class="item-actions">
                        ${botoes}
                    </div>
                </div>`;
            } else if (item.tipo === 'evento') {
                let dataEv = criarData(item.ano, item.mes, item.dia);
                classe = dataEv < hoje ? 'paga' : 'pendente';
                let iconeEvento = item.icone || 'fa-star';
                let corIcone = item.cor_icone || '#ffd700';
                titulo = item.titulo || 'Evento sem t√≠tulo';
                if (item.frequencia && item.frequencia !== 'unico') {
                    titulo += ` <span class="item-badge badge-recorrente">${item.frequencia}</span>`;
                }
                detalhes = `${item.dia} ${getNomeMes(item.mes)}/${item.ano}`;
                if (item.hora) detalhes += ` | ${item.hora}`;
                if (item.local) detalhes += ` | ${item.local}`;

                if (podeEditar) {
                    botoes = `
                        <button class="action-btn edit" onclick="event.stopPropagation();verificarEAcaoEdicao(() => editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}',${item.dia},${item.mes},${item.ano}))"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="event.stopPropagation();verificarEAcaoEdicao(() => confirmarExclusao('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.dia || 0},${item.mes || mes},${item.ano || ano},${item.isIndividual || false},'${item.individual_id || ''}'))"><i class="fas fa-trash"></i></button>
                    `;
                }

                return `<div class="item-card ${classe}" ${podeEditar ? '' : 'style="cursor:default"'}>
                    <div class="item-info">
                        <div class="item-title"><span class="event-emoji"><i class="fas ${iconeEvento}" style="color:${corIcone}"></i></span> ${titulo} ${usuarioBadge}</div>
                        <div class="item-details">${detalhes}</div>
                    </div>
                    <div class="item-actions">
                        ${botoes}
                    </div>
                </div>`;
            }
        }

        async function renderizarGastos(content, mes, ano) {
            let gastosMes = App.dataCache.gastos.filter(g => g.mes === mes && g.ano === ano);
            let podeEditar = App.assinaturaAtiva;
            
            if (gastosMes.length === 0) {
                content.innerHTML = `<div class="empty-state"><i class="fas fa-shopping-bag"></i><p>Nenhum gasto neste m√™s</p>${podeEditar ? '<button class="btn btn-primary" onclick="verificarEAcao(\'gasto\')" style="margin-top:16px"><i class="fas fa-plus"></i> Novo Gasto</button>' : ''}</div>`;
                return;
            }

            let html = '<div class="items-list">';
            gastosMes.sort((a, b) => a.dia - b.dia).forEach(g => {
                let cat = CONFIG.categoriasGastos.find(c => c.id === g.categoria) || CONFIG.categoriasGastos[6];
                let catNome = cat.nome;
                if (g.categoria_customizada && g.categoria === 'outros') catNome = g.categoria_customizada;

                html += `<div class="item-card gasto" ${podeEditar ? '' : 'style="cursor:default"'}>
                    <div class="item-info">
                        <div class="item-title"><i class="fas fa-shopping-bag"></i> ${g.descricao} <span class="item-badge">${catNome}</span> <span class="usuario-badge">${g.added_by || 'desconhecido'}</span></div>
                        <div class="item-details">${g.dia} ${getNomeMes(g.mes)}/${g.ano}</div>
                    </div>
                    <div class="item-value">${formatCurrency(g.valor)}</div>
                    <div class="item-actions">
                        ${podeEditar ? `
                            <button class="action-btn delete" onclick="event.stopPropagation();verificarEAcaoEdicao(() => confirmarExclusaoGasto('${g.id}','${g.descricao}',${g.valor}))"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </div>
                </div>`;
            });
            if (podeEditar) {
                html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="verificarEAcao('gasto')"><i class="fas fa-plus"></i> Novo Gasto</button></div>`;
            }
            html += '</div>';
            content.innerHTML = html;
        }

        async function renderizarLista(content) {
            let lista = App.dataCache.lista || [];
            let podeEditar = App.assinaturaAtiva;
            
            if (lista.length === 0) {
                content.innerHTML = `<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Lista de compras vazia</p>${podeEditar ? '<button class="btn btn-primary" onclick="verificarEAcao(\'lista\')" style="margin-top:16px"><i class="fas fa-plus"></i> Adicionar Item</button>' : ''}</div>`;
                return;
            }

            let pendentes = lista.filter(i => !i.comprado);
            let comprados = lista.filter(i => i.comprado);
            let html = '<div class="items-list">';

            if (pendentes.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-clock"></i> Pendentes</div>';
                pendentes.forEach(i => {
                    html += `<div class="item-card pendente" ${podeEditar ? '' : 'style="cursor:default"'}>
                        <div class="item-info">
                            <div class="item-title"><span class="item-badge">${i.quantidade}x</span>${i.descricao || 'Item sem descri√ß√£o'} <span class="usuario-badge">${i.added_by || 'desconhecido'}</span></div>
                        </div>
                        <div class="item-actions">
                            ${podeEditar ? `
                                <button class="action-btn ${i.comprado ? 'undo' : 'pay'}" onclick="event.stopPropagation();verificarEAcaoEdicao(() => alternarComprado('${i.id}'))"><i class="fas ${i.comprado ? 'fa-undo' : 'fa-check'}"></i></button>
                                <button class="action-btn delete" onclick="event.stopPropagation();verificarEAcaoEdicao(() => deletarItemLista('${i.id}'))"><i class="fas fa-trash"></i></button>
                            ` : ''}
                        </div>
                    </div>`;
                });
            }

            if (comprados.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-check-double"></i> Comprados</div>';
                comprados.forEach(i => {
                    html += `<div class="item-card paga" ${podeEditar ? '' : 'style="cursor:default"'}>
                        <div class="item-info">
                            <div class="item-title"><span class="item-badge">${i.quantidade}x</span>${i.descricao || 'Item sem descri√ß√£o'} <span class="usuario-badge">${i.added_by || 'desconhecido'}</span></div>
                        </div>
                        <div class="item-actions">
                            ${podeEditar ? `
                                <button class="action-btn undo" onclick="event.stopPropagation();verificarEAcaoEdicao(() => alternarComprado('${i.id}'))"><i class="fas fa-undo"></i></button>
                                <button class="action-btn delete" onclick="event.stopPropagation();verificarEAcaoEdicao(() => deletarItemLista('${i.id}'))"><i class="fas fa-trash"></i></button>
                            ` : ''}
                        </div>
                    </div>`;
                });
            }

            html += '</div>';
            content.innerHTML = html;
        }

        async function renderizarSaldos(content) {
            let saldos = App.dataCache.saldos || [];
            let podeEditar = App.assinaturaAtiva;
            let html = '<div class="items-list">';
            let central = saldos.find(s => s.is_central);

            if (central) {
                let dataAtualizacao = new Date(central.data || new Date());
                dataAtualizacao.setDate(dataAtualizacao.getDate() + 1);
                
                html += `<div style="padding:16px;background:linear-gradient(135deg,var(--purple),var(--purple-dark));color:#fff;border-radius:8px;margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-size:.9em;opacity:.9">Saldo Central</div>
                    </div>
                    <div style="font-size:1.8em;font-weight:700">${formatCurrency(central.valor)}</div>
                    <div style="font-size:.8em;margin-top:4px">Atualizado: ${dataAtualizacao.toLocaleDateString('pt-BR')}</div>
                    <div style="font-size:.7em;margin-top:2px;opacity:0.8">* Dados dos √∫ltimos 60 dias s√£o mantidos no extrato</div>
                    ${podeEditar ? `
                    <div class="btn-group" style="margin-top:12px">
                        <button class="btn btn-sm btn-success" onclick="abrirAdicionarValorSaldo('${central.id}')"><i class="fas fa-plus"></i> Adicionar</button>
                        <button class="btn btn-sm btn-warning" onclick="abrirRetirarValorSaldo('${central.id}')"><i class="fas fa-minus"></i> Retirar</button>
                        <button class="btn btn-sm btn-primary" onclick="abrirBalancoSaldo('${central.id}')"><i class="fas fa-balance-scale"></i> Balan√ßo</button>
                    </div>
                    ` : ''}
                </div>`;
            }

            let outros = saldos.filter(s => !s.is_central);
            if (outros.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-piggy-bank"></i> Outros Saldos</div>';
                outros.forEach(s => {
                    html += `<div class="item-card">
                        <div class="item-info">
                            <div class="item-title"><i class="fas fa-wallet"></i> ${s.nome || 'Sem nome'} <span class="usuario-badge">${s.added_by || 'desconhecido'}</span></div>
                        </div>
                        <div class="item-value">${formatCurrency(s.valor)}</div>
                        ${podeEditar ? `
                        <div class="item-actions">
                            <button class="action-btn update" onclick="event.stopPropagation();abrirAtualizarValorSaldo('${s.id}')"><i class="fas fa-sync-alt"></i></button>
                            <button class="action-btn edit" onclick="event.stopPropagation();editarSaldo('${s.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn extract" onclick="event.stopPropagation();abrirExtratoSaldo('${s.id}')"><i class="fas fa-history"></i></button>
                            <button class="action-btn delete" onclick="event.stopPropagation();deletarSaldo('${s.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                        ` : ''}
                    </div>`;
                });
            }

            if (podeEditar) {
                html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="abrirNovoSaldo()"><i class="fas fa-plus"></i> Novo Saldo</button></div>`;
            }
            html += '</div>';
            content.innerHTML = html;
        }

        function toggleExibirSaldoHeader() {
            App.exibirSaldoHeader = !App.exibirSaldoHeader;
            atualizarSaldoHeader();
            mostrarConteudo();
        }

        async function renderizarGiros(content) {
            let giros = App.dataCache.giros || [];
            let podeEditar = App.assinaturaAtiva;
            
            if (giros.length === 0) {
                content.innerHTML = `<div class="empty-state"><i class="fas fa-hand-holding-usd"></i><p>Nenhum giro cadastrado</p>${podeEditar ? '<button class="btn btn-primary" onclick="verificarEAcao(\'giro\')" style="margin-top:16px"><i class="fas fa-plus"></i> Novo Giro</button>' : ''}</div>`;
                return;
            }

            let html = '<div class="items-list">';
            giros.forEach(g => {
                let movimentacoes = App.dataCache.movimentacoesGiro?.filter(m => m.giro_id === g.id) || [];
                let totalPago = movimentacoes.reduce((acc, m) => acc + (m.tipo === 'pagamento' ? m.valor : 0), 0);
                let totalRecebido = movimentacoes.reduce((acc, m) => acc + (m.tipo === 'recebimento' ? m.valor : 0), 0);
                let saldoAtual = g.valor_inicial + totalRecebido - totalPago;

                html += `<div class="giro-card">
                    <div class="giro-header">
                        <div class="giro-titulo"><i class="fas fa-hand-holding-usd"></i> ${g.descricao} <span class="usuario-badge">${g.added_by || 'desconhecido'}</span></div>
                        <div class="giro-saldo">${formatCurrency(saldoAtual)}</div>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                        <span class="item-badge">Inicial: ${formatCurrency(g.valor_inicial)}</span>
                        <span class="item-badge">Pago: ${formatCurrency(totalPago)}</span>
                        <span class="item-badge">Recebido: ${formatCurrency(totalRecebido)}</span>
                        <span class="item-badge">Pessoa: ${g.pessoa || 'N√£o informado'}</span>
                    </div>
                    ${podeEditar ? `
                    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                        <button class="btn btn-sm btn-success" onclick="abrirPagamentoGiro('${g.id}','${g.descricao}')"><i class="fas fa-arrow-down"></i> Pagar</button>
                        <button class="btn btn-sm btn-warning" onclick="abrirRecebimentoGiro('${g.id}','${g.descricao}')"><i class="fas fa-arrow-up"></i> Receber</button>
                        <button class="btn btn-sm btn-primary" onclick="editarGiro('${g.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deletarGiro('${g.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                    ` : ''}`;

                if (movimentacoes.length > 0) {
                    html += '<div class="giro-historico">';
                    movimentacoes.slice(0, 10).forEach(m => {
                        let data = new Date(m.data).toLocaleDateString('pt-BR');
                        let tipoIcon = m.tipo === 'pagamento' ? 'fa-arrow-down' : 'fa-arrow-up';
                        html += `<div class="giro-linha">
                            <span><i class="fas ${tipoIcon}" style="color:${m.tipo === 'pagamento' ? 'var(--danger)' : 'var(--success)'}"></i> ${data} - ${m.descricao || ''}</span>
                            <span>${formatCurrency(m.valor)}</span>
                        </div>`;
                    });
                    html += '</div>';
                }

                html += '</div>';
            });

            if (podeEditar) {
                html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="verificarEAcao('giro')"><i class="fas fa-plus"></i> Novo Giro</button></div>`;
            }
            html += '</div>';
            content.innerHTML = html;
        }

        function carregarUsuarioLocal() {
            if (!App.currentUser) return;
            const key = `mylife_usuario_${App.currentUser.id}`;
            const nome = localStorage.getItem(key);
            if (nome) {
                App.usuarioAtual = nome;
                document.getElementById('usuarioHeaderNome').textContent = nome;
            }
        }

        function salvarUsuarioLocal(nome) {
            if (!App.currentUser) return;
            const key = `mylife_usuario_${App.currentUser.id}`;
            localStorage.setItem(key, nome);
            App.usuarioAtual = nome;
            document.getElementById('usuarioHeaderNome').textContent = nome;
        }

        function verificarUsuario() {
            abrirSelecaoUsuario();
        }

        function abrirSelecaoUsuario(aposAcao = false, acao = null) {
            let nomeAtual = App.usuarioAtual || '';

            let conteudo = `
                <div class="form-group">
                    <label class="form-label">Seu Nome</label>
                    <input type="text" id="novoUsuarioNome" class="form-input" value="${nomeAtual}" placeholder="Digite seu nome" autocomplete="off">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarUsuarioSelecao(${aposAcao}, '${acao}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Seu Nome', 'fa-user', conteudo);
        }

        function salvarUsuarioSelecao(aposAcao = false, acao = null) {
            let nome = document.getElementById('novoUsuarioNome')?.value.trim();
            if (!nome) {
                showToast('Digite um nome', 'warning');
                return;
            }
            
            salvarUsuarioLocal(nome);
            fecharModal();
            showToast(`Usu√°rio ${nome} selecionado`, 'success');
            
            if (aposAcao && acao) {
                setTimeout(() => verificarEAcao(acao), 300);
            }
        }

        function abrirNovaConta() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let frequenciasHtml = CONFIG.frequenciasConta.map(f => 
                `<option value="${f}">${f.charAt(0).toUpperCase() + f.slice(1)}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="contaDescricao" class="form-input" placeholder="Ex: Energia, √Ågua..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="contaValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequ√™ncia</label>
                    <select id="contaFrequencia" class="form-select" onchange="if(this.value==='unico') { document.getElementById('contaCodigoDiv').style.display='block'; document.getElementById('contaPixInfo').style.display='none'; } else { document.getElementById('contaCodigoDiv').style.display='block'; document.getElementById('contaPixInfo').style.display='block'; }">
                        ${frequenciasHtml}
                    </select>
                </div>
                <div id="contaCodigoDiv" class="form-group">
                    <label class="form-label"><i class="fas fa-barcode"></i> C√≥digo de Barras / Chave PIX</label>
                    <input type="text" id="contaCodigo" class="form-input" placeholder="Digite ou cole o c√≥digo" autocomplete="off">
                </div>
                <div id="contaPixInfo" style="display:none; background:var(--bg-warning-light); padding:10px; border-radius:6px; margin-bottom:16px; font-size:12px">
                    <i class="fas fa-info-circle"></i> Para contas recorrentes, recomendamos usar apenas Chave PIX, pois c√≥digos de barras podem mudar a cada vencimento.
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Dia do Vencimento</label>
                    <input type="number" id="contaDia" class="form-input" min="1" max="31" value="${diaPadrao}" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> M√™s/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="contaMes" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="contaAno" class="form-input" value="${ano}" inputmode="numeric">
                    </div>
                </div>
                <div id="contaDataFim" style="display:none" class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data Final (opcional)</label>
                    <input type="date" id="contaDataFimInput" class="form-input">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovaConta()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Nova Conta', 'fa-file-invoice-dollar', conteudo);
        }

        async function salvarNovaConta() {
            let descricao = document.getElementById('contaDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('contaValor')?.value);
            let codigo = document.getElementById('contaCodigo')?.value.trim() || null;
            let dia = parseInt(document.getElementById('contaDia')?.value);
            let mes = parseInt(document.getElementById('contaMes')?.value);
            let ano = parseInt(document.getElementById('contaAno')?.value);
            let frequencia = document.getElementById('contaFrequencia')?.value;
            let dataFim = document.getElementById('contaDataFimInput')?.value || null;

            if (!descricao || !valor || !dia || !mes || !ano) {
                showToast('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            if (!dataValida(ano, mes, dia)) {
                showToast('Dia inv√°lido para o m√™s selecionado', 'warning');
                return;
            }

            let diaAjustado = dia;
            let dataInicio = dataParaString(ano, mes, diaAjustado);

            try {
                if (frequencia === 'unico') {
                    let { data, error } = await App.supabase.from('contas').insert({
                        user_id: App.currentUser.id,
                        descricao: descricao,
                        valor: valor,
                        valor_pago: 0,
                        dia: diaAjustado,
                        mes: mes,
                        ano: ano,
                        data: dataInicio,
                        status: 'pendente',
                        added_by: App.usuarioAtual || 'desconhecido',
                        codigo_pagamento: codigo
                    }).select();

                    if (error) throw error;
                    
                    showToast('Conta salva com sucesso!', 'success');
                } else {
                    let regraData = {
                        user_id: App.currentUser.id,
                        descricao_base: descricao,
                        valor: valor,
                        dia_vencimento: diaAjustado,
                        frequencia: frequencia,
                        data_inicio: dataInicio,
                        ativo: true,
                        added_by: App.usuarioAtual || 'desconhecido',
                        codigo_pagamento: codigo
                    };
                    
                    if (dataFim) regraData.data_fim = dataFim;
                    
                    let { data, error } = await App.supabase.from('regras_contas').insert(regraData).select();
                    
                    if (error) throw error;
                    
                    showToast('Regra de conta salva com sucesso!', 'success');
                }

                verificarNotificacoes({ descricao, valor }, 'contas');
                await registrarHistorico('criacao_conta', `Conta criada: ${descricao}`, { descricao, valor, frequencia, usuario: App.usuarioAtual });
                
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                showToast('Erro ao salvar: ' + error.message, 'error');
            }
        }

        function editarConta(id, isRecorrente, regraId, dia, mes, ano) {
            if (!App.dataCache || (!App.dataCache.contas && !App.dataCache.regrasContas)) {
                showToast('Dados n√£o carregados. Tente novamente.', 'warning');
                return;
            }
            
            let conta = null;
            
            if (isRecorrente && regraId) {
                conta = App.dataCache.regrasContas?.find(r => r.id == regraId);
            }
            
            if (!conta) {
                conta = App.dataCache.contas?.find(c => c.id == id);
            }
            
            if (!conta && id && id.toString().startsWith('regra_')) {
                const parts = id.split('_');
                if (parts.length >= 2) {
                    const regraIdFromId = parts[1];
                    conta = App.dataCache.regrasContas?.find(r => r.id == regraIdFromId);
                }
            }
            
            if (!conta) {
                showToast('Conta n√£o encontrada', 'warning');
                return;
            }

            let frequenciasHtml = CONFIG.frequenciasConta.map(f => 
                `<option value="${f}" ${(isRecorrente ? conta.frequencia : 'unico') === f ? 'selected' : ''}>${f.charAt(0).toUpperCase() + f.slice(1)}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="contaDescricaoEdit" class="form-input" value="${isRecorrente ? conta.descricao_base : conta.descricao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="contaValorEdit" class="form-input" value="${(isRecorrente ? conta.valor : conta.valor_original || conta.valor).toFixed(2).replace('.', ',')}" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequ√™ncia</label>
                    <select id="contaFrequenciaEdit" class="form-select" ${!isRecorrente ? 'disabled' : ''}>
                        ${frequenciasHtml}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-barcode"></i> C√≥digo de Barras / Chave PIX</label>
                    <input type="text" id="contaCodigoEdit" class="form-input" value="${conta.codigo_pagamento || ''}" placeholder="Digite ou cole o c√≥digo">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Dia do Vencimento</label>
                    <input type="number" id="contaDiaEdit" class="form-input" min="1" max="31" value="${isRecorrente ? conta.dia_vencimento : dia}" inputmode="numeric">
                </div>
                ${!isRecorrente ? `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> M√™s/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="contaMesEdit" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="contaAnoEdit" class="form-input" value="${ano}" inputmode="numeric">
                    </div>
                </div>
                ` : ''}
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoConta('${id}', ${isRecorrente}, '${regraId || ''}', ${dia}, ${mes}, ${ano})" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Conta', 'fa-edit', conteudo);
        }

        async function salvarEdicaoConta(id, isRecorrente, regraId, dia, mes, ano) {
            let descricao = document.getElementById('contaDescricaoEdit')?.value.trim();
            let valor = parseCurrency(document.getElementById('contaValorEdit')?.value);
            let codigo = document.getElementById('contaCodigoEdit')?.value.trim() || null;
            let diaNovo = parseInt(document.getElementById('contaDiaEdit')?.value);
            
            if (!descricao || !valor) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            if (!dataValida(ano, mes, diaNovo)) {
                showToast('Dia inv√°lido para o m√™s selecionado', 'warning');
                return;
            }

            try {
                if (isRecorrente && regraId) {
                    await App.supabase.from('regras_contas').update({
                        descricao_base: descricao,
                        valor: valor,
                        codigo_pagamento: codigo,
                        dia_vencimento: diaNovo
                    }).eq('id', regraId);
                } else {
                    await App.supabase.from('contas').delete().eq('id', id);
                    
                    let dataInicio = dataParaString(ano, mes, diaNovo);
                    await App.supabase.from('contas').insert({
                        user_id: App.currentUser.id,
                        descricao: descricao,
                        valor: valor,
                        valor_pago: 0,
                        dia: diaNovo,
                        mes: mes,
                        ano: ano,
                        data: dataInicio,
                        status: 'pendente',
                        added_by: App.usuarioAtual || 'desconhecido',
                        codigo_pagamento: codigo
                    });
                }

                await registrarHistorico('edicao_conta', `Conta editada: ${descricao}`, { id, usuario: App.usuarioAtual });
                showToast('Conta atualizada!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar conta:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoEventoUnificado() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let iconesHtml = '';
            CONFIG.iconesEventos.forEach(icone => {
                iconesHtml += `<div class="icon-option" onclick="selecionarIconeEvento('${icone.icon}', '${icone.cor}')" data-icon="${icone.icon}" data-cor="${icone.cor}"><i class="fas ${icone.icon}" style="color:${icone.cor}"></i></div>`;
            });

            let frequenciasHtml = CONFIG.frequenciasEvento.map(f => 
                `<option value="${f}">${f.charAt(0).toUpperCase() + f.slice(1)}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> T√≠tulo do Evento</label>
                    <input type="text" id="eventoTitulo" class="form-input" placeholder="Digite o t√≠tulo">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequ√™ncia</label>
                    <select id="eventoFrequencia" class="form-select" onchange="atualizarVisibilidadeDataFim()">
                        ${frequenciasHtml}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de In√≠cio</label>
                    <div style="display:flex; gap:8px">
                        <input type="date" id="eventoDataInicio" class="form-input" style="flex:2" value="${ano}-${String(mes).padStart(2, '0')}-${String(diaPadrao).padStart(2, '0')}">
                        <button class="btn btn-sm btn-primary" onclick="abrirCalendarioInteligente()" style="flex:1"><i class="fas fa-calendar-alt"></i> Calend√°rio</button>
                    </div>
                </div>
                <div id="eventoDataFimDiv" class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de Fim (para eventos de m√∫ltiplos dias)</label>
                    <input type="date" id="eventoDataFim" class="form-input">
                </div>
                <div id="eventoCalendarioInteligente" class="inline-calendar" style="display:none;">
                    <div class="inline-calendar-grid" id="calendarioInteligenteGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descri√ß√£o</label>
                    <textarea id="eventoDescricao" class="form-textarea" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-icons"></i> Escolha o √çcone</label>
                    <button class="btn btn-primary" style="width:100%; margin-bottom:8px" onclick="abrirSeletorIcones()"><i class="fas fa-icons"></i> Selecionar √çcone</button>
                    <div id="iconeSelecionadoDisplay" style="display:none; text-align:center; padding:10px; background:#f8f9fa; border-radius:8px">
                        <i class="fas fa-star" id="iconePreview" style="font-size:32px; color:#ffd700"></i>
                    </div>
                    <input type="hidden" id="eventoIcone" value="fa-star">
                    <input type="hidden" id="eventoCorIcone" value="#ffd700">
                </div>
                <div id="seletorIconesModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:12px; z-index:1002; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2)">
                    <h4 style="margin-bottom:16px; color:var(--purple)">Escolha um √≠cone</h4>
                    <div class="icon-grid">${iconesHtml}</div>
                    <div style="text-align:center; margin-top:16px">
                        <button class="btn" onclick="fecharSeletorIcones()" style="background:var(--gray); color:#fff">Fechar</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-clock"></i> Hora</label>
                        <input type="time" id="eventoHora" class="form-input">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-map-marker-alt"></i> Local</label>
                        <input type="text" id="eventoLocal" class="form-input">
                    </div>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoEvento()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Evento', 'fa-calendar-plus', conteudo);
            setTimeout(atualizarVisibilidadeDataFim, 100);
        }

        function abrirCalendarioInteligente() {
            let dataInicioStr = document.getElementById('eventoDataInicio')?.value;
            if (!dataInicioStr) {
                showToast('Selecione a data de in√≠cio primeiro', 'warning');
                return;
            }
            
            let calendario = document.getElementById('eventoCalendarioInteligente');
            if (calendario.style.display === 'none' || calendario.style.display === '') {
                calendario.style.display = 'block';
                atualizarCalendarioInteligente();
            } else {
                calendario.style.display = 'none';
            }
        }

        function atualizarVisibilidadeDataFim() {
            let frequencia = document.getElementById('eventoFrequencia')?.value;
            let dataFimDiv = document.getElementById('eventoDataFimDiv');
            
            if (frequencia === 'unico') {
                dataFimDiv.style.display = 'block';
            } else {
                dataFimDiv.style.display = 'none';
            }
        }

        function atualizarCalendarioInteligente() {
            let frequencia = document.getElementById('eventoFrequencia')?.value;
            if (frequencia === 'unico') return;
            
            let dataInicioStr = document.getElementById('eventoDataInicio')?.value;
            if (!dataInicioStr) return;
            
            let dataInicio = new Date(dataInicioStr + 'T12:00:00');
            let ano = dataInicio.getFullYear();
            let mes = dataInicio.getMonth() + 1;
            let dia = dataInicio.getDate();
            
            let grid = document.getElementById('calendarioInteligenteGrid');
            grid.innerHTML = '';
            
            let mesesMostrar = 6;
            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < mesesMostrar; i++) {
                let mesAtual = mes + i;
                let anoAtual = ano;
                while (mesAtual > 12) {
                    mesAtual -= 12;
                    anoAtual++;
                }
                
                let mesHeader = document.createElement('div');
                mesHeader.style.gridColumn = 'span 7';
                mesHeader.style.fontWeight = 'bold';
                mesHeader.style.margin = '8px 0 4px';
                mesHeader.style.color = 'var(--purple)';
                mesHeader.textContent = `${getNomeMes(mesAtual)}/${anoAtual}`;
                grid.appendChild(mesHeader);
                
                CONFIG.diasSemana.forEach(diaSem => {
                    let header = document.createElement('div');
                    header.className = 'calendar-day-header';
                    header.textContent = diaSem;
                    grid.appendChild(header);
                });
                
                let primeiroDia = new Date(anoAtual, mesAtual - 1, 1).getDay();
                for (let j = 0; j < primeiroDia; j++) {
                    let cell = document.createElement('div');
                    cell.className = 'inline-calendar-day disabled';
                    grid.appendChild(cell);
                }
                
                let diasNoMes = getDiasNoMes(anoAtual, mesAtual);
                for (let d = 1; d <= diasNoMes; d++) {
                    let dataAtual = new Date(anoAtual, mesAtual - 1, d, 12, 0, 0);
                    if (dataAtual < dataInicio) {
                        let cell = document.createElement('div');
                        cell.className = 'inline-calendar-day disabled';
                        cell.textContent = d;
                        grid.appendChild(cell);
                        continue;
                    }
                    
                    let ativo = false;
                    
                    switch (frequencia) {
                        case 'semanal':
                            if (dataAtual.getDay() === dataInicio.getDay()) ativo = true;
                            break;
                        case 'quinzenal':
                            let diffDias = Math.floor((dataAtual - dataInicio) / (1000 * 60 * 60 * 24));
                            if (diffDias % 14 === 0) ativo = true;
                            break;
                        case 'mensal':
                            if (dataAtual.getDate() === dia) ativo = true;
                            break;
                        case 'semestral':
                            let diffMeses = (dataAtual.getFullYear() - dataInicio.getFullYear()) * 12 + (dataAtual.getMonth() - dataInicio.getMonth());
                            if (diffMeses % 6 === 0 && dataAtual.getDate() === dia) ativo = true;
                            break;
                        case 'anual':
                            if (dataAtual.getMonth() === dataInicio.getMonth() && dataAtual.getDate() === dia) ativo = true;
                            break;
                    }
                    
                    if (ativo) {
                        let cell = document.createElement('div');
                        cell.className = `inline-calendar-day active ${dataAtual.toDateString() === hoje.toDateString() ? 'today' : ''}`;
                        cell.textContent = d;
                        cell.onclick = () => {
                            document.getElementById('eventoDataFim').value = dataParaString(anoAtual, mesAtual, d);
                            atualizarCalendarioInteligente();
                        };
                        grid.appendChild(cell);
                    } else {
                        let cell = document.createElement('div');
                        cell.className = 'inline-calendar-day disabled';
                        cell.textContent = d;
                        grid.appendChild(cell);
                    }
                }
            }
        }

        function abrirSeletorIcones() {
            document.getElementById('seletorIconesModal').style.display = 'block';
        }

        function fecharSeletorIcones() {
            document.getElementById('seletorIconesModal').style.display = 'none';
        }

        function selecionarIconeEvento(icone, cor) {
            document.getElementById('eventoIcone').value = icone;
            document.getElementById('eventoCorIcone').value = cor;
            let display = document.getElementById('iconeSelecionadoDisplay');
            let preview = document.getElementById('iconePreview');
            preview.className = `fas ${icone}`;
            preview.style.color = cor;
            display.style.display = 'block';
            fecharSeletorIcones();
        }

        async function salvarNovoEvento() {
            let titulo = document.getElementById('eventoTitulo')?.value.trim();
            let desc = document.getElementById('eventoDescricao')?.value.trim();
            let dataInicioStr = document.getElementById('eventoDataInicio')?.value;
            let dataFimStr = document.getElementById('eventoDataFim')?.value || null;
            let hora = document.getElementById('eventoHora')?.value;
            let local = document.getElementById('eventoLocal')?.value.trim();
            let icone = document.getElementById('eventoIcone')?.value || 'fa-star';
            let corIcone = document.getElementById('eventoCorIcone')?.value || '#ffd700';
            let frequencia = document.getElementById('eventoFrequencia')?.value;

            if (!titulo || !dataInicioStr) {
                showToast('Preencha t√≠tulo e data de in√≠cio', 'warning');
                return;
            }

            if (frequencia !== 'unico' && !dataFimStr) {
                if (!confirm('Data de fim em branco criar√° eventos indefinidamente. Continuar?')) {
                    return;
                }
            }

            let dataInicio = new Date(dataInicioStr + 'T12:00:00');
            let dataFim = dataFimStr ? new Date(dataFimStr + 'T12:00:00') : null;

            if (dataFim && dataFim < dataInicio) {
                showToast('Data de fim deve ser ap√≥s data de in√≠cio', 'warning');
                return;
            }

            let anoInicio = dataInicio.getFullYear();
            let mesInicio = dataInicio.getMonth() + 1;
            let diaInicio = dataInicio.getDate();

            try {
                if (frequencia === 'unico') {
                    if (dataFim) {
                        let dataAtual = new Date(dataInicio);
                        while (dataAtual <= dataFim) {
                            let ano = dataAtual.getFullYear();
                            let mes = dataAtual.getMonth() + 1;
                            let dia = dataAtual.getDate();
                            
                            await App.supabase.from('eventos').insert({
                                user_id: App.currentUser.id,
                                titulo: titulo,
                                descricao: desc || '',
                                dia: dia,
                                mes: mes,
                                ano: ano,
                                hora: hora || null,
                                local: local || null,
                                icone: icone,
                                cor_icone: corIcone,
                                data_inicio: dataInicioStr,
                                data_fim: dataFimStr,
                                is_recorrente: false,
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                            
                            dataAtual.setDate(dataAtual.getDate() + 1);
                        }
                    } else {
                        await App.supabase.from('eventos').insert({
                            user_id: App.currentUser.id,
                            titulo: titulo,
                            descricao: desc || '',
                            dia: diaInicio,
                            mes: mesInicio,
                            ano: anoInicio,
                            hora: hora || null,
                            local: local || null,
                            icone: icone,
                            cor_icone: corIcone,
                            data_inicio: dataInicioStr,
                            data_fim: null,
                            is_recorrente: false,
                            added_by: App.usuarioAtual || 'desconhecido'
                        });
                    }
                } else {
                    await App.supabase.from('regras_eventos').insert({
                        user_id: App.currentUser.id,
                        titulo_base: titulo,
                        descricao: desc || '',
                        dia: diaInicio,
                        hora: hora || null,
                        local: local || null,
                        icone: icone,
                        cor_icone: corIcone,
                        frequencia: frequencia,
                        data_inicio: dataInicioStr,
                        data_fim: dataFimStr,
                        ativo: true,
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                }

                verificarNotificacoes({ titulo, descricao: desc }, 'eventos');
                await registrarHistorico('criacao_evento', `Evento criado: ${titulo}`, { titulo, icone, usuario: App.usuarioAtual });
                showToast('Evento salvo com sucesso!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar evento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarEvento(id, isRecorrente, regraId, isIndividual, individualId, dia, mes, ano) {
            if (!App.dataCache || (!App.dataCache.eventos && !App.dataCache.regrasEventos && !App.dataCache.eventosIndividuais)) {
                showToast('Dados n√£o carregados. Tente novamente.', 'warning');
                return;
            }
            
            let evento = null;
            
            if (isRecorrente && regraId) {
                evento = App.dataCache.regrasEventos?.find(r => r.id == regraId);
            }
            
            if (!evento && isIndividual && individualId) {
                evento = App.dataCache.eventosIndividuais?.find(e => e.id == individualId);
            }
            
            if (!evento) {
                evento = App.dataCache.eventos?.find(e => e.id == id);
            }
            
            if (!evento && id && id.toString().startsWith('regra_evento_')) {
                const parts = id.split('_');
                if (parts.length >= 4) {
                    const regraIdFromId = parts[2];
                    evento = App.dataCache.regrasEventos?.find(r => r.id == regraIdFromId);
                }
            }
            
            if (!evento) {
                showToast('Evento n√£o encontrado', 'warning');
                return;
            }

            let frequenciasHtml = CONFIG.frequenciasEvento.map(f => 
                `<option value="${f}" ${(isRecorrente ? evento.frequencia : 'unico') === f ? 'selected' : ''}>${f.charAt(0).toUpperCase() + f.slice(1)}</option>`
            ).join('');

            let dataInicioStr = evento.data_inicio || dataParaString(ano, mes, dia);
            let dataFimStr = evento.data_fim || '';

            let iconesHtml = '';
            CONFIG.iconesEventos.forEach(icone => {
                iconesHtml += `<div class="icon-option" onclick="selecionarIconeEventoEdit('${icone.icon}', '${icone.cor}')" data-icon="${icone.icon}" data-cor="${icone.cor}"><i class="fas ${icone.icon}" style="color:${icone.cor}"></i></div>`;
            });

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> T√≠tulo</label>
                    <input type="text" id="eventoTituloEdit" class="form-input" value="${isRecorrente ? evento.titulo_base : evento.titulo}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequ√™ncia</label>
                    <select id="eventoFrequenciaEdit" class="form-select" ${!isRecorrente ? 'disabled' : ''}>
                        ${frequenciasHtml}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de In√≠cio</label>
                    <input type="date" id="eventoDataInicioEdit" class="form-input" value="${dataInicioStr}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de Fim</label>
                    <input type="date" id="eventoDataFimEdit" class="form-input" value="${dataFimStr}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descri√ß√£o</label>
                    <textarea id="eventoDescricaoEdit" class="form-textarea" rows="2">${evento.descricao || ''}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-icons"></i> √çcone Atual</label>
                    <div style="text-align:center; padding:10px; background:#f8f9fa; border-radius:8px">
                        <i class="fas ${evento.icone || 'fa-star'}" id="iconeEditPreview" style="font-size:32px; color:${evento.cor_icone || '#ffd700'}"></i>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:8px" onclick="abrirSeletorIconesEdit()"><i class="fas fa-icons"></i> Trocar √çcone</button>
                    <input type="hidden" id="eventoIconeEdit" value="${evento.icone || 'fa-star'}">
                    <input type="hidden" id="eventoCorIconeEdit" value="${evento.cor_icone || '#ffd700'}">
                </div>
                <div id="seletorIconesEditModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:12px; z-index:1002; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2)">
                    <h4 style="margin-bottom:16px; color:var(--purple)">Escolha um √≠cone</h4>
                    <div class="icon-grid">${iconesHtml}</div>
                    <div style="text-align:center; margin-top:16px">
                        <button class="btn" onclick="fecharSeletorIconesEdit()" style="background:var(--gray); color:#fff">Fechar</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-clock"></i> Hora</label>
                        <input type="time" id="eventoHoraEdit" class="form-input" value="${evento.hora || ''}">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-map-marker-alt"></i> Local</label>
                        <input type="text" id="eventoLocalEdit" class="form-input" value="${evento.local || ''}">
                    </div>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoEvento('${id}', ${isRecorrente}, '${regraId || ''}', ${isIndividual}, '${individualId || ''}', ${dia}, ${mes}, ${ano})" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Evento', 'fa-edit', conteudo);
        }

        function abrirSeletorIconesEdit() {
            document.getElementById('seletorIconesEditModal').style.display = 'block';
        }

        function fecharSeletorIconesEdit() {
            document.getElementById('seletorIconesEditModal').style.display = 'none';
        }

        function selecionarIconeEventoEdit(icone, cor) {
            document.getElementById('eventoIconeEdit').value = icone;
            document.getElementById('eventoCorIconeEdit').value = cor;
            let preview = document.getElementById('iconeEditPreview');
            preview.className = `fas ${icone}`;
            preview.style.color = cor;
            fecharSeletorIconesEdit();
        }

        async function salvarEdicaoEvento(id, isRecorrente, regraId, isIndividual, individualId, dia, mes, ano) {
            let titulo = document.getElementById('eventoTituloEdit')?.value.trim();
            let desc = document.getElementById('eventoDescricaoEdit')?.value.trim();
            let dataInicioStr = document.getElementById('eventoDataInicioEdit')?.value;
            let dataFimStr = document.getElementById('eventoDataFimEdit')?.value || null;
            let hora = document.getElementById('eventoHoraEdit')?.value;
            let local = document.getElementById('eventoLocalEdit')?.value.trim();
            let icone = document.getElementById('eventoIconeEdit')?.value || 'fa-star';
            let corIcone = document.getElementById('eventoCorIconeEdit')?.value || '#ffd700';

            if (!titulo || !dataInicioStr) {
                showToast('Preencha t√≠tulo e data de in√≠cio', 'warning');
                return;
            }

            try {
                if (isRecorrente && regraId) {
                    await App.supabase.from('regras_eventos').update({
                        titulo_base: titulo,
                        descricao: desc || '',
                        hora: hora || null,
                        local: local || null,
                        icone: icone,
                        cor_icone: corIcone,
                        data_inicio: dataInicioStr,
                        data_fim: dataFimStr
                    }).eq('id', regraId);
                } else if (isIndividual && individualId) {
                    await App.supabase.from('eventos_individuais').delete().eq('id', individualId);
                    
                    let dataInicio = new Date(dataInicioStr + 'T12:00:00');
                    await App.supabase.from('eventos_individuais').insert({
                        user_id: App.currentUser.id,
                        regra_id: regraId,
                        titulo: titulo,
                        descricao: desc || '',
                        dia: dataInicio.getDate(),
                        mes: dataInicio.getMonth() + 1,
                        ano: dataInicio.getFullYear(),
                        hora: hora || null,
                        local: local || null,
                        icone: icone,
                        cor_icone: corIcone,
                        data_original: dataInicioStr,
                        data_inicio: dataInicioStr,
                        data_fim: dataFimStr,
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                } else {
                    await App.supabase.from('eventos').delete().eq('data_inicio', dataInicioStr).eq('data_fim', dataFimStr);
                    
                    let dataInicio = new Date(dataInicioStr + 'T12:00:00');
                    let dataFim = dataFimStr ? new Date(dataFimStr + 'T12:00:00') : null;
                    
                    if (dataFim) {
                        let dataAtual = new Date(dataInicio);
                        while (dataAtual <= dataFim) {
                            let anoAtual = dataAtual.getFullYear();
                            let mesAtual = dataAtual.getMonth() + 1;
                            let diaAtual = dataAtual.getDate();
                            
                            await App.supabase.from('eventos').insert({
                                user_id: App.currentUser.id,
                                titulo: titulo,
                                descricao: desc || '',
                                dia: diaAtual,
                                mes: mesAtual,
                                ano: anoAtual,
                                hora: hora || null,
                                local: local || null,
                                icone: icone,
                                cor_icone: corIcone,
                                data_inicio: dataInicioStr,
                                data_fim: dataFimStr,
                                is_recorrente: false,
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                            
                            dataAtual.setDate(dataAtual.getDate() + 1);
                        }
                    } else {
                        await App.supabase.from('eventos').insert({
                            user_id: App.currentUser.id,
                            titulo: titulo,
                            descricao: desc || '',
                            dia: dataInicio.getDate(),
                            mes: dataInicio.getMonth() + 1,
                            ano: dataInicio.getFullYear(),
                            hora: hora || null,
                            local: local || null,
                            icone: icone,
                            cor_icone: corIcone,
                            data_inicio: dataInicioStr,
                            data_fim: null,
                            is_recorrente: false,
                            added_by: App.usuarioAtual || 'desconhecido'
                        });
                    }
                }

                await registrarHistorico('edicao_evento', `Evento editado: ${titulo}`, { id, usuario: App.usuarioAtual });
                showToast('Evento atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar evento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirModalPagamento(id, desc, valor, regraId, dia, mes, ano, isRecorrente, codigoPagamento) {
            let codigoHtml = codigoPagamento ? `
                <div class="payment-info">
                    <div class="payment-info-header">
                        <span><i class="fas fa-barcode"></i> C√≥digo de Barras / Chave PIX</span>
                        <button class="btn-copy" onclick="copiarCodigoPagamento('${codigoPagamento}')"><i class="fas fa-copy"></i> Copiar</button>
                    </div>
                    <div class="payment-info-content" id="codigoPagamentoDisplay">${codigoPagamento}</div>
                </div>
            ` : '';

            let conteudo = `
                <div style="padding:16px">
                    <p>Pagamento de <strong>${desc}</strong></p>
                    ${codigoHtml}
                    <div class="form-group" style="margin:16px 0">
                        <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor a pagar</label>
                        <input type="text" id="pagamentoValorConta" class="form-input" value="${valor.toFixed(2).replace('.', ',')}" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="confirmarPagamento('${id}', '${desc}', '${regraId}', ${dia}, ${mes}, ${ano}, ${isRecorrente})" style="flex:2"><i class="fas fa-check"></i> Confirmar Pagamento</button>
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Confirmar Pagamento', 'fa-dollar-sign', conteudo);
        }

        function copiarCodigoPagamento(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                showToast('C√≥digo copiado!', 'success');
            }).catch(() => {
                showToast('Erro ao copiar', 'error');
            });
        }

        async function confirmarPagamento(id, desc, regraId, dia, mes, ano, isRecorrente) {
            if (App.processandoPagamento) {
                showToast('Processando pagamento, aguarde...', 'warning');
                return;
            }
            
            App.processandoPagamento = true;
            
            let valor = parseCurrency(document.getElementById('pagamentoValorConta')?.value);

            try {
                if (isRecorrente && regraId) {
                    await App.supabase.from('excecoes_recorrencia').insert({
                        user_id: App.currentUser.id,
                        regra_id: regraId,
                        data_excecao: dataParaString(ano, mes, dia),
                        acao: 'pagar',
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                } else {
                    await App.supabase.from('contas').update({
                        valor_pago: valor,
                        status: 'paga',
                        data_pagamento: new Date().toISOString()
                    }).eq('id', id);
                }

                if (App.saldoCentral.id) {
                    let { data: saldoAtual, error: saldoError } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual && !saldoError) {
                        let novoValor = saldoAtual.valor - valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('pagamento_conta', `Conta paga: ${desc}`, { id, valor, usuario: App.usuarioAtual });
                
                verificarNotificacoes({ descricao: 'Pagamento confirmado', valor }, 'contas');
                
                showToast('Pagamento confirmado!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao pagar conta:', error);
                showToast('Erro: ' + error.message, 'error');
            } finally {
                App.processandoPagamento = false;
            }
        }

        function abrirModalDesfazerPagamento(id, desc, valor, regraId, dia, mes, ano, isRecorrente) {
            let conteudo = `
                <div style="padding:16px; text-align:center">
                    <p>Desfazer pagamento de <strong>${desc}</strong>?</p>
                    <p style="font-size:1.2em; margin:16px 0">${formatCurrency(valor)} voltar√° para o saldo</p>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="desfazerPagamento('${id}', ${valor}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isRecorrente})" style="flex:2"><i class="fas fa-undo-alt"></i> Desfazer</button>
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Desfazer Pagamento', 'fa-undo-alt', conteudo);
        }

        async function desfazerPagamento(id, valor, regraId, dia, mes, ano, isRecorrente) {
            try {
                if (isRecorrente && regraId) {
                    await App.supabase
                        .from('excecoes_recorrencia')
                        .delete()
                        .eq('regra_id', regraId)
                        .eq('data_excecao', dataParaString(ano, mes, dia));
                } else {
                    await App.supabase.from('contas').update({
                        valor_pago: 0,
                        status: 'pendente',
                        data_pagamento: null
                    }).eq('id', id);
                }

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor + valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('desfazer_pagamento', `Pagamento desfeito: ${id}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Pagamento desfeito!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao desfazer pagamento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarItem(id, tipo, isRecorrente, regraId, isIndividual, individualId, dia, mes, ano) {
            if (tipo === 'gasto') {
                editarGasto(id);
            } else if (tipo === 'evento') {
                editarEvento(id, isRecorrente, regraId, isIndividual, individualId, dia, mes, ano);
            } else if (tipo === 'conta') {
                editarConta(id, isRecorrente, regraId, dia, mes, ano);
            }
        }

        function confirmarExclusaoGasto(id, desc, valor) {
            let conteudo = `
                <div style="padding:16px">
                    <h3 style="margin-bottom:16px">Excluir Gasto</h3>
                    <p>Como deseja excluir este gasto?</p>
                    <div class="exclusao-gasto-opcao" onclick="excluirGastoComSaldo('${id}', ${valor})">
                        <strong>Excluir e devolver saldo</strong>
                        <p style="font-size:0.9em;color:var(--gray)">O valor de ${formatCurrency(valor)} voltar√° para o saldo central</p>
                    </div>
                    <div class="exclusao-gasto-opcao" onclick="excluirGastoSemSaldo('${id}')">
                        <strong>Excluir sem devolver saldo</strong>
                        <p style="font-size:0.9em;color:var(--gray)">O valor ser√° removido permanentemente (n√£o volta para o saldo)</p>
                    </div>
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Excluir Gasto', 'fa-trash', conteudo);
        }

        async function excluirGastoComSaldo(id, valor) {
            try {
                await App.supabase.from('gastos').delete().eq('id', id);

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor + valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('exclusao_gasto', `Gasto exclu√≠do com devolu√ß√£o`, { id, valor, usuario: App.usuarioAtual });
                showToast('Gasto exclu√≠do e saldo devolvido!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao excluir gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        async function excluirGastoSemSaldo(id) {
            try {
                await App.supabase.from('gastos').delete().eq('id', id);

                await registrarHistorico('exclusao_gasto', `Gasto exclu√≠do sem devolu√ß√£o`, { id, usuario: App.usuarioAtual });
                showToast('Gasto exclu√≠do!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao excluir gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function confirmarExclusao(id, tipo, isRecorrente, regraId, dia, mes, ano, isIndividual, individualId) {
            if (tipo === 'gasto') {
                confirmarExclusaoGasto(id, '', 0);
                return;
            }

            if (tipo === 'evento' && (isRecorrente || regraId || (!isRecorrente && dia && mes && ano))) {
                let evento = isRecorrente ? App.dataCache.regrasEventos.find(r => r.id === regraId) : 
                            isIndividual ? App.dataCache.eventosIndividuais.find(e => e.id === individualId) :
                            App.dataCache.eventos.find(e => e.id === id);
                
                let temDataFim = evento && evento.data_fim;
                
                let conteudo = `
                    <div style="padding:16px">
                        <h3 style="margin-bottom:16px">Excluir Evento</h3>
                        <p>Como deseja excluir este evento?</p>
                        <div class="exclusao-opcoes">
                            <div class="exclusao-opcao" onclick="selecionarExclusao('unica', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoUnica">
                                <strong>Apenas este dia</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui somente o evento deste dia espec√≠fico</p>
                            </div>`;
                
                if (temDataFim || isRecorrente) {
                    conteudo += `
                            <div class="exclusao-opcao" onclick="selecionarExclusao('futuras', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoFuturas">
                                <strong>Deste dia em diante</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui este e todos os eventos futuros</p>
                            </div>`;
                }
                
                conteudo += `
                            <div class="exclusao-opcao" onclick="selecionarExclusao('todas', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoTodas">
                                <strong>Todos os dias</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui todos os dias deste evento</p>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top:20px">
                            <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                        </div>
                    </div>
                `;
                abrirModal('Excluir Evento', 'fa-trash', conteudo);
            } else if (tipo === 'conta' && (isRecorrente || regraId)) {
                let conteudo = `
                    <div style="padding:16px">
                        <h3 style="margin-bottom:16px">Excluir Conta</h3>
                        <p>Ao excluir uma conta o seu saldo n√£o ser√° afetado. Esse valor n√£o retornar√° ao saldo. Para retornar o valor ao saldo, desfa√ßa o pagamento antes de excluir a conta.</p>
                        <p style="margin:12px 0; font-weight:bold">Deseja deletar assim mesmo?</p>
                        <div class="exclusao-opcoes">
                            <div class="exclusao-opcao" onclick="selecionarExclusaoConta('unica', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano})" id="exclusaoUnica">
                                <strong>Apenas esta ocorr√™ncia</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui somente esta conta espec√≠fica</p>
                            </div>
                            <div class="exclusao-opcao" onclick="selecionarExclusaoConta('futuras', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano})" id="exclusaoFuturas">
                                <strong>Desta data em diante</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui esta e todas as futuras</p>
                            </div>
                            <div class="exclusao-opcao" onclick="selecionarExclusaoConta('todas', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano})" id="exclusaoTodas">
                                <strong>Todas as ocorr√™ncias</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui a regra inteira</p>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top:20px">
                            <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                        </div>
                    </div>
                `;
                abrirModal('Excluir Conta', 'fa-trash', conteudo);
            } else {
                if (confirm(`Tem certeza que deseja excluir este ${tipo}?`)) {
                    (async () => {
                        try {
                            if (tipo === 'gasto') {
                                await App.supabase.from('gastos').delete().eq('id', id);
                            } else if (tipo === 'evento') {
                                await App.supabase.from('eventos').delete().eq('id', id);
                            } else if (tipo === 'conta') {
                                await App.supabase.from('contas').delete().eq('id', id);
                            }

                            await registrarHistorico('exclusao_item', `${tipo} exclu√≠do`, { id, tipo, usuario: App.usuarioAtual });
                            showToast('Item exclu√≠do!', 'success');
                            fecharModal();
                            await carregarDados(true);
                            await atualizarCalendario();
                            await mostrarConteudo();
                        } catch (error) {
                            console.error('Erro ao excluir:', error);
                            showToast('Erro: ' + error.message, 'error');
                        }
                    })();
                }
            }
        }

        function selecionarExclusao(tipo, id, tipoItem, isRecorrente, regraId, dia, mes, ano, isIndividual, individualId) {
            (async () => {
                try {
                    if (tipo === 'unica') {
                        if (isRecorrente && regraId) {
                            let dataExcecao = dataParaString(ano, mes, dia);
                            await App.supabase.from('excecoes_recorrencia').insert({
                                user_id: App.currentUser.id,
                                regra_id: regraId,
                                data_excecao: dataExcecao,
                                acao: 'excluir',
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                        } else if (isIndividual && individualId) {
                            await App.supabase.from('eventos_individuais').delete().eq('id', individualId);
                        } else {
                            await App.supabase.from('eventos').delete().eq('id', id);
                        }
                    } else if (tipo === 'futuras') {
                        let dataFim = dataParaString(ano, mes, dia - 1);
                        await App.supabase
                            .from('regras_eventos')
                            .update({ data_fim: dataFim })
                            .eq('id', regraId);
                        
                        await App.supabase
                            .from('eventos_individuais')
                            .delete()
                            .eq('regra_id', regraId)
                            .gte('data_original', dataParaString(ano, mes, dia));
                    } else if (tipo === 'todas') {
                        if (isRecorrente && regraId) {
                            await App.supabase.from('regras_eventos').delete().eq('id', regraId);
                            await App.supabase.from('eventos_individuais').delete().eq('regra_id', regraId);
                            await App.supabase.from('excecoes_recorrencia').delete().eq('regra_id', regraId);
                        } else if (isIndividual && individualId) {
                            await App.supabase.from('eventos_individuais').delete().eq('id', individualId);
                            
                            const { count } = await App.supabase
                                .from('eventos_individuais')
                                .select('*', { count: 'exact', head: true })
                                .eq('regra_id', regraId);
                            
                            if (count === 0) {
                                await App.supabase.from('regras_eventos').delete().eq('id', regraId);
                            }
                        } else {
                            const evento = App.dataCache.eventos.find(e => e.id == id);
                            
                            if (evento && evento.data_inicio && evento.data_fim) {
                                await App.supabase
                                    .from('eventos')
                                    .delete()
                                    .eq('user_id', App.currentUser.id)
                                    .eq('data_inicio', evento.data_inicio)
                                    .eq('data_fim', evento.data_fim);
                            } else {
                                await App.supabase.from('eventos').delete().eq('id', id);
                            }
                        }
                    }

                    await registrarHistorico('exclusao_evento', `Evento exclu√≠do (${tipo})`, { id, usuario: App.usuarioAtual });
                    showToast('Evento exclu√≠do!', 'success');
                    fecharModal();
                    await carregarDados(true);
                    await atualizarCalendario();
                    await mostrarConteudo();
                } catch (error) {
                    console.error('Erro ao excluir evento:', error);
                    showToast('Erro: ' + error.message, 'error');
                }
            })();
        }

        function selecionarExclusaoConta(tipo, id, tipoItem, isRecorrente, regraId, dia, mes, ano) {
            (async () => {
                try {
                    if (tipo === 'unica') {
                        if (isRecorrente && regraId) {
                            let dataExcecao = dataParaString(ano, mes, dia);
                            await App.supabase.from('excecoes_recorrencia').insert({
                                user_id: App.currentUser.id,
                                regra_id: regraId,
                                data_excecao: dataExcecao,
                                acao: 'excluir',
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                        } else {
                            await App.supabase.from('contas').delete().eq('id', id);
                        }
                    } else if (tipo === 'futuras') {
                        let dataFim = dataParaString(ano, mes, dia - 1);
                        await App.supabase
                            .from('regras_contas')
                            .update({ data_fim: dataFim })
                            .eq('id', regraId);
                    } else if (tipo === 'todas') {
                        await App.supabase.from('regras_contas').delete().eq('id', regraId);
                        await App.supabase.from('excecoes_recorrencia').delete().eq('regra_id', regraId);
                    }

                    await registrarHistorico('exclusao_conta', `Conta exclu√≠da (${tipo})`, { id, usuario: App.usuarioAtual });
                    showToast('Conta exclu√≠da!', 'success');
                    fecharModal();
                    await carregarDados(true);
                    await atualizarCalendario();
                    await mostrarConteudo();
                } catch (error) {
                    console.error('Erro ao excluir conta:', error);
                    showToast('Erro: ' + error.message, 'error');
                }
            })();
        }

        function abrirMenuRelatorio() {
            let { mes, ano } = getMesAnoAtual();
            let totalContas = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano).reduce((acc, c) => acc + (c.valor_original || c.valor || 0), 0);
            let totalPago = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano && c.valor_pago > 0).reduce((acc, c) => acc + c.valor_pago, 0);
            let totalGastos = App.dataCache.gastos.filter(g => g.mes === mes && g.ano === ano).reduce((acc, g) => acc + (g.valor || 0), 0);
            let saldoFinal = App.saldoCentral.valor;
            
            let percentualPago = totalContas > 0 ? (totalPago / totalContas * 100) : 0;
            let percentualGastos = saldoFinal > 0 ? (totalGastos / (saldoFinal + totalGastos) * 100) : 0;
            
            let conteudo = `
                <div style="padding:16px">
                    <h3 style="color:var(--purple);margin-bottom:16px">Relat√≥rio de ${getNomeMes(mes)}/${ano}</h3>
                    
                    <div class="report-chart">
                        <h4 style="margin-bottom:12px">Resumo Financeiro</h4>
                        
                        <div class="chart-bar-container">
                            <div class="chart-bar-label">
                                <span>Contas Pagas</span>
                                <span>${formatCurrency(totalPago)} de ${formatCurrency(totalContas)} (${percentualPago.toFixed(1)}%)</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill ${percentualPago >= 100 ? 'success' : ''}" style="width: ${percentualPago}%"></div>
                            </div>
                        </div>
                        
                        <div class="chart-bar-container">
                            <div class="chart-bar-label">
                                <span>Gastos do M√™s</span>
                                <span>${formatCurrency(totalGastos)}</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill warning" style="width: ${percentualGastos}%"></div>
                            </div>
                        </div>
                        
                        <div class="chart-bar-container">
                            <div class="chart-bar-label">
                                <span>Saldo Atual</span>
                                <span>${formatCurrency(saldoFinal)}</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill success" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px">
                        <div style="background:var(--bg-pendente);padding:12px;border-radius:8px">
                            <div style="font-size:0.9em">Total Contas</div>
                            <div style="font-size:1.2em;font-weight:700">${formatCurrency(totalContas)}</div>
                        </div>
                        <div style="background:var(--bg-success-light);padding:12px;border-radius:8px">
                            <div style="font-size:0.9em">Total Pago</div>
                            <div style="font-size:1.2em;font-weight:700;color:var(--text-success)">${formatCurrency(totalPago)}</div>
                        </div>
                        <div style="background:var(--bg-gasto);padding:12px;border-radius:8px">
                            <div style="font-size:0.9em">Total Gastos</div>
                            <div style="font-size:1.2em;font-weight:700">${formatCurrency(totalGastos)}</div>
                        </div>
                        <div style="background:var(--bg-evento);padding:12px;border-radius:8px">
                            <div style="font-size:0.9em">Saldo Final</div>
                            <div style="font-size:1.2em;font-weight:700">${formatCurrency(saldoFinal)}</div>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            `;
            abrirModal('Relat√≥rio', 'fa-chart-line', conteudo);
        }

        function abrirMenuSeguranca() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label">Senha Atual (acesso)</label>
                    <input type="password" id="senhaAtualAcesso" class="form-input" placeholder="Digite a senha atual" maxlength="6" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">Nova Senha de Acesso</label>
                    <input type="password" id="novaSenhaAcesso" class="form-input" placeholder="6 d√≠gitos" maxlength="6" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Nova Senha de Acesso</label>
                    <input type="password" id="confirmaSenhaAcesso" class="form-input" placeholder="Repita a nova senha" maxlength="6" inputmode="numeric">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="alterarSenhas()"><i class="fas fa-save"></i> Salvar Altera√ß√µes</button>
                    <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Seguran√ßa', 'fa-lock', conteudo);
        }

        function alterarSenhas() {
            let senhaAtualAcesso = document.getElementById('senhaAtualAcesso')?.value;
            let novaSenhaAcesso = document.getElementById('novaSenhaAcesso')?.value;
            let confirmaSenhaAcesso = document.getElementById('confirmaSenhaAcesso')?.value;

            if (novaSenhaAcesso || confirmaSenhaAcesso || senhaAtualAcesso) {
                if (!senhaAtualAcesso) {
                    showToast('Digite a senha atual de acesso', 'warning');
                    return;
                }
                
                let authSenhaAtual = prompt('Digite sua senha de login para confirmar:');
                if (authSenhaAtual !== App.acessoNovaSenha && App.acessoNovaSenha) {
                    showToast('Senha de login incorreta', 'error');
                    return;
                }
                
                if (!novaSenhaAcesso || novaSenhaAcesso.length !== 6) {
                    showToast('Nova senha de acesso deve ter 6 d√≠gitos', 'warning');
                    return;
                }
                
                if (novaSenhaAcesso !== confirmaSenhaAcesso) {
                    showToast('As novas senhas de acesso n√£o coincidem', 'warning');
                    return;
                }
                
                App.acessoNovaSenha = novaSenhaAcesso;
                showToast('Senha de acesso alterada!', 'success');
            }

            salvarConfigLocal();
            fecharModal();
        }

        function abrirNotificacoes() {
            let config = App.notificacoesConfig;
            
            let antecedenciaContasHtml = CONFIG.notificacaoAntecedencia.map(a => 
                `<option value="${a.valor}" ${config.antecedencia?.contas === a.valor ? 'selected' : ''}>${a.label}</option>`
            ).join('');
            
            let antecedenciaEventosHtml = CONFIG.notificacaoAntecedencia.map(a => 
                `<option value="${a.valor}" ${config.antecedencia?.eventos === a.valor ? 'selected' : ''}>${a.label}</option>`
            ).join('');
            
            let antecedenciaListaHtml = CONFIG.notificacaoAntecedencia.map(a => 
                `<option value="${a.valor}" ${config.antecedencia?.lista === a.valor ? 'selected' : ''}>${a.label}</option>`
            ).join('');

            let conteudo = `
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifContas" ${config.contas ? 'checked' : ''}> Notificar Contas</label>
                </div>
                <div class="form-group" style="margin-left:20px">
                    <label class="form-label">Anteced√™ncia para Contas</label>
                    <select id="notifAntecedenciaContas" class="form-select">
                        ${antecedenciaContasHtml}
                    </select>
                </div>
                
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifEventos" ${config.eventos ? 'checked' : ''}> Notificar Eventos</label>
                </div>
                <div class="form-group" style="margin-left:20px">
                    <label class="form-label">Anteced√™ncia para Eventos</label>
                    <select id="notifAntecedenciaEventos" class="form-select">
                        ${antecedenciaEventosHtml}
                    </select>
                </div>
                
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifLista" ${config.lista ? 'checked' : ''}> Notificar Lista</label>
                </div>
                <div class="form-group" style="margin-left:20px">
                    <label class="form-label">Anteced√™ncia para Lista</label>
                    <select id="notifAntecedenciaLista" class="form-select">
                        ${antecedenciaListaHtml}
                    </select>
                </div>
                
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifNovoItem" ${config.novoItem ? 'checked' : ''}> Notificar Novo Item (outro usu√°rio)</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Notifica√ß√£o</label>
                    <select id="notifTipo" class="form-select">
                        <option value="ambos" ${config.tipo === 'ambos' ? 'selected' : ''}>Banner + Bloqueio</option>
                        <option value="banner" ${config.tipo === 'banner' ? 'selected' : ''}>Apenas Banner</option>
                        <option value="bloqueio" ${config.tipo === 'bloqueio' ? 'selected' : ''}>Apenas Bloqueio</option>
                    </select>
                </div>
                
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNotificacoes()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Configurar Notifica√ß√µes', 'fa-bell', conteudo);
        }

        function salvarNotificacoes() {
            App.notificacoesConfig = {
                contas: document.getElementById('notifContas')?.checked || false,
                eventos: document.getElementById('notifEventos')?.checked || false,
                lista: document.getElementById('notifLista')?.checked || false,
                novoItem: document.getElementById('notifNovoItem')?.checked || false,
                tipo: document.getElementById('notifTipo')?.value || 'ambos',
                antecedencia: {
                    contas: parseInt(document.getElementById('notifAntecedenciaContas')?.value) || 0,
                    eventos: parseInt(document.getElementById('notifAntecedenciaEventos')?.value) || 0,
                    lista: parseInt(document.getElementById('notifAntecedenciaLista')?.value) || 0
                }
            };
            
            if (App.notificacoesConfig.contas || App.notificacoesConfig.eventos || 
                App.notificacoesConfig.lista || App.notificacoesConfig.novoItem) {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }
            
            salvarConfigLocal();
            fecharModal();
            showToast('Configura√ß√µes salvas!', 'success');
        }

        function abrirUltimasAcoes() {
            if (!App.historicoAcoes || App.historicoAcoes.length === 0) {
                let conteudo = '<div class="empty-state"><i class="fas fa-history"></i><p>Nenhuma a√ß√£o registrada</p></div>';
                abrirModal('√öltimas A√ß√µes', 'fa-history', conteudo);
                return;
            }

            let html = '<div class="items-list">';
            App.historicoAcoes.slice(0, 100).forEach(h => {
                let data = new Date(h.data).toLocaleString('pt-BR');
                let detalhes = '';
                
                if (h.tipo === 'criacao_conta') {
                    detalhes = `Conta: ${h.detalhes.descricao} - Valor: ${formatCurrency(h.detalhes.valor)} - Frequ√™ncia: ${h.detalhes.frequencia}`;
                } else if (h.tipo === 'pagamento_conta') {
                    detalhes = `Valor pago: ${formatCurrency(h.detalhes.valor)}`;
                } else if (h.tipo === 'criacao_gasto') {
                    detalhes = `Gasto: ${h.detalhes.desc} - Valor: ${formatCurrency(h.detalhes.valor)} - Categoria: ${h.detalhes.cat}`;
                } else if (h.tipo === 'criacao_evento') {
                    detalhes = `Evento: ${h.detalhes.titulo} - √çcone: ${h.detalhes.icone}`;
                } else if (h.tipo === 'edicao_conta' || h.tipo === 'edicao_evento' || h.tipo === 'edicao_gasto' || h.tipo === 'edicao_giro' || h.tipo === 'edicao_saldo' || h.tipo === 'edicao_lista') {
                    detalhes = 'Informa√ß√µes atualizadas';
                } else if (h.tipo === 'exclusao_item') {
                    detalhes = `Tipo: ${h.detalhes.tipo}`;
                } else if (h.tipo === 'exclusao_evento' || h.tipo === 'exclusao_conta' || h.tipo === 'exclusao_giro' || h.tipo === 'exclusao_saldo' || h.tipo === 'exclusao_lista') {
                    detalhes = 'Item removido';
                } else if (h.tipo === 'criacao_lista') {
                    detalhes = `Item: ${h.detalhes.desc} - Quantidade: ${h.detalhes.qtd}`;
                } else if (h.tipo === 'criacao_giro') {
                    detalhes = `Giro: ${h.detalhes.desc} - Valor: ${formatCurrency(h.detalhes.valor)} - Pessoa: ${h.detalhes.pessoa}`;
                } else if (h.tipo === 'pagamento_giro') {
                    detalhes = `Valor: ${formatCurrency(h.detalhes.valor)}`;
                } else if (h.tipo === 'recebimento_giro') {
                    detalhes = `Valor: ${formatCurrency(h.detalhes.valor)}`;
                } else if (h.tipo === 'adicao_saldo' || h.tipo === 'retirada_saldo' || h.tipo === 'atualizacao_saldo') {
                    detalhes = `Valor: ${formatCurrency(h.detalhes.valor)}`;
                } else if (h.detalhes && typeof h.detalhes === 'object') {
                    detalhes = JSON.stringify(h.detalhes).replace(/[{}"]/g, ' ').replace(/,/g, ', ');
                }
                
                html += `<div class="historico-item">
                    <div class="historico-header">
                        <span><i class="fas ${h.tipo === 'criacao_conta' ? 'fa-file-invoice-dollar' : h.tipo === 'pagamento_conta' ? 'fa-dollar-sign' : h.tipo === 'criacao_gasto' ? 'fa-shopping-bag' : h.tipo === 'criacao_evento' ? 'fa-calendar-plus' : h.tipo === 'criacao_lista' ? 'fa-shopping-cart' : h.tipo === 'criacao_giro' ? 'fa-hand-holding-usd' : h.tipo === 'edicao' ? 'fa-edit' : h.tipo === 'exclusao' ? 'fa-trash' : 'fa-history'}"></i> ${h.descricao}</span>
                        <span class="historico-data">${data}</span>
                    </div>
                    <div class="historico-descricao">${detalhes}</div>
                    <div class="historico-usuario">${h.usuario || 'desconhecido'}</div>
                </div>`;
            });
            html += '</div>';
            abrirModal('√öltimas A√ß√µes (100)', 'fa-history', html);
        }

        function abrirManual() {
            let conteudo = `
                <div style="padding:16px">
                    <h3 style="color:var(--purple);margin-bottom:16px">Manual de Instru√ß√µes - My Life</h3>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-calendar-day"></i> Bot√£o "Hoje"</h4>
                        <p>No menu superior, o bot√£o <strong>"Hoje"</strong> volta automaticamente para o m√™s atual e seleciona o dia de hoje.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-user"></i> Seu Nome (Usu√°rio)</h4>
                        <p>Clique no seu nome no menu superior para definir ou alterar seu nome. Este nome fica salvo apenas neste navegador e √© usado para registrar quem fez cada a√ß√£o.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-file-invoice-dollar"></i> Contas</h4>
                        <p><strong>Como criar:</strong> Clique no bot√£o + e selecione "Nova Conta". Preencha descri√ß√£o, valor, frequ√™ncia e dia do vencimento.</p>
                        <p><strong>Como pagar:</strong> Na lista de contas, clique no bot√£o verde "$". O valor ser√° debitado do saldo central automaticamente.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-calendar-alt"></i> Eventos</h4>
                        <p>Clique no bot√£o + e selecione "Novo Evento". Escolha t√≠tulo, frequ√™ncia, data de in√≠cio e √≠cones coloridos para personalizar.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-wallet"></i> Saldo e Gastos</h4>
                        <p><strong>Saldo:</strong> Acesse a √°rea de Saldos clicando no valor no menu superior. Voc√™ pode adicionar, retirar ou atualizar o saldo diretamente.</p>
                        <p><strong>Gastos:</strong> No bot√£o "Gastos" na barra inferior, registre seus gastos di√°rios com categorias. Eles s√£o automaticamente debitados do saldo central.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-hand-holding-usd"></i> Giros (Empr√©stimos)</h4>
                        <p>Use para controlar empr√©stimos com amigos. Registre o valor inicial e a pessoa. Depois, registre pagamentos ou recebimentos.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-shopping-cart"></i> Lista de Compras</h4>
                        <p>Lista simples para controle de compras. Marque os itens como comprados quando pegar no mercado.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-chart-line"></i> Relat√≥rio</h4>
                        <p>No menu lateral, acesse "Relat√≥rio" para ver um resumo financeiro do m√™s atual com gr√°ficos de barras.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-bell"></i> Notifica√ß√µes</h4>
                        <p>Configure notifica√ß√µes para ser lembrado de contas a vencer e eventos.</p>
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:var(--purple-dark);margin-bottom:8px"><i class="fas fa-file-contract"></i> Pol√≠ticas e Termos</h4>
                        <p>No menu lateral, acesse "Pol√≠ticas e Termos" para visualizar os termos de uso e pol√≠ticas do aplicativo.</p>
                    </div>
                    
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            `;
            abrirModal('Manual de Instru√ß√µes', 'fa-book', conteudo);
        }

        function abrirNovoGasto() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let categoriasHtml = CONFIG.categoriasGastos.map(c => 
                `<option value="${c.id}">${c.nome}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="gastoDescricao" class="form-input" placeholder="Ex: Compras mercado...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="gastoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-tag"></i> Categoria</label>
                    <select id="gastoCategoria" class="form-select" onchange="if(this.value==='outros') document.getElementById('gastoOutrosDiv').style.display='block'; else document.getElementById('gastoOutrosDiv').style.display='none'">
                        ${categoriasHtml}
                    </select>
                </div>
                <div id="gastoOutrosDiv" style="display:none" class="form-group">
                    <label class="form-label">Especifique a categoria</label>
                    <input type="text" id="gastoOutrosTexto" class="form-input" placeholder="Ex: Roupas, Presentes...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Dia</label>
                    <input type="number" id="gastoDia" class="form-input" min="1" max="31" value="${diaPadrao}" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> M√™s/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="gastoMes" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="gastoAno" class="form-input" value="${ano}" inputmode="numeric">
                    </div>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoGasto()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Gasto', 'fa-shopping-bag', conteudo);
        }

        async function salvarNovoGasto() {
            let desc = document.getElementById('gastoDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('gastoValor')?.value);
            let dia = parseInt(document.getElementById('gastoDia')?.value);
            let mes = parseInt(document.getElementById('gastoMes')?.value);
            let ano = parseInt(document.getElementById('gastoAno')?.value);
            let cat = document.getElementById('gastoCategoria')?.value;
            let catCustom = null;

            if (cat === 'outros') {
                catCustom = document.getElementById('gastoOutrosTexto')?.value.trim();
                if (!catCustom) {
                    showToast('Especifique a categoria', 'warning');
                    return;
                }
            }

            if (!desc || !valor || !dia || !mes || !ano) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            if (!dataValida(ano, mes, dia)) {
                showToast('Dia inv√°lido para o m√™s selecionado', 'warning');
                return;
            }

            let diaAjustado = dia;
            let data = dataParaString(ano, mes, diaAjustado);

            try {
                let gastoData = {
                    user_id: App.currentUser.id,
                    descricao: desc,
                    valor: valor,
                    categoria: cat || 'outros',
                    dia: diaAjustado,
                    mes: mes,
                    ano: ano,
                    data: data,
                    added_by: App.usuarioAtual || 'desconhecido'
                };
                if (cat === 'outros' && catCustom) gastoData.categoria_customizada = catCustom;

                await App.supabase.from('gastos').insert(gastoData);

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor - valor;
                        await App.supabase.from('saldos').update({ valor: novoValor, data: new Date().toISOString() }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                verificarNotificacoes({ descricao: desc, valor }, 'gastos');
                await registrarHistorico('criacao_gasto', `Gasto: ${desc}`, { desc, valor, cat, usuario: App.usuarioAtual });
                showToast('Gasto registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarGasto(id) {
            let gasto = App.dataCache.gastos.find(g => g.id === id);
            if (!gasto) return;
            
            let categoriasHtml = CONFIG.categoriasGastos.map(c => 
                `<option value="${c.id}" ${gasto.categoria === c.id ? 'selected' : ''}>${c.nome}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="gastoDescricaoEdit" class="form-input" value="${gasto.descricao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="gastoValorEdit" class="form-input" value="${gasto.valor.toFixed(2).replace('.', ',')}" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-tag"></i> Categoria</label>
                    <select id="gastoCategoriaEdit" class="form-select">
                        ${categoriasHtml}
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoGasto('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Gasto', 'fa-edit', conteudo);
        }

        async function salvarEdicaoGasto(id) {
            let desc = document.getElementById('gastoDescricaoEdit')?.value.trim();
            let valor = parseCurrency(document.getElementById('gastoValorEdit')?.value);
            let cat = document.getElementById('gastoCategoriaEdit')?.value;

            if (!desc || !valor) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('gastos').delete().eq('id', id);
                
                let gastoAntigo = App.dataCache.gastos.find(g => g.id === id);
                if (gastoAntigo && App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor + gastoAntigo.valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                let { mes, ano } = getMesAnoAtual();
                let data = dataParaString(ano, mes, new Date().getDate());
                await App.supabase.from('gastos').insert({
                    user_id: App.currentUser.id,
                    descricao: desc,
                    valor: valor,
                    categoria: cat,
                    dia: new Date().getDate(),
                    mes: mes,
                    ano: ano,
                    data: data,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor - valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('edicao_gasto', `Gasto editado: ${desc}`, { id, usuario: App.usuarioAtual });
                showToast('Gasto atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoItemLista() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-sort-numeric-up"></i> Quantidade</label>
                    <input type="number" id="itemQuantidade" class="form-input" min="1" value="1" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="itemDescricao" class="form-input" placeholder="Ex: Arroz, Feij√£o...">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoItemLista()" style="flex:2"><i class="fas fa-save"></i> Adicionar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Item na Lista', 'fa-shopping-cart', conteudo);
        }

        async function salvarNovoItemLista() {
            let qtd = parseInt(document.getElementById('itemQuantidade')?.value);
            let desc = document.getElementById('itemDescricao')?.value.trim();

            if (!qtd || !desc) {
                showToast('Preencha quantidade e descri√ß√£o', 'warning');
                return;
            }

            try {
                await App.supabase.from('lista_compras').insert({
                    user_id: App.currentUser.id,
                    quantidade: qtd,
                    descricao: desc,
                    comprado: false,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                verificarNotificacoes({ descricao: desc }, 'lista');
                await registrarHistorico('criacao_lista', `Item adicionado: ${desc}`, { qtd, desc, usuario: App.usuarioAtual });
                showToast('Item adicionado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function alternarComprado(id) {
            (async () => {
                try {
                    let item = App.dataCache.lista.find(i => i.id === id);
                    if (item) {
                        await App.supabase.from('lista_compras').update({
                            comprado: !item.comprado
                        }).eq('id', id);

                        await registrarHistorico('alternar_lista', `Item ${item.comprado ? 'desmarcado' : 'marcado'}: ${item.descricao}`, { id, usuario: App.usuarioAtual });
                        await carregarDados(true);
                        await mostrarConteudo();
                    }
                } catch (error) {
                    console.error('Erro ao alternar item:', error);
                    showToast('Erro: ' + error.message, 'error');
                }
            })();
        }

        function deletarItemLista(id) {
            if (confirm('Remover item da lista?')) {
                (async () => {
                    try {
                        await App.supabase.from('lista_compras').delete().eq('id', id);
                        await registrarHistorico('exclusao_lista', `Item removido da lista`, { id, usuario: App.usuarioAtual });
                        showToast('Item removido!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao remover item:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function abrirNovoGiro() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="giroDescricao" class="form-input" placeholder="Ex: Empr√©stimo para Jo√£o">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor Inicial</label>
                    <input type="text" id="giroValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Pessoa</label>
                    <input type="text" id="giroPessoa" class="form-input" placeholder="Nome da pessoa">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoGiro()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Giro', 'fa-hand-holding-usd', conteudo);
        }

        async function salvarNovoGiro() {
            let desc = document.getElementById('giroDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('giroValor')?.value);
            let pessoa = document.getElementById('giroPessoa')?.value.trim();

            if (!desc || !valor || !pessoa) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('giros').insert({
                    user_id: App.currentUser.id,
                    descricao: desc,
                    valor_inicial: valor,
                    pessoa: pessoa,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('criacao_giro', `Giro criado: ${desc}`, { desc, valor, pessoa, usuario: App.usuarioAtual });
                showToast('Giro salvo!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar giro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirPagamentoGiro(id, desc) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor do Pagamento</label>
                    <input type="text" id="pagamentoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descri√ß√£o (opcional)</label>
                    <input type="text" id="pagamentoDescricao" class="form-input" placeholder="Ex: Parcela 1">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-success" onclick="salvarPagamentoGiro('${id}','${desc}')" style="flex:2"><i class="fas fa-check"></i> Confirmar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal(`Pagar ${desc}`, 'fa-arrow-down', conteudo);
        }

        async function salvarPagamentoGiro(id, desc) {
            let valor = parseCurrency(document.getElementById('pagamentoValor')?.value);
            let descricao = document.getElementById('pagamentoDescricao')?.value.trim();

            if (!valor) {
                showToast('Digite o valor', 'warning');
                return;
            }

            try {
                await App.supabase.from('movimentacoes_giro').insert({
                    user_id: App.currentUser.id,
                    giro_id: id,
                    tipo: 'pagamento',
                    valor: valor,
                    descricao: descricao || `Pagamento para ${desc}`,
                    data: new Date().toISOString(),
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('pagamento_giro', `Pagamento de ${formatCurrency(valor)} para ${desc}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Pagamento registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao registrar pagamento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirRecebimentoGiro(id, desc) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor do Recebimento</label>
                    <input type="text" id="recebimentoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descri√ß√£o (opcional)</label>
                    <input type="text" id="recebimentoDescricao" class="form-input" placeholder="Ex: Parcela 1">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-warning" onclick="salvarRecebimentoGiro('${id}','${desc}')" style="flex:2"><i class="fas fa-check"></i> Confirmar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal(`Receber ${desc}`, 'fa-arrow-up', conteudo);
        }

        async function salvarRecebimentoGiro(id, desc) {
            let valor = parseCurrency(document.getElementById('recebimentoValor')?.value);
            let descricao = document.getElementById('recebimentoDescricao')?.value.trim();

            if (!valor) {
                showToast('Digite o valor', 'warning');
                return;
            }

            try {
                await App.supabase.from('movimentacoes_giro').insert({
                    user_id: App.currentUser.id,
                    giro_id: id,
                    tipo: 'recebimento',
                    valor: valor,
                    descricao: descricao || `Recebimento de ${desc}`,
                    data: new Date().toISOString(),
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('recebimento_giro', `Recebimento de ${formatCurrency(valor)} de ${desc}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Recebimento registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao registrar recebimento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarGiro(id) {
            let giro = App.dataCache.giros.find(g => g.id === id);
            if (!giro) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descri√ß√£o</label>
                    <input type="text" id="giroDescricaoEdit" class="form-input" value="${giro.descricao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Pessoa</label>
                    <input type="text" id="giroPessoaEdit" class="form-input" value="${giro.pessoa || ''}">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoGiro('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Giro', 'fa-edit', conteudo);
        }

        async function salvarEdicaoGiro(id) {
            let desc = document.getElementById('giroDescricaoEdit')?.value.trim();
            let pessoa = document.getElementById('giroPessoaEdit')?.value.trim();

            if (!desc || !pessoa) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('giros').update({
                    descricao: desc,
                    pessoa: pessoa
                }).eq('id', id);

                await registrarHistorico('edicao_giro', `Giro editado: ${desc}`, { id, usuario: App.usuarioAtual });
                showToast('Giro atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar giro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function deletarGiro(id) {
            if (confirm('Tem certeza que deseja excluir este giro?')) {
                (async () => {
                    try {
                        await App.supabase.from('movimentacoes_giro').delete().eq('giro_id', id);
                        await App.supabase.from('giros').delete().eq('id', id);
                        await registrarHistorico('exclusao_giro', `Giro exclu√≠do`, { id, usuario: App.usuarioAtual });
                        showToast('Giro exclu√≠do!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir giro:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function abrirAdicionarValorSaldo(id) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor para Adicionar</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-success" onclick="confirmarAdicionarSaldo('${id}')" style="flex:2"><i class="fas fa-plus"></i> Adicionar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Adicionar ao Saldo', 'fa-plus-circle', conteudo);
        }

        async function confirmarAdicionarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (!valor) {
                showToast('Digite um valor', 'warning');
                return;
            }

            try {
                let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', id).single();
                if (saldoAtual) {
                    let novoValor = saldoAtual.valor + valor;
                    await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', id);
                    if (id === App.saldoCentral.id) {
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('adicao_saldo', `Adicionado ${formatCurrency(valor)} ao saldo`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao adicionar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirRetirarValorSaldo(id) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor para Retirar</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-warning" onclick="confirmarRetirarSaldo('${id}')" style="flex:2"><i class="fas fa-minus"></i> Retirar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Retirar do Saldo', 'fa-minus-circle', conteudo);
        }

        async function confirmarRetirarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (!valor) {
                showToast('Digite um valor', 'warning');
                return;
            }

            try {
                let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', id).single();
                if (saldoAtual) {
                    let novoValor = saldoAtual.valor - valor;
                    await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', id);
                    if (id === App.saldoCentral.id) {
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('retirada_saldo', `Retirado ${formatCurrency(valor)} do saldo`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao retirar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirBalancoSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let conteudo = `
                <div style="padding:16px">
                    <p>O valor que voc√™ inserir ir√° substituir o valor de saldo atual.</p>
                    <p>Ao clicar em salvar, o saldo atual ficar√° sendo o que voc√™ digitou.</p>
                    
                    <div class="form-group" style="margin:20px 0">
                        <label class="form-label"><i class="fas fa-dollar-sign"></i> Novo Valor</label>
                        <input type="text" id="saldoValor" class="form-input" value="${saldo.valor.toFixed(2).replace('.', ',')}" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="confirmarBalancoSaldo('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar Balan√ßo</button>
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Balan√ßo do Saldo', 'fa-balance-scale', conteudo);
        }

        async function confirmarBalancoSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (valor === undefined) {
                showToast('Digite um valor v√°lido', 'warning');
                return;
            }

            try {
                await App.supabase.from('saldos').update({ valor: valor }).eq('id', id);
                if (id === App.saldoCentral.id) {
                    App.saldoCentral.valor = valor;
                    atualizarSaldoHeader();
                }

                await registrarHistorico('atualizacao_saldo', `Balan√ßo atualizado para ${formatCurrency(valor)}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Balan√ßo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao atualizar balan√ßo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirAtualizarValorSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Novo Valor</label>
                    <input type="text" id="saldoValor" class="form-input" value="${saldo.valor.toFixed(2).replace('.', ',')}" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="confirmarAtualizarSaldo('${id}')" style="flex:2"><i class="fas fa-save"></i> Atualizar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Atualizar Saldo', 'fa-sync-alt', conteudo);
        }

        async function confirmarAtualizarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (valor === undefined) {
                showToast('Digite um valor v√°lido', 'warning');
                return;
            }

            try {
                await App.supabase.from('saldos').update({ valor: valor }).eq('id', id);
                if (id === App.saldoCentral.id) {
                    App.saldoCentral.valor = valor;
                    atualizarSaldoHeader();
                }

                await registrarHistorico('atualizacao_saldo', `Saldo atualizado para ${formatCurrency(valor)}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao atualizar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Nome do Saldo</label>
                    <input type="text" id="saldoNomeEdit" class="form-input" value="${saldo.nome || ''}">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoSaldo('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Saldo', 'fa-edit', conteudo);
        }

        async function salvarEdicaoSaldo(id) {
            let nome = document.getElementById('saldoNomeEdit')?.value.trim();

            try {
                await App.supabase.from('saldos').update({ nome: nome }).eq('id', id);
                await registrarHistorico('edicao_saldo', `Saldo renomeado para ${nome}`, { id, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function deletarSaldo(id) {
            if (confirm('Tem certeza que deseja excluir este saldo?')) {
                (async () => {
                    try {
                        await App.supabase.from('saldos').delete().eq('id', id);
                        await registrarHistorico('exclusao_saldo', `Saldo exclu√≠do`, { id, usuario: App.usuarioAtual });
                        showToast('Saldo exclu√≠do!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir saldo:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function abrirNovoSaldo() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Nome do Saldo</label>
                    <input type="text" id="saldoNome" class="form-input" placeholder="Ex: Poupan√ßa, Carteira...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor Inicial</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" inputmode="decimal" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-check-circle"></i> Saldo Central?</label>
                    <select id="saldoCentral" class="form-select">
                        <option value="false">N√£o</option>
                        <option value="true">Sim</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoSaldo()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Saldo', 'fa-wallet', conteudo);
        }

        async function salvarNovoSaldo() {
            let nome = document.getElementById('saldoNome')?.value.trim();
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            let isCentral = document.getElementById('saldoCentral')?.value === 'true';

            if (!nome || !valor) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                if (isCentral) {
                    let centralExistente = App.dataCache.saldos.find(s => s.is_central);
                    if (centralExistente) {
                        showToast('J√° existe um saldo central', 'warning');
                        return;
                    }
                }

                await App.supabase.from('saldos').insert({
                    user_id: App.currentUser.id,
                    nome: nome,
                    valor: valor,
                    is_central: isCentral,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('criacao_saldo', `Saldo criado: ${nome}`, { nome, valor, isCentral, usuario: App.usuarioAtual });
                showToast('Saldo criado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao criar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirExtratoSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let sessentaDiasAtras = new Date();
            sessentaDiasAtras.setDate(sessentaDiasAtras.getDate() - 60);
            sessentaDiasAtras.setHours(0, 0, 0, 0);

            let movimentacoes = [];

            App.dataCache.contas.forEach(c => {
                if (c.data_pagamento) {
                    let dataPag = new Date(c.data_pagamento);
                    if (dataPag >= sessentaDiasAtras) {
                        movimentacoes.push({
                            data: c.data_pagamento,
                            tipo: 'pagamento_conta',
                            descricao: `Pagamento: ${c.descricao}`,
                            valor: -c.valor_pago,
                            usuario: c.added_by || 'desconhecido'
                        });
                    }
                }
            });

            App.dataCache.gastos.forEach(g => {
                let dataGasto = new Date(g.ano, g.mes - 1, g.dia, 12, 0, 0);
                if (dataGasto >= sessentaDiasAtras) {
                    movimentacoes.push({
                        data: dataGasto,
                        tipo: 'gasto',
                        descricao: `Gasto: ${g.descricao}`,
                        valor: -g.valor,
                        usuario: g.added_by || 'desconhecido'
                    });
                }
            });

            App.dataCache.historico.forEach(h => {
                let dataHist = new Date(h.data);
                if (dataHist >= sessentaDiasAtras && h.tipo && h.tipo.includes('saldo')) {
                    movimentacoes.push({
                        data: dataHist,
                        tipo: h.tipo,
                        descricao: h.descricao,
                        valor: h.valor || 0,
                        usuario: h.usuario || 'desconhecido'
                    });
                }
            });

            movimentacoes.sort((a, b) => new Date(b.data) - new Date(a.data));

            if (movimentacoes.length === 0) {
                abrirModal(`Extrato de ${saldo.nome || 'Saldo'}`, 'fa-history', '<div class="empty-state"><p>Nenhuma movimenta√ß√£o nos √∫ltimos 60 dias</p></div>');
                return;
            }

            let html = `<div class="items-list">`;
            movimentacoes.forEach(m => {
                let data = new Date(m.data).toLocaleDateString('pt-BR');
                let classe = m.valor < 0 ? 'extrato-tipo pagamento' : m.valor > 0 ? 'extrato-tipo recebimento' : '';
                html += `<div class="extrato-item">
                    <div class="extrato-header">
                        <span>${data}</span>
                        <span class="${classe}">${m.valor !== 0 ? formatCurrency(Math.abs(m.valor)) : ''}</span>
                    </div>
                    <div class="extrato-detalhes">${m.descricao}</div>
                    <div style="font-size:0.8em; color:var(--gray)">${m.usuario}</div>
                </div>`;
            });
            html += '</div>';
            abrirModal(`Extrato de ${saldo.nome || 'Saldo'} (60 dias)`, 'fa-history', html);
        }

        function resetarParaHoje() {
            let hoje = new Date();
            App.currentMonthOffset = 0;
            App.selectedDay = hoje.getDate();
            App.activeFilters = { contas: true, eventos: true };
            App.currentFilter = 'all';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                let filter = btn.dataset.filter;
                if (filter === 'contas' || filter === 'eventos') {
                    btn.classList.toggle('active', App.activeFilters[filter]);
                }
            });
            
            atualizarCalendario();
            mostrarConteudo();
        }

        function abrirSideMenu() {
            document.getElementById('sideMenu').classList.add('open');
            document.getElementById('sideMenuOverlay').classList.add('open');
        }

        function fecharSideMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('sideMenuOverlay').classList.remove('open');
        }

        function fecharAddMenu() {
            document.getElementById('addOptionsMenu').classList.remove('show');
            document.getElementById('navAdd').classList.remove('active');
        }

        function carregarConfigLocal() {
            if (!App.currentUser) return;
            const key = `mylife_config_${App.currentUser.id}`;
            try {
                const config = JSON.parse(localStorage.getItem(key) || '{}');
                App.notificacoesConfig = {
                    ...App.notificacoesConfig,
                    ...config.notificacoes
                };
                if (config.acessoNovaSenha) App.acessoNovaSenha = config.acessoNovaSenha;
                if (config.exibirSaldoHeader !== undefined) App.exibirSaldoHeader = config.exibirSaldoHeader;
            } catch (e) { }
        }

        function salvarConfigLocal() {
            if (!App.currentUser) return;
            const key = `mylife_config_${App.currentUser.id}`;
            localStorage.setItem(key, JSON.stringify({
                notificacoes: App.notificacoesConfig,
                acessoNovaSenha: App.acessoNovaSenha,
                exibirSaldoHeader: App.exibirSaldoHeader
            }));
        }

        function abrirModal(titulo, icone, conteudo) {
            let modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title"><i class="fas ${icone}"></i> ${titulo}</div>
                    <button class="close-modal" onclick="fecharModal()">&times;</button>
                </div>
                <div class="modal-body">${conteudo}</div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
            App.modalHasChanges = false;
        }

        function fecharModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            App.modalHasChanges = false;
        }

        async function init() {
            try {
                App.supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                let { data: { session } } = await App.supabase.auth.getSession();

                await inicializarNotificacoes();

                if (session) {
                    App.currentUser = session.user;
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';

                    carregarUsuarioLocal();
                    carregarConfigLocal();

                    const cacheLoaded = await carregarDadosDoCache();
                    
                    if (cacheLoaded) {
                        let hoje = new Date();
                        App.currentMonthOffset = 0;
                        App.selectedDay = hoje.getDate();
                        App.currentFilter = 'all';
                        App.activeFilters = { contas: true, eventos: true };

                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            let filter = btn.dataset.filter;
                            if (filter === 'contas' || filter === 'eventos') {
                                btn.classList.toggle('active', App.activeFilters[filter]);
                            }
                        });

                        await atualizarCalendario();
                        await mostrarConteudo();
                        
                        carregarDados(true);
                    } else {
                        await carregarDados(true);

                        let hoje = new Date();
                        App.currentMonthOffset = 0;
                        App.selectedDay = hoje.getDate();
                        App.currentFilter = 'all';
                        App.activeFilters = { contas: true, eventos: true };

                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            let filter = btn.dataset.filter;
                            if (filter === 'contas' || filter === 'eventos') {
                                btn.classList.toggle('active', App.activeFilters[filter]);
                            }
                        });

                        await atualizarCalendario();
                        await mostrarConteudo();
                    }
                } else {
                    document.getElementById('authContainer').style.display = 'flex';
                }

                document.getElementById('btnLogin').addEventListener('click', async () => {
                    let email = document.getElementById('loginEmail').value.trim();
                    let pass = document.getElementById('loginPassword').value;

                    if (!email || !pass) {
                        showToast('Preencha email e senha', 'warning');
                        return;
                    }

                    try {
                        let { data, error } = await App.supabase.auth.signInWithPassword({ email, password: pass });
                        if (error) showToast(error.message, 'error');
                        else {
                            App.currentUser = data.user;
                            document.getElementById('authContainer').style.display = 'none';
                            document.getElementById('mainContainer').style.display = 'block';
                            carregarUsuarioLocal();
                            carregarConfigLocal();
                            await carregarDados(true);
                            resetarParaHoje();
                            showToast('Login realizado!', 'success');
                        }
                    } catch (e) {
                        showToast('Erro no login', 'error');
                    }
                });

                document.getElementById('btnRegister').addEventListener('click', async () => {
                    let email = document.getElementById('registerEmail').value.trim();
                    let pass = document.getElementById('registerPassword').value;
                    let nome = document.getElementById('registerName').value.trim();

                    if (!email || !pass) {
                        showToast('Preencha email e senha', 'warning');
                        return;
                    }
                    if (pass.length < 6) {
                        showToast('Senha m√≠nimo 6 caracteres', 'warning');
                        return;
                    }

                    try {
                        let { data, error } = await App.supabase.auth.signUp({ email, password: pass });
                        if (error) showToast(error.message, 'error');
                        else {
                            if (data.user) {
                                await criarTrialParaNovoUsuario(data.user.id);
                                if (nome) {
                                    App.usuarioAtual = nome;
                                    salvarUsuarioLocal(nome);
                                }
                            }
                            showToast('Conta criada! Voc√™ tem 30 dias gr√°tis.', 'success');
                            document.getElementById('registerForm').style.display = 'none';
                            document.getElementById('loginForm').style.display = 'block';
                        }
                    } catch (e) {
                        showToast('Erro no registro', 'error');
                    }
                });

                document.getElementById('btnLogout').addEventListener('click', () => {
                    if (confirm('Deseja realmente sair?')) {
                        App.supabase.auth.signOut();
                        App.currentUser = null;
                        App.usuarioAtual = null;
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('mainContainer').style.display = 'none';
                    }
                });

                document.getElementById('linkRegister').addEventListener('click', () => {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'block';
                });

                document.getElementById('linkLogin').addEventListener('click', () => {
                    document.getElementById('registerForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                });

                document.getElementById('btnToday').addEventListener('click', resetarParaHoje);

                document.getElementById('btnPrevMonth').addEventListener('click', () => {
                    App.currentMonthOffset--;
                    App.selectedDay = null;
                    atualizarCalendario();
                    mostrarConteudo();
                });

                document.getElementById('btnNextMonth').addEventListener('click', () => {
                    App.currentMonthOffset++;
                    App.selectedDay = null;
                    atualizarCalendario();
                    mostrarConteudo();
                });

                document.getElementById('btnSaldoHeader').addEventListener('click', () => {
                    App.currentFilter = 'saldos';
                    mostrarConteudo();
                });

                document.getElementById('btnUsuarioHeader').addEventListener('click', verificarUsuario);

                document.getElementById('navMenu').addEventListener('click', abrirSideMenu);
                document.getElementById('sideMenuOverlay').addEventListener('click', fecharSideMenu);

                document.getElementById('navAdd').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('addOptionsMenu').classList.toggle('show');
                    document.getElementById('navAdd').classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!document.getElementById('navAdd').contains(e.target) && !document.getElementById('addOptionsMenu').contains(e.target)) {
                        fecharAddMenu();
                    }
                });

                document.getElementById('navLista').addEventListener('click', () => {
                    App.currentFilter = 'lista';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.getElementById('navGastos').addEventListener('click', () => {
                    App.currentFilter = 'gastos';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.getElementById('navSaldos').addEventListener('click', () => {
                    App.currentFilter = 'saldos';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.getElementById('navGiros').addEventListener('click', () => {
                    App.currentFilter = 'giros';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        let filter = this.dataset.filter;
                        if (filter === 'contas' || filter === 'eventos') {
                            App.activeFilters[filter] = !App.activeFilters[filter];
                            this.classList.toggle('active', App.activeFilters[filter]);
                            mostrarConteudo();
                        }
                    });
                });

                document.getElementById('modalOverlay').addEventListener('click', e => {
                    if (e.target === e.currentTarget) fecharModal();
                });

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showToast('Erro ao iniciar: ' + error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
