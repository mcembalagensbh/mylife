<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=yes">
    <title>Home Life - Gestor Doméstico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --primary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --success: #2ecc71;
            --border: #dfe6e9;
            --love: #e84393;
            --star: #ffd700;
            --heart: #e84393;
            --event-yellow: #e67e22;
            --gasto: #9b59b6;
            --report: #1abc9c;
            --calendar: #e74c3c;
            --purple: #9b59b6;
            --purple-light: #d7bde2;
            --purple-dark: #8e44ad;
            --bg-vencida: #ffe6e6;
            --bg-pendente: #e8f5e8;
            --bg-evento: #fff9e6;
            --bg-amor: #ffe6f2;
            --bg-gasto: #f2e6ff;
            --rotina: #3498db;
            --medico: #2c3e50;
            --bg-pago: #f0f0f0;
            --text-pago: #7f8c8d;
            --semanal: #16a085;
            --anual: #d35400;
            --bg-success-light: #d4edda;
            --text-success: #155724;
            --bg-danger-light: #f8d7da;
            --text-danger: #721c24;
            --bg-warning-light: #fff3cd;
            --text-warning: #856404;
            --green-dark: #2e7d32
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            color: var(--dark);
            line-height: 1.4;
            font-size: 14px;
            overflow-x: hidden;
            padding-bottom: 70px
        }

        #authContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000
        }

        .auth-box {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
            width: 90%;
            max-width: 350px
        }

        .auth-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--purple-dark);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        .form-group {
            margin-bottom: 16px
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color .2s;
            background: #fff
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 0;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(155, 89, 182, .1)
        }

        .btn {
            padding: 10px 16px;
            border: 0;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .2s;
            font-size: 14px;
            min-height: 44px
        }

        .btn:hover {
            opacity: .9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: #fff
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: #fff
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: #fff
        }

        .btn-love {
            background: linear-gradient(135deg, var(--love), #fd79a8);
            color: #fff
        }

        .btn-gasto {
            background: linear-gradient(135deg, var(--gasto), var(--purple-dark));
            color: #fff
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 36px
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            color: var(--gray);
            font-size: 13px
        }

        .auth-link {
            color: var(--purple);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer
        }

        #mainContainer {
            display: none
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 0 8px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
            height: 56px
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            gap: 4px
        }

        .header h1 {
            font-size: clamp(0.9rem, 4vw, 1.1rem);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 110px
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 1;
            min-width: 0
        }

        .header-today-btn {
            background: rgba(255, 255, 255, .2);
            color: #fff;
            border: 0;
            border-radius: 16px;
            padding: 4px 8px;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
            cursor: pointer;
            white-space: nowrap
        }

        .saldo-header {
            background: rgba(255, 255, 255, .15);
            color: #fff;
            border: 0;
            border-radius: 20px;
            padding: 4px 8px;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0
        }

        .usuario-header {
            background: var(--purple-dark);
            color: #fff;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .header-btn {
            background: rgba(255, 255, 255, .15);
            color: #fff;
            border: 0;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0
        }

        .calendar-section {
            background: #fff;
            padding: 10px;
            margin: 6px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1em;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff;
            padding: 4px 12px;
            border-radius: 16px;
            cursor: pointer
        }

        .calendar-nav button {
            background: 0 0;
            border: 0;
            color: var(--purple);
            font-size: 1.1em;
            cursor: pointer;
            padding: 2px 6px
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            min-height: 280px
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 3px 2px;
            color: var(--gray);
            font-size: .8em;
            background: #f8f9fa;
            border-radius: 3px
        }

        .calendar-day {
            padding: 3px 2px;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            min-height: 38px;
            display: flex;
            flex-direction: column;
            background: #fff;
            font-size: 11px
        }

        .calendar-day:hover {
            background: #f8f9fa
        }

        .calendar-day.today {
            background: linear-gradient(135deg, var(--purple-light), var(--purple)) !important;
            color: #fff !important
        }

        .calendar-day.today .day-number {
            color: #fff !important
        }

        .calendar-day.selected {
            border: 2px solid var(--warning)
        }

        .day-number {
            font-weight: 600;
            text-align: left;
            margin-bottom: 2px;
            font-size: 11px;
            padding-left: 2px
        }

        .calendar-events-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: auto;
            width: 100%
        }

        .contas-badges-line {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: flex-end;
            align-items: center;
            position: absolute;
            top: 2px;
            right: 2px
        }

        .eventos-emojis-line {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            line-height: 1;
            margin-top: 12px
        }

        .event-emoji-calendar {
            font-size: 1.1em;
            margin: 0 1px
        }

        .day-badge {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: .7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .2)
        }

        .badge-conta {
            background: var(--success)
        }

        .badge-conta-vencida {
            background: var(--danger)
        }

        .badge-evento {
            background: var(--warning)
        }

        .badge-amor {
            background: var(--love)
        }

        .badge-rotina {
            background: var(--rotina)
        }

        .badge-medico {
            background: var(--medico)
        }

        .filters {
            background: #fff;
            padding: 10px;
            margin: 6px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px
        }

        .filter-btn {
            padding: 12px 4px;
            border: 2px solid #e8e8e8;
            background: #fafafa;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-size: 13px;
            min-height: 60px;
            transition: all 0.2s
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: #fff;
            border-color: var(--purple-dark);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3)
        }

        .filter-btn i {
            font-size: 18px
        }

        .content-area {
            padding: 6px;
            max-width: 1200px;
            margin: 0 auto
        }

        .filter-info {
            margin-bottom: 10px;
            color: var(--purple);
            font-weight: 600;
            font-size: 13px;
            padding: 8px 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08)
        }

        .items-list {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            overflow: hidden
        }

        .item-card {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-left: 3px solid var(--purple);
            min-height: 52px;
            transition: all 0.2s
        }

        .item-card.vencida {
            border-left-color: var(--danger);
            background-color: var(--bg-vencida)
        }

        .item-card.pendente {
            border-left-color: var(--success);
            background-color: var(--bg-pendente)
        }

        .item-card.paga {
            border-left-color: var(--gray);
            background-color: var(--bg-pago);
            color: var(--text-pago);
            opacity: .7
        }

        .item-card.paga .item-title {
            text-decoration: line-through
        }

        .item-card.gasto {
            border-left-color: var(--gasto);
            background-color: var(--bg-gasto)
        }

        .item-card.evento {
            border-left-color: var(--warning);
            background-color: var(--bg-evento)
        }

        .item-card.giro {
            border-left-color: var(--success);
            background-color: var(--bg-pendente)
        }

        .item-info {
            flex: 1;
            min-width: 0
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--purple);
            flex-wrap: wrap
        }

        .item-details {
            font-size: .8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--gray)
        }

        .item-value {
            font-weight: 600;
            font-size: 1.1em;
            margin-left: 6px;
            white-space: nowrap;
            color: var(--purple)
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-left: 6px;
            flex-shrink: 0
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 0;
            color: #fff;
            font-size: .8em;
            transition: all 0.2s
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2)
        }

        .action-btn.edit {
            background: var(--purple)
        }

        .action-btn.delete {
            background: var(--danger)
        }

        .action-btn.pay {
            background: var(--success)
        }

        .action-btn.update {
            background: var(--warning)
        }

        .action-btn.undo {
            background: var(--warning)
        }

        .item-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: .7em;
            font-weight: 700;
            background: #e8e0f5;
            color: var(--purple);
            white-space: nowrap
        }

        .badge-recorrente {
            background: var(--purple-light);
            color: var(--purple-dark)
        }

        .section-divider {
            background: #f8f9fa;
            padding: 8px 12px;
            margin: 12px 0 6px;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 1px solid #eee;
            font-size: .85em
        }

        .loading-spinner {
            text-align: center;
            padding: 30px;
            color: var(--gray)
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--gray);
            background: #fff;
            border-radius: 8px
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px)
        }

        .modal-content {
            background: #fff;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15)
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10
        }

        .modal-title {
            font-size: 1.1em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--purple)
        }

        .close-modal {
            background: 0 0;
            border: 0;
            font-size: 1.6em;
            cursor: pointer;
            color: var(--gray);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: var(--danger)
        }

        .modal-body {
            padding: 20px
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .2);
            z-index: 2000;
            max-width: 90%;
            text-align: center
        }

        .toast.success {
            background: var(--success)
        }

        .toast.error {
            background: var(--danger)
        }

        .frequency-btn {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600
        }

        .frequency-btn.active {
            background: var(--purple);
            color: #fff
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px
        }

        .icon-option {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 24px
        }

        .icon-option:hover {
            background: #f0f0f0
        }

        .icon-option.selected {
            background: var(--purple-light);
            border-color: var(--purple)
        }

        .menu-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .menu-item i {
            color: var(--purple);
            font-size: 1.1em;
            width: 24px
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 8px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 998;
            color: #fff
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
            padding: 8px 0;
            transition: all 0.2s;
            border: none;
            background: transparent;
            position: relative
        }

        .nav-item i {
            font-size: 20px
        }

        .nav-item.active {
            color: #fff;
            transform: translateY(-2px)
        }

        .nav-add-btn {
            background: var(--green-dark) !important;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 28px !important;
            transition: all 0.3s ease;
            border: none !important
        }

        .nav-add-btn i {
            font-size: 28px !important;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3)
        }

        .nav-add-btn.active {
            transform: rotate(45deg) scale(0.95);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2)
        }

        .lista-badge {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: #fff;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border: 2px solid #fff;
            font-weight: 700
        }

        .add-options-menu {
            position: fixed;
            bottom: 80px;
            right: 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 12px;
            z-index: 999;
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px
        }

        .add-options-menu.show {
            display: flex
        }

        .add-option {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s
        }

        .add-option:hover {
            background: #f5f5f5
        }

        .add-option i {
            width: 24px;
            text-align: center;
            font-size: 18px
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #fff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto
        }

        .side-menu.open {
            left: 0
        }

        .side-menu-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .side-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.2s
        }

        .side-menu-item:hover {
            background: #f5f5f5
        }

        .side-menu-item i {
            color: var(--purple);
            width: 24px;
            font-size: 1.2em
        }

        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none
        }

        .side-menu-overlay.open {
            display: block
        }

        .delete-option {
            padding: 15px;
            margin: 5px 0;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer
        }

        .delete-option.selected {
            background: var(--purple-light)
        }

        .delete-option.warning {
            background: var(--bg-danger-light)
        }

        .date-range {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .date-range .form-group {
            flex: 1
        }

        .giro-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px
        }

        .giro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px
        }

        .giro-titulo {
            font-weight: 700;
            color: var(--purple);
            font-size: 1.1em
        }

        .giro-saldo {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--purple-dark)
        }

        .giro-historico {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            margin-top: 8px;
            padding-top: 8px;
            font-size: .9em
        }

        .giro-linha {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between
        }

        .usuario-badge {
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--purple-light);
            color: var(--purple-dark);
            font-size: .8em;
            margin-left: 5px
        }

        .notificacao-option {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px
        }

        .notificacao-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer
        }

        .exclusao-opcoes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0
        }

        .exclusao-opcao {
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s
        }

        .exclusao-opcao:hover {
            border-color: var(--purple);
            background: #f8f9fa
        }

        .exclusao-opcao.selected {
            border-color: var(--purple);
            background: var(--purple-light)
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="authContainer">
        <div class="auth-box">
            <h2 class="auth-title"><i class="fas fa-home"></i> Home Life</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Sua senha">
                </div>
                <button class="btn btn-primary" id="btnLogin" style="width:100%">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                <div class="auth-toggle">
                    Não tem conta? <a class="auth-link" id="linkRegister">Registrar</a>
                </div>
            </div>
            <div id="registerForm" style="display:none">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Nome</label>
                    <input type="text" id="registerName" class="form-input" placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="Mínimo 6 caracteres">
                </div>
                <button class="btn btn-success" id="btnRegister" style="width:100%">
                    <i class="fas fa-user-plus"></i> Criar Conta
                </button>
                <div class="auth-toggle">
                    Já tem conta? <a class="auth-link" id="linkLogin">Entrar</a>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContainer">
        <div class="side-menu-overlay" id="sideMenuOverlay"></div>
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header"><i class="fas fa-home"></i> Home Life</div>
            <div class="side-menu-item" onclick="abrirMenuRelatorio();fecharSideMenu()"><i class="fas fa-chart-line"></i> Relatório</div>
            <div class="side-menu-item" onclick="abrirMenuUsuarios();fecharSideMenu()"><i class="fas fa-users"></i> Usuários</div>
            <div class="side-menu-item" onclick="abrirNotificacoes();fecharSideMenu()"><i class="fas fa-bell"></i> Notificações</div>
            <div class="side-menu-item" onclick="abrirMenuSeguranca();fecharSideMenu()"><i class="fas fa-lock"></i> Segurança</div>
            <div class="side-menu-item" onclick="abrirManual();fecharSideMenu()"><i class="fas fa-book"></i> Manual</div>
        </div>

        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-home"></i> Home Life</h1>
                <div class="header-center">
                    <button class="header-today-btn" id="btnToday"><i class="fas fa-calendar-day"></i> Hoje</button>
                    <div class="saldo-header" id="btnSaldoHeader">
                        <i class="fas fa-wallet"></i><span id="saldoHeaderValue">R$ 0,00</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="usuario-header" id="btnUsuarioHeader" onclick="verificarUsuario()">
                        <i class="fas fa-user"></i><span id="usuarioHeaderNome">Selecionar</span>
                    </div>
                    <button class="header-btn" id="btnLogout" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>

        <div class="calendar-section">
            <div class="calendar-header">
                <div class="calendar-title" id="calendarTitle">Carregando...</div>
                <div class="calendar-nav">
                    <button id="btnPrevMonth"><i class="fas fa-chevron-left"></i></button>
                    <button id="btnNextMonth"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="filters">
            <div class="filter-buttons" id="filterButtons">
                <button class="filter-btn active" data-filter="contas"><i class="fas fa-file-invoice-dollar"></i><span>Contas</span></button>
                <button class="filter-btn active" data-filter="eventos"><i class="fas fa-calendar-alt"></i><span>Eventos</span></button>
            </div>
        </div>

        <div class="content-area">
            <div class="filter-info" id="filterInfo"></div>
            <div class="loading-spinner" id="loadingState" style="display:none">
                <i class="fas fa-spinner fa-spin"></i>
                <div>Carregando...</div>
            </div>
            <div id="contentArea">
                <div id="dynamicContent"></div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item" id="navMenu"><i class="fas fa-bars"></i><span>Menu</span></button>
            <button class="nav-item" id="navSaldos"><i class="fas fa-wallet"></i><span>Saldos</span></button>
            <button class="nav-item" id="navGastos"><i class="fas fa-shopping-bag"></i><span>Gastos</span></button>
            <button class="nav-item" id="navGiros"><i class="fas fa-hand-holding-usd"></i><span>Giros</span></button>
            <button class="nav-item" id="navLista"><i class="fas fa-shopping-cart"></i><span>Lista</span><span class="lista-badge" id="listaBadge" style="display:none">0</span></button>
            <button class="nav-item nav-add-btn" id="navAdd"><i class="fas fa-plus"></i></button>
        </div>

        <div class="add-options-menu" id="addOptionsMenu">
            <div class="add-option contas" onclick="verificarUsuarioAcao('conta')"><i class="fas fa-file-invoice-dollar"></i><span>Nova Conta</span></div>
            <div class="add-option eventos" onclick="verificarUsuarioAcao('evento')"><i class="fas fa-calendar-plus"></i><span>Novo Evento</span></div>
            <div class="add-option gastos" onclick="verificarUsuarioAcao('gasto')"><i class="fas fa-shopping-bag"></i><span>Novo Gasto</span></div>
            <div class="add-option lista" onclick="verificarUsuarioAcao('lista')"><i class="fas fa-shopping-cart"></i><span>Novo Item na Lista</span></div>
            <div class="add-option giro" onclick="verificarUsuarioAcao('giro')"><i class="fas fa-hand-holding-usd"></i><span>Novo Giro</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <div id="toast" class="toast" style="display:none"></div>

    <script>
        const CONFIG = {
            supabase: {
                url: 'https://rirvrrlgjetsgwhqqfvq.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcnZycmxnamV0c2d3aHFxZnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDM2MzgsImV4cCI6MjA4NjIxOTYzOH0.1T5eQnQXMCRqOSxtYFIHMedAF_D0Jo4Mg36LZHLJ2ds'
            },
            meses: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            diasSemana: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            categoriasGastos: [
                { id: 'mercado', nome: 'Mercado', icon: 'fa-shopping-cart' },
                { id: 'lazer', nome: 'Lazer', icon: 'fa-film' },
                { id: 'fastfood', nome: 'Fastfood', icon: 'fa-hamburger' },
                { id: 'medicos', nome: 'Médicos', icon: 'fa-user-md' },
                { id: 'emergencias', nome: 'Emergências', icon: 'fa-ambulance' },
                { id: 'oficina', nome: 'Oficina', icon: 'fa-car' },
                { id: 'outros', nome: 'Outros', icon: 'fa-ellipsis-h' }
            ],
            iconesEventos: [
                { nome: 'Estrela', icon: 'fa-star', cor: '#ffd700' },
                { nome: 'Coração', icon: 'fa-heart', cor: '#e84393' },
                { nome: 'Seta', icon: 'fa-redo', cor: '#3498db' },
                { nome: 'Médico', icon: 'fa-user-md', cor: '#e67e22' },
                { nome: 'Carro', icon: 'fa-car', cor: '#e67e22' },
                { nome: 'Avião', icon: 'fa-plane', cor: '#3498db' },
                { nome: 'Carrinho', icon: 'fa-shopping-cart', cor: '#9b59b6' },
                { nome: 'Bicicleta', icon: 'fa-bicycle', cor: '#e67e22' },
                { nome: 'Futebol', icon: 'fa-futbol', cor: '#2c3e50' },
                { nome: 'Peteca', icon: 'fa-feather-alt', cor: '#e74c3c' },
                { nome: 'Vôlei', icon: 'fa-volleyball-ball', cor: '#f39c12' },
                { nome: 'Aniversário', icon: 'fa-birthday-cake', cor: '#e84393' },
                { nome: 'Relógio', icon: 'fa-clock', cor: '#34495e' },
                { nome: 'Pizza', icon: 'fa-pizza-slice', cor: '#d35400' },
                { nome: 'Diamante', icon: 'fa-gem', cor: '#3498db' },
                { nome: 'Floco', icon: 'fa-snowflake', cor: '#3498db' },
                { nome: 'Remédio', icon: 'fa-capsules', cor: '#e74c3c' },
                { nome: 'Pasta', icon: 'fa-folder', cor: '#f39c12' },
                { nome: 'Coração Verde', icon: 'fa-heart', cor: '#2ecc71' },
                { nome: 'Coração Roxo', icon: 'fa-heart', cor: '#9b59b6' },
                { nome: 'Coração Azul', icon: 'fa-heart', cor: '#3498db' },
                { nome: 'Céu', icon: 'fa-cloud-sun', cor: '#3498db' },
                { nome: 'Montanha', icon: 'fa-mountain', cor: '#27ae60' },
                { nome: 'Sol', icon: 'fa-sun', cor: '#f39c12' },
                { nome: 'Lua', icon: 'fa-moon', cor: '#34495e' }
            ]
        };

        const App = {
            supabase: null,
            currentUser: null,
            currentMonthOffset: 0,
            activeFilters: { contas: true, eventos: true },
            selectedDay: null,
            selectedMonth: new Date().getMonth() + 1,
            selectedYear: new Date().getFullYear(),
            saldoSenha: '1234',
            saldoAutenticado: false,
            modalHasChanges: false,
            pendingDelete: null,
            saldoCentral: { id: null, valor: 0 },
            historicoAcoes: [],
            usuarios: [],
            usuarioAtual: null,
            notificacoesConfig: {},
            currentFilter: 'all',
            dataCache: {
                contas: [], regrasContas: [], eventos: [], eventosIndividuais: [], regrasEventos: [],
                gastos: [], lista: [], saldos: [], historico: [], excecoesRecorrencia: [],
                giros: [], movimentacoesGiro: [], usuariosCadastrados: []
            }
        };

        function showToast(m, t) {
            const to = document.getElementById('toast');
            to.textContent = m;
            to.className = `toast ${t}`;
            to.style.display = 'block';
            setTimeout(() => to.style.display = 'none', 3000);
        }

        function formatCurrency(v) {
            return 'R$ ' + (v || 0).toFixed(2).replace('.', ',');
        }

        function parseCurrency(v) {
            if (!v) return 0;
            if (typeof v === 'string') return parseFloat(v.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            return parseFloat(v) || 0;
        }

        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getNomeMes(num) {
            return CONFIG.meses[num - 1] || '';
        }

        function getMesAnoAtual() {
            const h = new Date();
            const d = new Date(h.getFullYear(), h.getMonth() + App.currentMonthOffset, 1);
            return { mes: d.getMonth() + 1, ano: d.getFullYear() };
        }

        function atualizarSaldoHeader() {
            document.getElementById('saldoHeaderValue').textContent = formatCurrency(App.saldoCentral.valor);
        }

        async function registrarHistorico(tipo, descricao, detalhes) {
            if (!App.currentUser) return;
            try {
                await App.supabase.from('historico_acoes').insert({
                    user_id: App.currentUser.id,
                    tipo,
                    descricao,
                    detalhes: JSON.stringify(detalhes),
                    data: new Date().toISOString(),
                    usuario: App.usuarioAtual || 'desconhecido'
                });
            } catch (e) { }
        }

        async function carregarUsuariosCadastrados() {
            if (!App.currentUser) return;
            try {
                const { data, error } = await App.supabase
                    .from('usuarios_cadastrados')
                    .select('*')
                    .eq('user_id', App.currentUser.id);
                
                if (!error && data) {
                    App.usuarios = data.map(u => u.nome);
                    App.dataCache.usuariosCadastrados = data;
                    
                    const usuarioAtivo = data.find(u => u.ativo);
                    if (usuarioAtivo) {
                        App.usuarioAtual = usuarioAtivo.nome;
                        document.getElementById('usuarioHeaderNome').textContent = usuarioAtivo.nome;
                        localStorage.setItem(`homelife_usuario_${App.currentUser.id}`, usuarioAtivo.nome);
                    } else {
                        const nomeSalvo = localStorage.getItem(`homelife_usuario_${App.currentUser.id}`);
                        if (nomeSalvo && App.usuarios.includes(nomeSalvo)) {
                            App.usuarioAtual = nomeSalvo;
                            document.getElementById('usuarioHeaderNome').textContent = nomeSalvo;
                            await App.supabase
                                .from('usuarios_cadastrados')
                                .update({ ativo: true })
                                .eq('user_id', App.currentUser.id)
                                .eq('nome', nomeSalvo);
                        }
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar usuários:', e);
            }
        }

        async function salvarUsuariosCadastrados() {
            if (!App.currentUser) return;
            try {
                for (const nome of App.usuarios) {
                    const existe = App.dataCache.usuariosCadastrados?.find(u => u.nome === nome);
                    if (!existe) {
                        await App.supabase.from('usuarios_cadastrados').insert({
                            user_id: App.currentUser.id,
                            nome: nome,
                            ativo: nome === App.usuarioAtual
                        });
                    }
                }
                
                if (App.usuarioAtual) {
                    await App.supabase
                        .from('usuarios_cadastrados')
                        .update({ ativo: false })
                        .eq('user_id', App.currentUser.id);
                    
                    await App.supabase
                        .from('usuarios_cadastrados')
                        .update({ ativo: true })
                        .eq('user_id', App.currentUser.id)
                        .eq('nome', App.usuarioAtual);
                }
                
                localStorage.setItem(`homelife_usuario_${App.currentUser.id}`, App.usuarioAtual || '');
                await carregarUsuariosCadastrados();
            } catch (e) {
                console.error('Erro ao salvar usuários:', e);
            }
        }

        function carregarConfigLocal() {
            if (!App.currentUser) return;
            const key = `homelife_config_${App.currentUser.id}`;
            try {
                const config = JSON.parse(localStorage.getItem(key) || '{}');
                App.notificacoesConfig = config.notificacoes || { contas: true, eventos: true, lista: true, novoItem: false, tipo: 'ambos' };
            } catch (e) { }
        }

        function salvarConfigLocal() {
            if (!App.currentUser) return;
            const key = `homelife_config_${App.currentUser.id}`;
            localStorage.setItem(key, JSON.stringify({
                notificacoes: App.notificacoesConfig
            }));
        }

        function verificarUsuario() {
            if (!App.usuarioAtual) {
                abrirSelecaoUsuario();
            } else {
                abrirMenuUsuarios();
            }
        }

        function verificarUsuarioAcao(acao) {
            if (!App.usuarioAtual) {
                abrirSelecaoUsuario(true, acao);
            } else {
                executarAcao(acao);
            }
        }

        function abrirSelecaoUsuario(aposAcao = false, acao = null) {
            carregarUsuariosCadastrados().then(() => {
                let usuariosHtml = App.usuarios.map(u => 
                    `<div class="delete-option" onclick="selecionarUsuario('${u}', ${aposAcao}, '${acao}')">
                        <strong><i class="fas fa-user"></i> ${u}</strong>
                    </div>`
                ).join('');

                let conteudo = `
                    <div class="form-group">
                        <label class="form-label">Seu Nome</label>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="novoUsuarioNome" class="form-input" placeholder="Digite seu nome" autocomplete="off">
                            <button class="btn btn-success" onclick="adicionarUsuarioSelecao(${aposAcao}, '${acao}')"><i class="fas fa-plus"></i> Adicionar</button>
                        </div>
                    </div>
                    ${App.usuarios.length > 0 ? `
                        <div class="section-divider">Usuários Existentes</div>
                        ${usuariosHtml}
                    ` : ''}
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                `;
                abrirModal('Selecionar Usuário', 'fa-user', conteudo);
            });
        }

        async function adicionarUsuarioSelecao(aposAcao = false, acao = null) {
            let nome = document.getElementById('novoUsuarioNome')?.value.trim();
            if (!nome) {
                showToast('Digite um nome', 'warning');
                return;
            }
            if (!App.usuarios.includes(nome)) {
                App.usuarios.push(nome);
                await salvarUsuariosCadastrados();
            }
            App.usuarioAtual = nome;
            document.getElementById('usuarioHeaderNome').textContent = nome;
            localStorage.setItem(`homelife_usuario_${App.currentUser.id}`, nome);
            await salvarUsuariosCadastrados();
            fecharModal();
            showToast(`Usuário ${nome} selecionado`, 'success');
            if (aposAcao && acao) {
                setTimeout(() => executarAcao(acao), 300);
            }
        }

        async function selecionarUsuario(nome, aposAcao = false, acao = null) {
            App.usuarioAtual = nome;
            document.getElementById('usuarioHeaderNome').textContent = nome;
            localStorage.setItem(`homelife_usuario_${App.currentUser.id}`, nome);
            await salvarUsuariosCadastrados();
            fecharModal();
            showToast(`Usuário ${nome} selecionado`, 'success');
            if (aposAcao && acao) {
                setTimeout(() => executarAcao(acao), 300);
            }
        }

        function executarAcao(acao) {
            fecharAddMenu();
            switch (acao) {
                case 'conta': abrirNovaConta(); break;
                case 'evento': abrirNovoEventoUnificado(); break;
                case 'gasto': abrirNovoGasto(); break;
                case 'lista': abrirNovoItemLista(); break;
                case 'giro': abrirNovoGiro(); break;
            }
        }

        async function abrirMenuUsuarios() {
            await carregarUsuariosCadastrados();
            let usuariosHtml = App.usuarios.map(u => 
                `<div class="delete-option ${u === App.usuarioAtual ? 'selected' : ''}">
                    <strong><i class="fas fa-user"></i> ${u}</strong> ${u === App.usuarioAtual ? '(atual)' : ''}
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();removerUsuario('${u}')" style="float:right"><i class="fas fa-trash"></i></button>
                </div>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label">Novo Usuário</label>
                    <div style="display:flex;gap:8px">
                        <input type="text" id="novoUsuarioNome" class="form-input" placeholder="Nome">
                        <button class="btn btn-success" onclick="adicionarUsuario()"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="section-divider">Usuários Cadastrados</div>
                ${usuariosHtml || '<p>Nenhum usuário cadastrado</p>'}
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Fechar</button>
                </div>
            `;
            abrirModal('Gerenciar Usuários', 'fa-users', conteudo);
        }

        async function adicionarUsuario() {
            let nome = document.getElementById('novoUsuarioNome')?.value.trim();
            if (!nome) {
                showToast('Digite um nome', 'warning');
                return;
            }
            if (!App.usuarios.includes(nome)) {
                App.usuarios.push(nome);
                await salvarUsuariosCadastrados();
                showToast('Usuário adicionado!', 'success');
            } else {
                showToast('Usuário já existe', 'warning');
            }
            fecharModal();
            abrirMenuUsuarios();
        }

        async function removerUsuario(nome) {
            if (App.usuarios.length === 1) {
                showToast('Deve haver pelo menos um usuário', 'warning');
                return;
            }
            
            try {
                await App.supabase
                    .from('usuarios_cadastrados')
                    .delete()
                    .eq('user_id', App.currentUser.id)
                    .eq('nome', nome);
                
                App.usuarios = App.usuarios.filter(u => u !== nome);
                
                if (nome === App.usuarioAtual) {
                    App.usuarioAtual = App.usuarios[0];
                    document.getElementById('usuarioHeaderNome').textContent = App.usuarioAtual;
                    localStorage.setItem(`homelife_usuario_${App.currentUser.id}`, App.usuarioAtual);
                    await App.supabase
                        .from('usuarios_cadastrados')
                        .update({ ativo: true })
                        .eq('user_id', App.currentUser.id)
                        .eq('nome', App.usuarioAtual);
                }
                
                showToast('Usuário removido!', 'success');
            } catch (e) {
                console.error('Erro ao remover usuário:', e);
                showToast('Erro ao remover usuário', 'error');
            }
            
            fecharModal();
            abrirMenuUsuarios();
        }

        function abrirMenuRelatorio() {
            let { mes, ano } = getMesAnoAtual();
            let totalContas = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano).reduce((acc, c) => acc + (c.valor_original || c.valor || 0), 0);
            let totalGastos = App.dataCache.gastos.filter(g => g.mes === mes && g.ano === ano).reduce((acc, g) => acc + (g.valor || 0), 0);
            let totalPago = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano && c.valor_pago > 0).reduce((acc, c) => acc + c.valor_pago, 0);
            
            let conteudo = `
                <div style="padding:16px">
                    <h3 style="color:var(--purple);margin-bottom:16px">Relatório de ${getNomeMes(mes)}/${ano}</h3>
                    <div style="background:var(--bg-pendente);padding:12px;border-radius:8px;margin-bottom:12px">
                        <div><strong>Total de Contas:</strong> ${formatCurrency(totalContas)}</div>
                        <div><strong>Total Pago:</strong> ${formatCurrency(totalPago)}</div>
                        <div><strong>Restante:</strong> ${formatCurrency(totalContas - totalPago)}</div>
                    </div>
                    <div style="background:var(--bg-gasto);padding:12px;border-radius:8px;margin-bottom:12px">
                        <div><strong>Total de Gastos:</strong> ${formatCurrency(totalGastos)}</div>
                    </div>
                    <div style="background:var(--bg-evento);padding:12px;border-radius:8px;margin-bottom:12px">
                        <div><strong>Saldo Final:</strong> ${formatCurrency(App.saldoCentral.valor)}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            `;
            abrirModal('Relatório', 'fa-chart-line', conteudo);
        }

        function abrirMenuSeguranca() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label">Alterar Senha do Saldo</label>
                    <input type="password" id="novaSenhaSaldo" class="form-input" placeholder="Nova senha (4 dígitos)" maxlength="4">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="alterarSenhaSaldo()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Segurança', 'fa-lock', conteudo);
        }

        function alterarSenhaSaldo() {
            let novaSenha = document.getElementById('novaSenhaSaldo')?.value;
            if (!novaSenha || novaSenha.length !== 4) {
                showToast('Senha deve ter 4 dígitos', 'warning');
                return;
            }
            App.saldoSenha = novaSenha;
            showToast('Senha alterada!', 'success');
            fecharModal();
        }

        function abrirNotificacoes() {
            let config = App.notificacoesConfig;
            let conteudo = `
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifContas" ${config.contas ? 'checked' : ''}> Notificar Contas</label>
                </div>
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifEventos" ${config.eventos ? 'checked' : ''}> Notificar Eventos</label>
                </div>
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifLista" ${config.lista ? 'checked' : ''}> Notificar Lista</label>
                </div>
                <div class="notificacao-option">
                    <label><input type="checkbox" id="notifNovoItem" ${config.novoItem ? 'checked' : ''}> Notificar Novo Item (outro usuário)</label>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Notificação</label>
                    <select id="notifTipo" class="form-select">
                        <option value="ambos" ${config.tipo === 'ambos' ? 'selected' : ''}>Banner + Bloqueio</option>
                        <option value="banner" ${config.tipo === 'banner' ? 'selected' : ''}>Apenas Banner</option>
                        <option value="bloqueio" ${config.tipo === 'bloqueio' ? 'selected' : ''}>Apenas Bloqueio</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNotificacoes()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Configurar Notificações', 'fa-bell', conteudo);
        }

        function salvarNotificacoes() {
            App.notificacoesConfig = {
                contas: document.getElementById('notifContas')?.checked || false,
                eventos: document.getElementById('notifEventos')?.checked || false,
                lista: document.getElementById('notifLista')?.checked || false,
                novoItem: document.getElementById('notifNovoItem')?.checked || false,
                tipo: document.getElementById('notifTipo')?.value || 'ambos'
            };
            salvarConfigLocal();
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            fecharModal();
            showToast('Configurações salvas!', 'success');
        }

        function abrirManual() {
            let conteudo = `
                <div class="manual-section" style="padding:16px">
                    <h3 style="color:var(--purple);margin-bottom:16px">Home Life - Manual</h3>
                    <p>Bem-vindo ao Home Life! Guia rápido:</p>
                    
                    <h4 style="margin-top:16px;color:var(--purple-dark)">📅 Calendário</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Clique nos dias para filtrar itens</li>
                        <li>Balões: contas a pagar (verde) e vencidas (vermelho)</li>
                        <li>Ícones: eventos personalizados</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">💰 Contas</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Cadastro único ou recorrente</li>
                        <li>Pagamento debita do saldo central</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">🎉 Eventos</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Com ícones coloridos</li>
                        <li>Período múltiplos dias para eventos únicos</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">🛒 Gastos e Lista</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Gastos debitam automaticamente</li>
                        <li>Lista com badge de pendentes</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">👥 Usuários</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Vários usuários no mesmo login</li>
                        <li>Cada ação registra quem fez</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">🔔 Notificações</h4>
                    <ul style="margin-left:20px;margin-bottom:12px">
                        <li>Escolha o que notificar</li>
                        <li>Banner e/ou tela bloqueio</li>
                    </ul>

                    <h4 style="color:var(--purple-dark)">💵 Saldos</h4>
                    <ul style="margin-left:20px;margin-bottom:16px">
                        <li>Protegido por senha (padrão 1234)</li>
                        <li>Saldo central afetado automaticamente</li>
                    </ul>

                    <p style="text-align:center;margin-top:20px">Aproveite! <i class="fas fa-smile"></i></p>
                    
                    <div class="btn-group" style="margin-top:20px">
                        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            `;
            abrirModal('Manual de Instruções', 'fa-book', conteudo);
        }

        function verificarNotificacoes(item, tipo) {
            if (!App.currentUser || !('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            let config = App.notificacoesConfig;
            if (!config[tipo] && tipo !== 'novoItem') return;
            if (tipo === 'novoItem' && !config.novoItem) return;
            let corpo = `${item.descricao || item.titulo || item} - ${App.usuarioAtual}`;
            if (config.tipo === 'banner' || config.tipo === 'ambos') {
                showToast(`🔔 ${corpo}`, 'info');
            }
            if (config.tipo === 'bloqueio' || config.tipo === 'ambos') {
                new Notification('Home Life', {
                    body: corpo,
                    icon: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/home.svg'
                });
            }
        }

        async function carregarDados(forceRefresh) {
            if (!App.currentUser) return;
            await carregarUsuariosCadastrados();
            carregarConfigLocal();

            try {
                const promises = [
                    App.supabase.from('contas').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('regras_contas').select('*').eq('user_id', App.currentUser.id).eq('ativo', true),
                    App.supabase.from('eventos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('eventos_individuais').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('regras_eventos').select('*').eq('user_id', App.currentUser.id).eq('ativo', true),
                    App.supabase.from('gastos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('lista_compras').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('saldos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('historico_pagamentos').select('*').eq('user_id', App.currentUser.id),
                    App.supabase.from('historico_acoes').select('*').eq('user_id', App.currentUser.id).order('data', { ascending: false }).limit(500),
                    App.supabase.from('giros').select('*').eq('user_id', App.currentUser.id),
App.supabase.from('movimentacoes_giro').select('*').eq('user_id', App.currentUser.id).order('data', { ascending: false })
                ];

               const results = await Promise.allSettled(promises);

const contas = results[0].status === 'fulfilled' ? results[0].value.data : [];
const regrasContas = results[1].status === 'fulfilled' ? results[1].value.data : [];
const eventos = results[2].status === 'fulfilled' ? results[2].value.data : [];
const eventosIndividuais = results[3].status === 'fulfilled' ? results[3].value.data : [];
const regrasEventos = results[4].status === 'fulfilled' ? results[4].value.data : [];
const gastos = results[5].status === 'fulfilled' ? results[5].value.data : [];
const lista = results[6].status === 'fulfilled' ? results[6].value.data : [];
const saldos = results[7].status === 'fulfilled' ? results[7].value.data : [];
const historico = results[8].status === 'fulfilled' ? results[8].value.data : [];
const historicoAcoes = results[9].status === 'fulfilled' ? results[9].value.data : [];
const giros = results[10].status === 'fulfilled' ? results[10].value.data : [];
const movimentacoes = results[11].status === 'fulfilled' ? results[11].value.data : [];

                let excecoesRecorrencia = [];
                try {
                    const { data: ex } = await App.supabase.from('excecoes_recorrencia').select('*').eq('user_id', App.currentUser.id);
                    if (ex) excecoesRecorrencia = ex;
                } catch (e) { }

                let configuracoes = [];
                try {
                    const { data: configs } = await App.supabase.from('configuracoes').select('*').eq('user_id', App.currentUser.id);
                    if (configs) configuracoes = configs;
                } catch (e) { }

                if (configuracoes) configuracoes.forEach(c => {
                    if (c.chave === 'saldo_senha') App.saldoSenha = c.valor;
                });

                if (historicoAcoes) {
                    App.historicoAcoes = historicoAcoes.map(h => ({ ...h, detalhes: JSON.parse(h.detalhes || '{}') }));
                }

                if (saldos && saldos.length > 0) {
                    let central = saldos.find(s => s.is_central) || saldos[0];
                    App.saldoCentral.id = central.id;
                    App.saldoCentral.valor = central.valor;
                }

                App.dataCache = {
                    contas: contas || [], regrasContas: regrasContas || [], eventos: eventos || [],
                    eventosIndividuais: eventosIndividuais || [], regrasEventos: regrasEventos || [],
                    gastos: gastos || [], lista: lista || [], saldos: saldos || [], historico: historico || [],
                    excecoesRecorrencia: excecoesRecorrencia, giros: giros || [], movimentacoesGiro: movimentacoes || [],
                    usuariosCadastrados: App.dataCache.usuariosCadastrados
                };

                atualizarListaBadge();
                atualizarSaldoHeader();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados', 'error');
            }
        }

        function atualizarListaBadge() {
            let totalLista = App.dataCache.lista.filter(i => !i.comprado).length;
            let badge = document.getElementById('listaBadge');
            badge.textContent = totalLista;
            badge.style.display = totalLista > 0 ? 'flex' : 'none';
        }

        function calcularOcorrenciasConta(regra, mesAlvo, anoAlvo) {
            let ocorrencias = [];
            if (!regra || !regra.data_inicio || !regra.ativo) return ocorrencias;
            let dataInicio = new Date(regra.data_inicio + 'T12:00:00');
            if (dataInicio.getFullYear() > anoAlvo || (dataInicio.getFullYear() === anoAlvo && dataInicio.getMonth() + 1 > mesAlvo)) return ocorrencias;
            let dataFim = regra.data_fim ? new Date(regra.data_fim + 'T12:00:00') : null;
            if (dataFim && (dataFim.getFullYear() < anoAlvo || (dataFim.getFullYear() === anoAlvo && dataFim.getMonth() + 1 < mesAlvo))) return ocorrencias;

            let dataAtual = new Date(dataInicio);
            while (dataAtual.getFullYear() < anoAlvo || (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 < mesAlvo)) {
                if (regra.frequencia === 'semanal') dataAtual.setDate(dataAtual.getDate() + 7);
                else if (regra.frequencia === 'quinzenal') dataAtual.setDate(dataAtual.getDate() + 14);
                else if (regra.frequencia === 'mensal') {
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                    let ultimoDia = getDiasNoMes(dataAtual.getFullYear(), dataAtual.getMonth() + 1);
                    dataAtual.setDate(Math.min(regra.dia_vencimento, ultimoDia));
                } else if (regra.frequencia === 'anual') dataAtual.setFullYear(dataAtual.getFullYear() + 1);
            }

            let contador = 0;
            while (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 === mesAlvo && contador < 100) {
                if (!dataFim || dataAtual <= dataFim) {
                    let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regra.id && e.data_excecao === `${anoAlvo}-${String(mesAlvo).padStart(2, '0')}-${String(dataAtual.getDate()).padStart(2, '0')}`);
                    if (!excecao || excecao.acao !== 'excluir') {
                        ocorrencias.push({
                            id: `regra_${regra.id}_${dataAtual.getTime()}`,
                            regra_id: regra.id,
                            descricao: `${regra.descricao_base} (${regra.frequencia})`,
                            dia: dataAtual.getDate(),
                            mes: mesAlvo,
                            ano: anoAlvo,
                            valor_original: regra.valor || 0,
                            valor_pago: 0,
                            status: 'pendente',
                            frequencia: regra.frequencia,
                            isRecorrente: true,
                            data_original: dataAtual.toISOString()
                        });
                    }
                }
                if (regra.frequencia === 'semanal') dataAtual.setDate(dataAtual.getDate() + 7);
                else if (regra.frequencia === 'quinzenal') dataAtual.setDate(dataAtual.getDate() + 14);
                else if (regra.frequencia === 'mensal') {
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                    let ultimoDia = getDiasNoMes(dataAtual.getFullYear(), dataAtual.getMonth() + 1);
                    dataAtual.setDate(Math.min(regra.dia_vencimento, ultimoDia));
                } else if (regra.frequencia === 'anual') dataAtual.setFullYear(dataAtual.getFullYear() + 1);
                contador++;
            }
            return ocorrencias;
        }

        function calcularOcorrenciasEvento(regra, mesAlvo, anoAlvo) {
            let ocorrencias = [];
            if (!regra || !regra.data_inicio || !regra.ativo) return ocorrencias;
            let dataInicio = new Date(regra.data_inicio + 'T12:00:00');
            if (dataInicio.getFullYear() > anoAlvo || (dataInicio.getFullYear() === anoAlvo && dataInicio.getMonth() + 1 > mesAlvo)) return ocorrencias;
            let dataFim = regra.data_fim ? new Date(regra.data_fim + 'T12:00:00') : null;
            if (dataFim && (dataFim.getFullYear() < anoAlvo || (dataFim.getFullYear() === anoAlvo && dataFim.getMonth() + 1 < mesAlvo))) return ocorrencias;

            let dataAtual = new Date(dataInicio);
            while (dataAtual.getFullYear() < anoAlvo || (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 < mesAlvo)) {
                if (regra.frequencia === 'semanal') dataAtual.setDate(dataAtual.getDate() + 7);
                else if (regra.frequencia === 'quinzenal') dataAtual.setDate(dataAtual.getDate() + 14);
                else if (regra.frequencia === 'mensal') {
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                    let ultimoDia = getDiasNoMes(dataAtual.getFullYear(), dataAtual.getMonth() + 1);
                    dataAtual.setDate(Math.min(regra.dia, ultimoDia));
                } else if (regra.frequencia === 'anual') dataAtual.setFullYear(dataAtual.getFullYear() + 1);
            }

            let contador = 0;
            while (dataAtual.getFullYear() === anoAlvo && dataAtual.getMonth() + 1 === mesAlvo && contador < 100) {
                if (!dataFim || dataAtual <= dataFim) {
                    let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regra.id && e.data_excecao === `${anoAlvo}-${String(mesAlvo).padStart(2, '0')}-${String(dataAtual.getDate()).padStart(2, '0')}`);
                    if (!excecao || excecao.acao !== 'excluir') {
                        let eventoIndividual = App.dataCache.eventosIndividuais?.find(e => e.regra_id === regra.id && e.data_original === dataAtual.toISOString().split('T')[0]);
                        if (eventoIndividual) {
                            ocorrencias.push({
                                id: `evento_individual_${eventoIndividual.id}`,
                                regra_id: regra.id,
                                titulo: eventoIndividual.titulo || regra.titulo_base,
                                descricao: eventoIndividual.descricao || regra.descricao || '',
                                dia: dataAtual.getDate(),
                                mes: mesAlvo,
                                ano: anoAlvo,
                                hora: eventoIndividual.hora || regra.hora || '',
                                local: eventoIndividual.local || regra.local || '',
                                icone: eventoIndividual.icone || regra.icone || 'fa-star',
                                cor_icone: eventoIndividual.cor_icone || regra.cor_icone || '#ffd700',
                                frequencia: regra.frequencia,
                                isRecorrente: false,
                                isIndividual: true,
                                individual_id: eventoIndividual.id,
                                data_original: dataAtual.toISOString()
                            });
                        } else {
                            ocorrencias.push({
                                id: `regra_evento_${regra.id}_${dataAtual.getTime()}`,
                                regra_id: regra.id,
                                titulo: `${regra.titulo_base} (${regra.frequencia})`,
                                descricao: regra.descricao || '',
                                dia: dataAtual.getDate(),
                                mes: mesAlvo,
                                ano: anoAlvo,
                                hora: regra.hora || '',
                                local: regra.local || '',
                                icone: regra.icone || 'fa-star',
                                cor_icone: regra.cor_icone || '#ffd700',
                                frequencia: regra.frequencia,
                                isRecorrente: true,
                                data_original: dataAtual.toISOString()
                            });
                        }
                    }
                }
                if (regra.frequencia === 'semanal') dataAtual.setDate(dataAtual.getDate() + 7);
                else if (regra.frequencia === 'quinzenal') dataAtual.setDate(dataAtual.getDate() + 14);
                else if (regra.frequencia === 'mensal') {
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                    let ultimoDia = getDiasNoMes(dataAtual.getFullYear(), dataAtual.getMonth() + 1);
                    dataAtual.setDate(Math.min(regra.dia, ultimoDia));
                } else if (regra.frequencia === 'anual') dataAtual.setFullYear(dataAtual.getFullYear() + 1);
                contador++;
            }
            return ocorrencias;
        }

        function combinarContasDoMes(mes, ano) {
            let contasFixas = App.dataCache.contas.filter(c => c.mes === mes && c.ano === ano);
            let contasRecorrentes = [];
            App.dataCache.regrasContas.forEach(r => contasRecorrentes.push(...calcularOcorrenciasConta(r, mes, ano)));
            let todas = [...contasFixas, ...contasRecorrentes];
            todas = todas.filter(c => {
                if (!c.id.toString().startsWith('regra_') && !c.regra_id) return true;
                let regraId = c.regra_id || (c.id.toString().startsWith('regra_') ? c.id.split('_')[1] : null);
                if (!regraId) return true;
                let dataExcecao = `${ano}-${String(mes).padStart(2, '0')}-${String(c.dia).padStart(2, '0')}`;
                let excecao = App.dataCache.excecoesRecorrencia?.find(e => e.regra_id === regraId && e.data_excecao === dataExcecao);
                if (excecao && excecao.acao === 'pagar') return false;
                return true;
            });
            return todas;
        }

        function combinarEventosDoMes(mes, ano) {
            let eventosFixos = App.dataCache.eventos.filter(e => e.mes === mes && e.ano === ano);
            let eventosInd = App.dataCache.eventosIndividuais.filter(e => e.mes === mes && e.ano === ano);
            let eventosRec = [];
            App.dataCache.regrasEventos.forEach(r => eventosRec.push(...calcularOcorrenciasEvento(r, mes, ano)));
            let todos = [...eventosFixos, ...eventosInd, ...eventosRec];
            return todos;
        }

        async function atualizarCalendario() {
            let { mes, ano } = getMesAnoAtual();
            App.selectedMonth = mes;
            App.selectedYear = ano;
            document.getElementById('calendarTitle').textContent = `${getNomeMes(mes)} ${ano}`;

            let grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            CONFIG.diasSemana.forEach(dia => {
                let h = document.createElement('div');
                h.className = 'calendar-day-header';
                h.textContent = dia;
                grid.appendChild(h);
            });

            let primeiroDia = new Date(ano, mes - 1, 1).getDay();
            let diasNoMes = getDiasNoMes(ano, mes);

            for (let i = 0; i < primeiroDia; i++) {
                let e = document.createElement('div');
                e.className = 'calendar-day empty';
                grid.appendChild(e);
            }

            let todasContas = combinarContasDoMes(mes, ano);
            let todosEventos = combinarEventosDoMes(mes, ano);

            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            for (let dia = 1; dia <= diasNoMes; dia++) {
                let isToday = dia === hoje.getDate() && mes === hoje.getMonth() + 1 && ano === hoje.getFullYear() && App.currentMonthOffset === 0;

                let contasHoje = todasContas.filter(c => c.dia === dia);
                let eventosHoje = todosEventos.filter(e => e.dia === dia);

                let contasPendentes = contasHoje.filter(c => c.valor_pago === 0 && c.status !== 'paga');
                let contasVencidas = contasPendentes.filter(c => {
                    let d = criarData(ano, mes, c.dia);
                    return d < hoje;
                });
                let contasNormais = contasPendentes.filter(c => {
                    let d = criarData(ano, mes, c.dia);
                    return d >= hoje;
                });

                let cell = document.createElement('div');
                cell.className = `calendar-day ${isToday ? 'today' : ''} ${App.selectedDay === dia ? 'selected' : ''}`;
                cell.onclick = (e) => {
                    e.stopPropagation();
                    selecionarDia(dia);
                };

                let contasBadgesHtml = '<div class="contas-badges-line">';
                if (contasVencidas.length > 0) contasBadgesHtml += `<span class="day-badge badge-conta-vencida" title="${contasVencidas.length} conta(s) vencida(s)">${contasVencidas.length}</span>`;
                if (contasNormais.length > 0) contasBadgesHtml += `<span class="day-badge badge-conta" title="${contasNormais.length} conta(s) a pagar">${contasNormais.length}</span>`;
                contasBadgesHtml += '</div>';

                let eventosEmojisHtml = '<div class="eventos-emojis-line">';
                eventosHoje.forEach(e => {
                    let icone = e.icone || 'fa-star';
                    let cor = e.cor_icone || '#ffd700';
                    eventosEmojisHtml += `<span class="event-emoji-calendar" title="${e.titulo}"><i class="fas ${icone}" style="color:${cor}"></i></span>`;
                });
                eventosEmojisHtml += '</div>';

                cell.innerHTML = `<div class="day-number">${dia}</div>${contasBadgesHtml}${eventosEmojisHtml}`;
                grid.appendChild(cell);
            }
        }

        function criarData(ano, mes, dia) {
            return new Date(ano, mes - 1, dia, 12, 0, 0);
        }

        function selecionarDia(dia) {
            App.selectedDay = App.selectedDay === dia ? null : dia;
            atualizarCalendario();
            mostrarConteudo();
        }

        async function mostrarConteudo() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('contentArea').style.display = 'none';
            await carregarDados();

            let { mes, ano } = getMesAnoAtual();
            let content = document.getElementById('dynamicContent');
            let diaText = App.selectedDay ? ` - Dia ${App.selectedDay}` : '';

            document.getElementById('filterInfo').innerHTML = `<i class="fas fa-calendar-alt"></i> ${getNomeMes(mes)}/${ano}${diaText} | <strong>${Object.entries(App.activeFilters).filter(([k, v]) => v).map(([k]) => k).join(', ') || 'Nenhum'}</strong>`;

            try {
                if (App.currentFilter === 'saldos') await renderizarSaldos(content);
                else if (App.currentFilter === 'lista') await renderizarLista(content);
                else if (App.currentFilter === 'gastos') await renderizarGastos(content, mes, ano);
                else if (App.currentFilter === 'giros') await renderizarGiros(content);
                else await renderizarTudo(content, mes, ano);
            } catch (error) {
                console.error(error);
                content.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><p>Erro ao carregar dados</p></div>';
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
        }

        async function renderizarTudo(content, mes, ano) {
            let todasContas = combinarContasDoMes(mes, ano);
            let todosEventos = combinarEventosDoMes(mes, ano);

            let contasF = App.selectedDay ? todasContas.filter(c => c.dia === App.selectedDay) : todasContas;
            let eventosF = App.selectedDay ? todosEventos.filter(e => e.dia === App.selectedDay) : todosEventos;

            let itens = [];
            if (App.activeFilters.contas) itens.push(...contasF.map(c => ({ ...c, tipo: 'conta' })));
            if (App.activeFilters.eventos) itens.push(...eventosF.map(e => ({ ...e, tipo: 'evento' })));

            itens.sort((a, b) => a.dia - b.dia);

            if (itens.length === 0) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhum item encontrado</p></div>';
                return;
            }

            let html = '<div class="items-list">';
            itens.forEach(i => html += renderizarItemCard(i, mes, ano));
            html += '</div>';
            content.innerHTML = html;
        }

        function renderizarItemCard(item, mes, ano) {
            if (!item) return '';
            let hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            let classe = '';
            let titulo = '';
            let detalhes = '';
            let valor = '';
            let icone = 'fa-file-invoice-dollar';
            let botoes = '';
            let usuario = item.added_by || 'desconhecido';
            let usuarioBadge = `<span class="usuario-badge">${usuario}</span>`;

            if (item.tipo === 'conta') {
                let venc = criarData(ano || item.ano, mes || item.mes, item.dia || item.dia_vencimento);
                if (item.valor_pago > 0 || item.status === 'paga') {
                    classe = 'paga';
                } else if (venc < hoje) {
                    classe = 'vencida';
                } else {
                    classe = 'pendente';
                }

                titulo = item.descricao || 'Conta sem descrição';
                if (item.frequencia && item.frequencia !== 'unico') titulo += ` <span class="item-badge badge-recorrente">${item.frequencia}</span>`;
                detalhes = `Vence ${item.dia || item.dia_vencimento} ${getNomeMes(mes || item.mes)}/${ano || item.ano}`;
                valor = formatCurrency(item.valor_original || item.valor || 0);
                
                if (item.valor_pago > 0 || item.status === 'paga') {
                    botoes += `<button class="action-btn undo" onclick="event.stopPropagation();abrirModalDesfazerPagamento('${item.id}','${item.descricao}',${item.valor_pago || item.valor_original || item.valor || 0},'${item.regra_id || ''}',${item.dia || item.dia_vencimento},${mes || item.mes},${ano || item.ano},${item.isRecorrente || false})"><i class="fas fa-undo-alt"></i></button>`;
                } else {
                    botoes += `<button class="action-btn pay" onclick="event.stopPropagation();abrirModalPagamento('${item.id}','${item.descricao}',${item.valor_original || item.valor || 0},'${item.regra_id || ''}',${item.dia || item.dia_vencimento},${mes || item.mes},${ano || item.ano},${item.isRecorrente || false})"><i class="fas fa-dollar-sign"></i></button>`;
                }

                return `<div class="item-card ${classe}" onclick="editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}')">
                    <div class="item-info">
                        <div class="item-title"><i class="fas ${icone}"></i> ${titulo} ${usuarioBadge}</div>
                        <div class="item-details">${detalhes}</div>
                    </div>
                    <div class="item-value">${valor}</div>
                    <div class="item-actions">
                        ${botoes}
                        <button class="action-btn edit" onclick="event.stopPropagation();editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="event.stopPropagation();confirmarExclusao('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.dia || 0},${item.mes || 0},${item.ano || 0},${item.isIndividual || false},'${item.individual_id || ''}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            } else if (item.tipo === 'evento') {
                let dataEv = criarData(item.ano, item.mes, item.dia);
                classe = dataEv < hoje ? 'paga' : 'pendente';
                let iconeEvento = item.icone || 'fa-star';
                let corIcone = item.cor_icone || '#ffd700';
                titulo = item.titulo || 'Evento sem título';
                if (item.frequencia && item.frequencia !== 'unico') {
                    titulo += ` <span class="item-badge badge-recorrente">${item.frequencia}</span>`;
                }
                detalhes = `${item.dia} ${getNomeMes(item.mes)}/${item.ano}`;
                if (item.hora) detalhes += ` | ${item.hora}`;
                if (item.local) detalhes += ` | ${item.local}`;

                return `<div class="item-card ${classe}" onclick="editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}')">
                    <div class="item-info">
                        <div class="item-title"><span class="event-emoji"><i class="fas ${iconeEvento}" style="color:${corIcone}"></i></span> ${titulo} ${usuarioBadge}</div>
                        <div class="item-details">${detalhes}</div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="event.stopPropagation();editarItem('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.isIndividual || false},'${item.individual_id || ''}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="event.stopPropagation();confirmarExclusao('${item.id}','${item.tipo}',${item.isRecorrente || false},'${item.regra_id || ''}',${item.dia || 0},${item.mes || 0},${item.ano || 0},${item.isIndividual || false},'${item.individual_id || ''}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }
        }

        async function renderizarGastos(content, mes, ano) {
            let gastosMes = App.dataCache.gastos.filter(g => g.mes === mes && g.ano === ano);
            if (gastosMes.length === 0) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-bag"></i><p>Nenhum gasto neste mês</p><button class="btn btn-primary" onclick="verificarUsuarioAcao(\'gasto\')" style="margin-top:16px"><i class="fas fa-plus"></i> Novo Gasto</button></div>';
                return;
            }

            let html = '<div class="items-list">';
            gastosMes.sort((a, b) => a.dia - b.dia).forEach(g => {
                let cat = CONFIG.categoriasGastos.find(c => c.id === g.categoria) || CONFIG.categoriasGastos[6];
                let catNome = cat.nome;
                if (g.categoria_customizada && g.categoria === 'outros') catNome = g.categoria_customizada;

                html += `<div class="item-card gasto" onclick="editarGasto('${g.id}')">
                    <div class="item-info">
                        <div class="item-title"><i class="fas fa-shopping-bag"></i> ${g.descricao} <span class="item-badge">${catNome}</span> <span class="usuario-badge">${g.added_by || 'desconhecido'}</span></div>
                        <div class="item-details">${g.dia} ${getNomeMes(g.mes)}/${g.ano}</div>
                    </div>
                    <div class="item-value">${formatCurrency(g.valor)}</div>
                    <div class="item-actions">
                        <button class="action-btn delete" onclick="event.stopPropagation();cancelarGasto('${g.id}','${g.descricao}',${g.valor})"><i class="fas fa-undo-alt"></i></button>
                        <button class="action-btn edit" onclick="event.stopPropagation();editarGasto('${g.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="event.stopPropagation();deletarGasto('${g.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
            html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="verificarUsuarioAcao('gasto')"><i class="fas fa-plus"></i> Novo Gasto</button></div></div>`;
            content.innerHTML = html;
        }

        async function renderizarLista(content) {
            let lista = App.dataCache.lista || [];
            if (lista.length === 0) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Lista de compras vazia</p><button class="btn btn-primary" onclick="verificarUsuarioAcao(\'lista\')" style="margin-top:16px"><i class="fas fa-plus"></i> Adicionar Item</button></div>';
                return;
            }

            let pendentes = lista.filter(i => !i.comprado);
            let comprados = lista.filter(i => i.comprado);
            let html = '<div class="items-list">';

            if (pendentes.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-clock"></i> Pendentes</div>';
                pendentes.forEach(i => {
                    html += `<div class="item-card pendente" onclick="editarItemLista('${i.id}')">
                        <div class="item-info">
                            <div class="item-title"><span class="item-badge">${i.quantidade}x</span>${i.descricao || 'Item sem descrição'} <span class="usuario-badge">${i.added_by || 'desconhecido'}</span></div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit" onclick="event.stopPropagation();alternarComprado('${i.id}')"><i class="fas ${i.comprado ? 'fa-undo' : 'fa-check'}"></i></button>
                            <button class="action-btn delete" onclick="event.stopPropagation();deletarItemLista('${i.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }

            if (comprados.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-check-double"></i> Comprados</div>';
                comprados.forEach(i => {
                    html += `<div class="item-card paga" onclick="editarItemLista('${i.id}')">
                        <div class="item-info">
                            <div class="item-title"><span class="item-badge">${i.quantidade}x</span>${i.descricao || 'Item sem descrição'}</div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit" onclick="event.stopPropagation();alternarComprado('${i.id}')"><i class="fas fa-undo"></i></button>
                            <button class="action-btn delete" onclick="event.stopPropagation();deletarItemLista('${i.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }

            html += '</div>';
            content.innerHTML = html;
        }

        async function renderizarSaldos(content) {
            if (!App.saldoAutenticado) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-lock"></i><p style="margin:16px 0">Área protegida por senha</p><button class="btn btn-primary" onclick="autenticarSaldos()"><i class="fas fa-unlock-alt"></i> Autenticar</button></div>';
                return;
            }

            let saldos = App.dataCache.saldos || [];
            let html = '<div class="items-list">';
            let central = saldos.find(s => s.is_central);

            if (central) {
                let dataAtualizacao = new Date(central.data || new Date());
                dataAtualizacao.setDate(dataAtualizacao.getDate() + 1);
                html += `<div style="padding:16px;background:linear-gradient(135deg,var(--purple),var(--purple-dark));color:#fff;border-radius:8px;margin-bottom:12px">
                    <div style="font-size:.9em;opacity:.9">Saldo Central</div>
                    <div style="font-size:1.8em;font-weight:700">${formatCurrency(central.valor)}</div>
                    <div style="font-size:.8em;margin-top:4px">Atualizado: ${dataAtualizacao.toLocaleDateString('pt-BR')}</div>
                    <div class="btn-group" style="margin-top:12px">
                        <button class="btn btn-sm btn-success" onclick="abrirAdicionarValorSaldo('${central.id}')"><i class="fas fa-plus"></i> Adicionar</button>
                        <button class="btn btn-sm btn-warning" onclick="abrirRetirarValorSaldo('${central.id}')"><i class="fas fa-minus"></i> Retirar</button>
                        <button class="btn btn-sm btn-primary" onclick="abrirAtualizarValorSaldo('${central.id}')"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>
                </div>`;
            }

            let outros = saldos.filter(s => !s.is_central);
            if (outros.length > 0) {
                html += '<div class="section-divider"><i class="fas fa-piggy-bank"></i> Outros Saldos</div>';
                outros.forEach(s => {
                    html += `<div class="item-card">
                        <div class="item-info">
                            <div class="item-title"><i class="fas fa-wallet"></i> ${s.nome || 'Sem nome'} <span class="usuario-badge">${s.added_by || 'desconhecido'}</span></div>
                        </div>
                        <div class="item-value">${formatCurrency(s.valor)}</div>
                        <div class="item-actions">
                            <button class="action-btn update" onclick="event.stopPropagation();abrirAtualizarValorSaldo('${s.id}')"><i class="fas fa-sync-alt"></i></button>
                            <button class="action-btn edit" onclick="event.stopPropagation();editarSaldo('${s.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="event.stopPropagation();deletarSaldo('${s.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }

            html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="abrirNovoSaldo()"><i class="fas fa-plus"></i> Novo Saldo</button></div></div>`;
            content.innerHTML = html;
        }

        async function renderizarGiros(content) {
            let giros = App.dataCache.giros || [];
            if (giros.length === 0) {
                content.innerHTML = '<div class="empty-state"><i class="fas fa-hand-holding-usd"></i><p>Nenhum giro cadastrado</p><button class="btn btn-primary" onclick="verificarUsuarioAcao(\'giro\')" style="margin-top:16px"><i class="fas fa-plus"></i> Novo Giro</button></div>';
                return;
            }

            let html = '<div class="items-list">';
            giros.forEach(g => {
                let movimentacoes = App.dataCache.movimentacoesGiro?.filter(m => m.giro_id === g.id) || [];
                let totalPago = movimentacoes.reduce((acc, m) => acc + (m.tipo === 'pagamento' ? m.valor : 0), 0);
                let totalRecebido = movimentacoes.reduce((acc, m) => acc + (m.tipo === 'recebimento' ? m.valor : 0), 0);
                let saldoAtual = g.valor_inicial + totalRecebido - totalPago;

                html += `<div class="giro-card">
                    <div class="giro-header">
                        <div class="giro-titulo"><i class="fas fa-hand-holding-usd"></i> ${g.descricao} <span class="usuario-badge">${g.added_by || 'desconhecido'}</span></div>
                        <div class="giro-saldo">${formatCurrency(saldoAtual)}</div>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                        <span class="item-badge">Inicial: ${formatCurrency(g.valor_inicial)}</span>
                        <span class="item-badge">Pago: ${formatCurrency(totalPago)}</span>
                        <span class="item-badge">Recebido: ${formatCurrency(totalRecebido)}</span>
                        <span class="item-badge">Pessoa: ${g.pessoa || 'Não informado'}</span>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                        <button class="btn btn-sm btn-success" onclick="abrirPagamentoGiro('${g.id}','${g.descricao}')"><i class="fas fa-arrow-down"></i> Pagar</button>
                        <button class="btn btn-sm btn-warning" onclick="abrirRecebimentoGiro('${g.id}','${g.descricao}')"><i class="fas fa-arrow-up"></i> Receber</button>
                        <button class="btn btn-sm btn-primary" onclick="editarGiro('${g.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deletarGiro('${g.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;

                if (movimentacoes.length > 0) {
                    html += '<div class="giro-historico">';
                    movimentacoes.slice(0, 10).forEach(m => {
                        let data = new Date(m.data).toLocaleDateString('pt-BR');
                        let tipoIcon = m.tipo === 'pagamento' ? 'fa-arrow-down' : 'fa-arrow-up';
                        html += `<div class="giro-linha">
                            <span><i class="fas ${tipoIcon}" style="color:${m.tipo === 'pagamento' ? 'var(--danger)' : 'var(--success)'}"></i> ${data} - ${m.descricao || ''}</span>
                            <span>${formatCurrency(m.valor)}</span>
                        </div>`;
                    });
                    html += '</div>';
                }

                html += '</div>';
            });

            html += `<div style="margin-top:16px;text-align:center"><button class="btn btn-primary" onclick="verificarUsuarioAcao('giro')"><i class="fas fa-plus"></i> Novo Giro</button></div></div>`;
            content.innerHTML = html;
        }

        function abrirModal(titulo, icone, conteudo) {
            let modal = document.getElementById('modalContent');
            modal.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title"><i class="fas ${icone}"></i> ${titulo}</div>
                    <button class="close-modal" onclick="fecharModal()">&times;</button>
                </div>
                <div class="modal-body">${conteudo}</div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
            App.modalHasChanges = false;
        }

        function fecharModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            App.modalHasChanges = false;
        }

        function abrirNovaConta() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="contaDescricao" class="form-input" placeholder="Ex: Energia, Água..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="contaValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Dia do Vencimento</label>
                    <input type="number" id="contaDia" class="form-input" min="1" max="31" value="${diaPadrao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Mês/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="contaMes" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="contaAno" class="form-input" value="${ano}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequência</label>
                    <select id="contaFrequencia" class="form-select">
                        <option value="unico">Único</option>
                        <option value="mensal">Mensal</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovaConta()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Nova Conta', 'fa-file-invoice-dollar', conteudo);
        }

        async function salvarNovaConta() {
            let descricao = document.getElementById('contaDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('contaValor')?.value);
            let dia = parseInt(document.getElementById('contaDia')?.value);
            let mes = parseInt(document.getElementById('contaMes')?.value);
            let ano = parseInt(document.getElementById('contaAno')?.value);
            let frequencia = document.getElementById('contaFrequencia')?.value;

            if (!descricao || !valor || !dia || !mes || !ano) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            let diaAjustado = Math.min(dia, getDiasNoMes(ano, mes));
            let data = `${ano}-${String(mes).padStart(2, '0')}-${String(diaAjustado).padStart(2, '0')}`;

            try {
                if (frequencia === 'unico') {
                    await App.supabase.from('contas').insert({
                        user_id: App.currentUser.id,
                        descricao: descricao,
                        valor: valor,
                        valor_pago: 0,
                        dia: diaAjustado,
                        mes: mes,
                        ano: ano,
                        data: data,
                        status: 'pendente',
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                } else {
                    await App.supabase.from('regras_contas').insert({
                        user_id: App.currentUser.id,
                        descricao_base: descricao,
                        valor: valor,
                        dia_vencimento: diaAjustado,
                        frequencia: frequencia,
                        data_inicio: data,
                        ativo: true,
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                }

                verificarNotificacoes({ descricao, valor }, 'contas');
                await registrarHistorico('criacao_conta', `Conta criada: ${descricao}`, { descricao, valor, frequencia, usuario: App.usuarioAtual });
                showToast('Conta salva!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoEventoUnificado() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let iconesHtml = '';
            CONFIG.iconesEventos.forEach(icone => {
                iconesHtml += `<div class="icon-option" onclick="selecionarIconeEvento('${icone.icon}', '${icone.cor}')" data-icon="${icone.icon}" data-cor="${icone.cor}"><i class="fas ${icone.icon}" style="color:${icone.cor}"></i></div>`;
            });

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Título do Evento</label>
                    <input type="text" id="eventoTitulo" class="form-input" placeholder="Digite o título">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-icons"></i> Escolha o Ícone</label>
                    <button class="btn btn-primary" style="width:100%; margin-bottom:8px" onclick="abrirSeletorIcones()"><i class="fas fa-icons"></i> Selecionar Ícone</button>
                    <div id="iconeSelecionadoDisplay" style="display:none; text-align:center; padding:10px; background:#f8f9fa; border-radius:8px">
                        <i class="fas fa-star" id="iconePreview" style="font-size:32px; color:#ffd700"></i>
                    </div>
                    <input type="hidden" id="eventoIcone" value="fa-star">
                    <input type="hidden" id="eventoCorIcone" value="#ffd700">
                </div>
                <div id="seletorIconesModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:12px; z-index:1002; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2)">
                    <h4 style="margin-bottom:16px; color:var(--purple)">Escolha um ícone</h4>
                    <div class="icon-grid">${iconesHtml}</div>
                    <div style="text-align:center; margin-top:16px">
                        <button class="btn" onclick="fecharSeletorIcones()" style="background:var(--gray); color:#fff">Fechar</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descrição</label>
                    <textarea id="eventoDescricao" class="form-textarea" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de Início</label>
                    <input type="number" id="eventoDiaInicio" class="form-input" min="1" max="31" value="${diaPadrao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Data de Fim (opcional)</label>
                    <input type="number" id="eventoDiaFim" class="form-input" min="1" max="31" placeholder="Dia de fim">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Mês/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="eventoMes" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="eventoAno" class="form-input" value="${ano}">
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-clock"></i> Hora</label>
                        <input type="time" id="eventoHora" class="form-input">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label"><i class="fas fa-map-marker-alt"></i> Local</label>
                        <input type="text" id="eventoLocal" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-repeat"></i> Frequência</label>
                    <select id="eventoFrequencia" class="form-select">
                        <option value="unico">Único</option>
                        <option value="mensal">Mensal</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoEvento()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Evento', 'fa-calendar-plus', conteudo);
        }

        function abrirSeletorIcones() {
            document.getElementById('seletorIconesModal').style.display = 'block';
        }

        function fecharSeletorIcones() {
            document.getElementById('seletorIconesModal').style.display = 'none';
        }

        function selecionarIconeEvento(icone, cor) {
            document.getElementById('eventoIcone').value = icone;
            document.getElementById('eventoCorIcone').value = cor;
            let display = document.getElementById('iconeSelecionadoDisplay');
            let preview = document.getElementById('iconePreview');
            preview.className = `fas ${icone}`;
            preview.style.color = cor;
            display.style.display = 'block';
            fecharSeletorIcones();
        }

        async function salvarNovoEvento() {
            let titulo = document.getElementById('eventoTitulo')?.value.trim();
            let desc = document.getElementById('eventoDescricao')?.value.trim();
            let diaInicio = parseInt(document.getElementById('eventoDiaInicio')?.value);
            let diaFim = document.getElementById('eventoDiaFim')?.value ? parseInt(document.getElementById('eventoDiaFim').value) : null;
            let mes = parseInt(document.getElementById('eventoMes')?.value);
            let ano = parseInt(document.getElementById('eventoAno')?.value);
            let hora = document.getElementById('eventoHora')?.value;
            let local = document.getElementById('eventoLocal')?.value.trim();
            let icone = document.getElementById('eventoIcone')?.value || 'fa-star';
            let corIcone = document.getElementById('eventoCorIcone')?.value || '#ffd700';
            let frequencia = document.getElementById('eventoFrequencia')?.value;

            if (!titulo || !diaInicio || !mes || !ano) {
                showToast('Preencha título, dia de início e data', 'warning');
                return;
            }

            try {
                if (frequencia === 'unico') {
                    if (diaFim && diaFim >= diaInicio) {
                        for (let d = diaInicio; d <= Math.min(diaFim, getDiasNoMes(ano, mes)); d++) {
                            await App.supabase.from('eventos').insert({
                                user_id: App.currentUser.id,
                                titulo: titulo,
                                descricao: desc || '',
                                dia: d,
                                mes: mes,
                                ano: ano,
                                hora: hora || null,
                                local: local || null,
                                icone: icone,
                                cor_icone: corIcone,
                                data_inicio: `${ano}-${String(mes).padStart(2, '0')}-${String(diaInicio).padStart(2, '0')}`,
                                data_fim: diaFim ? `${ano}-${String(mes).padStart(2, '0')}-${String(diaFim).padStart(2, '0')}` : null,
                                is_recorrente: false,
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                        }
                    } else {
                        await App.supabase.from('eventos').insert({
                            user_id: App.currentUser.id,
                            titulo: titulo,
                            descricao: desc || '',
                            dia: diaInicio,
                            mes: mes,
                            ano: ano,
                            hora: hora || null,
                            local: local || null,
                            icone: icone,
                            cor_icone: corIcone,
                            data_inicio: `${ano}-${String(mes).padStart(2, '0')}-${String(diaInicio).padStart(2, '0')}`,
                            data_fim: null,
                            is_recorrente: false,
                            added_by: App.usuarioAtual || 'desconhecido'
                        });
                    }
                } else {
                    await App.supabase.from('regras_eventos').insert({
                        user_id: App.currentUser.id,
                        titulo_base: titulo,
                        descricao: desc || '',
                        dia: diaInicio,
                        hora: hora || null,
                        local: local || null,
                        icone: icone,
                        cor_icone: corIcone,
                        frequencia: frequencia,
                        data_inicio: `${ano}-${String(mes).padStart(2, '0')}-${String(diaInicio).padStart(2, '0')}`,
                        data_fim: diaFim ? `${ano}-${String(mes).padStart(2, '0')}-${String(diaFim).padStart(2, '0')}` : null,
                        ativo: true,
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                }

                verificarNotificacoes({ titulo, descricao: desc }, 'eventos');
                await registrarHistorico('criacao_evento', `Evento criado: ${titulo}`, { titulo, icone, usuario: App.usuarioAtual });
                showToast('Evento salvo!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar evento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoGasto() {
            let { mes, ano } = getMesAnoAtual();
            let diaPadrao = App.selectedDay || new Date().getDate();
            
            let categoriasHtml = CONFIG.categoriasGastos.map(c => 
                `<option value="${c.id}">${c.nome}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="gastoDescricao" class="form-input" placeholder="Ex: Compras mercado...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="gastoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-tag"></i> Categoria</label>
                    <select id="gastoCategoria" class="form-select" onchange="if(this.value==='outros') document.getElementById('gastoOutrosDiv').style.display='block'; else document.getElementById('gastoOutrosDiv').style.display='none'">
                        ${categoriasHtml}
                    </select>
                </div>
                <div id="gastoOutrosDiv" style="display:none" class="form-group">
                    <label class="form-label">Especifique a categoria</label>
                    <input type="text" id="gastoOutrosTexto" class="form-input" placeholder="Ex: Roupas, Presentes...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-day"></i> Dia</label>
                    <input type="number" id="gastoDia" class="form-input" min="1" max="31" value="${diaPadrao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-calendar-alt"></i> Mês/Ano</label>
                    <div style="display:flex;gap:8px">
                        <select id="gastoMes" class="form-select">
                            ${CONFIG.meses.map((m, i) => `<option value="${i + 1}" ${i + 1 === mes ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                        <input type="number" id="gastoAno" class="form-input" value="${ano}">
                    </div>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoGasto()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Gasto', 'fa-shopping-bag', conteudo);
        }

        async function salvarNovoGasto() {
            let desc = document.getElementById('gastoDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('gastoValor')?.value);
            let dia = parseInt(document.getElementById('gastoDia')?.value);
            let mes = parseInt(document.getElementById('gastoMes')?.value);
            let ano = parseInt(document.getElementById('gastoAno')?.value);
            let cat = document.getElementById('gastoCategoria')?.value;
            let catCustom = null;

            if (cat === 'outros') {
                catCustom = document.getElementById('gastoOutrosTexto')?.value.trim();
                if (!catCustom) {
                    showToast('Especifique a categoria', 'warning');
                    return;
                }
            }

            if (!desc || !valor || !dia || !mes || !ano) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            let diaAjustado = Math.min(dia, getDiasNoMes(ano, mes));
            let data = `${ano}-${String(mes).padStart(2, '0')}-${String(diaAjustado).padStart(2, '0')}`;

            try {
                let gastoData = {
                    user_id: App.currentUser.id,
                    descricao: desc,
                    valor: valor,
                    categoria: cat || 'outros',
                    dia: diaAjustado,
                    mes: mes,
                    ano: ano,
                    data: data,
                    added_by: App.usuarioAtual || 'desconhecido'
                };
                if (cat === 'outros' && catCustom) gastoData.categoria_customizada = catCustom;

                await App.supabase.from('gastos').insert(gastoData);

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor - valor;
                        await App.supabase.from('saldos').update({ valor: novoValor, data: data }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                verificarNotificacoes({ descricao: desc, valor }, 'gastos');
                await registrarHistorico('criacao_gasto', `Gasto: ${desc}`, { desc, valor, cat, usuario: App.usuarioAtual });
                showToast('Gasto registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoItemLista() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-sort-numeric-up"></i> Quantidade</label>
                    <input type="number" id="itemQuantidade" class="form-input" min="1" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="itemDescricao" class="form-input" placeholder="Ex: Arroz, Feijão...">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoItemLista()" style="flex:2"><i class="fas fa-save"></i> Adicionar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Item na Lista', 'fa-shopping-cart', conteudo);
        }

        async function salvarNovoItemLista() {
            let qtd = parseInt(document.getElementById('itemQuantidade')?.value);
            let desc = document.getElementById('itemDescricao')?.value.trim();

            if (!qtd || !desc) {
                showToast('Preencha quantidade e descrição', 'warning');
                return;
            }

            try {
                await App.supabase.from('lista_compras').insert({
                    user_id: App.currentUser.id,
                    quantidade: qtd,
                    descricao: desc,
                    comprado: false,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                verificarNotificacoes({ descricao: desc }, 'lista');
                await registrarHistorico('criacao_lista', `Item adicionado: ${desc}`, { qtd, desc, usuario: App.usuarioAtual });
                showToast('Item adicionado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirNovoGiro() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="giroDescricao" class="form-input" placeholder="Ex: Empréstimo para João">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor Inicial</label>
                    <input type="text" id="giroValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Pessoa</label>
                    <input type="text" id="giroPessoa" class="form-input" placeholder="Nome da pessoa">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoGiro()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Giro', 'fa-hand-holding-usd', conteudo);
        }

        async function salvarNovoGiro() {
            let desc = document.getElementById('giroDescricao')?.value.trim();
            let valor = parseCurrency(document.getElementById('giroValor')?.value);
            let pessoa = document.getElementById('giroPessoa')?.value.trim();

            if (!desc || !valor || !pessoa) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('giros').insert({
                    user_id: App.currentUser.id,
                    descricao: desc,
                    valor_inicial: valor,
                    pessoa: pessoa,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('criacao_giro', `Giro criado: ${desc}`, { desc, valor, pessoa, usuario: App.usuarioAtual });
                showToast('Giro salvo!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao salvar giro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirPagamentoGiro(id, desc) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor do Pagamento</label>
                    <input type="text" id="pagamentoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descrição (opcional)</label>
                    <input type="text" id="pagamentoDescricao" class="form-input" placeholder="Ex: Parcela 1">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-success" onclick="salvarPagamentoGiro('${id}','${desc}')" style="flex:2"><i class="fas fa-check"></i> Confirmar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal(`Pagar ${desc}`, 'fa-arrow-down', conteudo);
        }

        async function salvarPagamentoGiro(id, desc) {
            let valor = parseCurrency(document.getElementById('pagamentoValor')?.value);
            let descricao = document.getElementById('pagamentoDescricao')?.value.trim();

            if (!valor) {
                showToast('Digite o valor', 'warning');
                return;
            }

            try {
                await App.supabase.from('movimentacoes_giro').insert({
                    user_id: App.currentUser.id,
                    giro_id: id,
                    tipo: 'pagamento',
                    valor: valor,
                    descricao: descricao || `Pagamento para ${desc}`,
                    data: new Date().toISOString(),
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('pagamento_giro', `Pagamento de ${formatCurrency(valor)} para ${desc}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Pagamento registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao registrar pagamento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirRecebimentoGiro(id, desc) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor do Recebimento</label>
                    <input type="text" id="recebimentoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-align-left"></i> Descrição (opcional)</label>
                    <input type="text" id="recebimentoDescricao" class="form-input" placeholder="Ex: Parcela 1">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-warning" onclick="salvarRecebimentoGiro('${id}','${desc}')" style="flex:2"><i class="fas fa-check"></i> Confirmar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal(`Receber ${desc}`, 'fa-arrow-up', conteudo);
        }

        async function salvarRecebimentoGiro(id, desc) {
            let valor = parseCurrency(document.getElementById('recebimentoValor')?.value);
            let descricao = document.getElementById('recebimentoDescricao')?.value.trim();

            if (!valor) {
                showToast('Digite o valor', 'warning');
                return;
            }

            try {
                await App.supabase.from('movimentacoes_giro').insert({
                    user_id: App.currentUser.id,
                    giro_id: id,
                    tipo: 'recebimento',
                    valor: valor,
                    descricao: descricao || `Recebimento de ${desc}`,
                    data: new Date().toISOString(),
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('recebimento_giro', `Recebimento de ${formatCurrency(valor)} de ${desc}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Recebimento registrado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao registrar recebimento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarGiro(id) {
            let giro = App.dataCache.giros.find(g => g.id === id);
            if (!giro) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="giroDescricaoEdit" class="form-input" value="${giro.descricao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user"></i> Pessoa</label>
                    <input type="text" id="giroPessoaEdit" class="form-input" value="${giro.pessoa || ''}">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoGiro('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Giro', 'fa-edit', conteudo);
        }

        async function salvarEdicaoGiro(id) {
            let desc = document.getElementById('giroDescricaoEdit')?.value.trim();
            let pessoa = document.getElementById('giroPessoaEdit')?.value.trim();

            if (!desc || !pessoa) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('giros').update({
                    descricao: desc,
                    pessoa: pessoa
                }).eq('id', id);

                await registrarHistorico('edicao_giro', `Giro editado: ${desc}`, { id, usuario: App.usuarioAtual });
                showToast('Giro atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar giro:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function deletarGiro(id) {
            if (confirm('Tem certeza que deseja excluir este giro?')) {
                (async () => {
                    try {
                        await App.supabase.from('movimentacoes_giro').delete().eq('giro_id', id);
                        await App.supabase.from('giros').delete().eq('id', id);
                        await registrarHistorico('exclusao_giro', `Giro excluído`, { id, usuario: App.usuarioAtual });
                        showToast('Giro excluído!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir giro:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function abrirModalPagamento(id, desc, valor, regraId, dia, mes, ano, isRecorrente) {
            let conteudo = `
                <div style="padding:16px">
                    <p>Pagamento de <strong>${desc}</strong></p>
                    <div class="form-group" style="margin:16px 0">
                        <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor a pagar</label>
                        <input type="text" id="pagamentoValorConta" class="form-input" value="${valor.toFixed(2).replace('.', ',')}" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="confirmarPagamento('${id}', '${regraId}', ${dia}, ${mes}, ${ano}, ${isRecorrente})" style="flex:2"><i class="fas fa-check"></i> Confirmar Pagamento</button>
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Confirmar Pagamento', 'fa-dollar-sign', conteudo);
        }

        async function confirmarPagamento(id, regraId, dia, mes, ano, isRecorrente) {
            let valor = parseCurrency(document.getElementById('pagamentoValorConta')?.value);

            try {
                if (isRecorrente && regraId) {
                    await App.supabase.from('excecoes_recorrencia').insert({
                        user_id: App.currentUser.id,
                        regra_id: regraId,
                        data_excecao: `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`,
                        acao: 'pagar',
                        added_by: App.usuarioAtual || 'desconhecido'
                    });
                } else {
                    await App.supabase.from('contas').update({
                        valor_pago: valor,
                        status: 'paga',
                        data_pagamento: new Date().toISOString()
                    }).eq('id', id);
                }

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor - valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('pagamento_conta', `Conta paga: ${id}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Pagamento confirmado!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao pagar conta:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirModalDesfazerPagamento(id, desc, valor, regraId, dia, mes, ano, isRecorrente) {
            let conteudo = `
                <div style="padding:16px; text-align:center">
                    <p>Desfazer pagamento de <strong>${desc}</strong>?</p>
                    <p style="font-size:1.2em; margin:16px 0">${formatCurrency(valor)} voltará para o saldo</p>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="desfazerPagamento('${id}', ${valor}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isRecorrente})" style="flex:2"><i class="fas fa-undo-alt"></i> Desfazer</button>
                        <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                    </div>
                </div>
            `;
            abrirModal('Desfazer Pagamento', 'fa-undo-alt', conteudo);
        }

        async function desfazerPagamento(id, valor, regraId, dia, mes, ano, isRecorrente) {
            try {
                if (isRecorrente && regraId) {
                    await App.supabase
                        .from('excecoes_recorrencia')
                        .delete()
                        .eq('regra_id', regraId)
                        .eq('data_excecao', `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`);
                } else {
                    await App.supabase.from('contas').update({
                        valor_pago: 0,
                        status: 'pendente',
                        data_pagamento: null
                    }).eq('id', id);
                }

                if (App.saldoCentral.id) {
                    let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                    if (saldoAtual) {
                        let novoValor = saldoAtual.valor + valor;
                        await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('desfazer_pagamento', `Pagamento desfeito: ${id}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Pagamento desfeito!', 'success');
                fecharModal();
                await carregarDados(true);
                await atualizarCalendario();
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao desfazer pagamento:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function cancelarGasto(id, desc, valor) {
            if (confirm(`Cancelar gasto ${desc} de ${formatCurrency(valor)}?`)) {
                (async () => {
                    try {
                        await App.supabase.from('gastos').delete().eq('id', id);

                        if (App.saldoCentral.id) {
                            let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', App.saldoCentral.id).single();
                            if (saldoAtual) {
                                let novoValor = saldoAtual.valor + valor;
                                await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', App.saldoCentral.id);
                                App.saldoCentral.valor = novoValor;
                                atualizarSaldoHeader();
                            }
                        }

                        await registrarHistorico('cancelamento_gasto', `Gasto cancelado: ${desc}`, { id, valor, usuario: App.usuarioAtual });
                        showToast('Gasto cancelado!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao cancelar gasto:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function deletarGasto(id) {
            if (confirm('Tem certeza que deseja excluir este gasto permanentemente?')) {
                (async () => {
                    try {
                        await App.supabase.from('gastos').delete().eq('id', id);
                        showToast('Gasto excluído!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir gasto:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function editarGasto(id) {
            let gasto = App.dataCache.gastos.find(g => g.id === id);
            if (!gasto) return;
            
            let categoriasHtml = CONFIG.categoriasGastos.map(c => 
                `<option value="${c.id}" ${gasto.categoria === c.id ? 'selected' : ''}>${c.nome}</option>`
            ).join('');

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="gastoDescricaoEdit" class="form-input" value="${gasto.descricao}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor</label>
                    <input type="text" id="gastoValorEdit" class="form-input" value="${gasto.valor.toFixed(2).replace('.', ',')}" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-tag"></i> Categoria</label>
                    <select id="gastoCategoriaEdit" class="form-select">
                        ${categoriasHtml}
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoGasto('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Gasto', 'fa-edit', conteudo);
        }

        async function salvarEdicaoGasto(id) {
            let desc = document.getElementById('gastoDescricaoEdit')?.value.trim();
            let valor = parseCurrency(document.getElementById('gastoValorEdit')?.value);
            let cat = document.getElementById('gastoCategoriaEdit')?.value;

            if (!desc || !valor) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('gastos').update({
                    descricao: desc,
                    valor: valor,
                    categoria: cat
                }).eq('id', id);

                showToast('Gasto atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar gasto:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function alternarComprado(id) {
            (async () => {
                try {
                    let item = App.dataCache.lista.find(i => i.id === id);
                    if (item) {
                        await App.supabase.from('lista_compras').update({
                            comprado: !item.comprado
                        }).eq('id', id);

                        await registrarHistorico('alternar_lista', `Item ${item.comprado ? 'desmarcado' : 'marcado'}: ${item.descricao}`, { id, usuario: App.usuarioAtual });
                        await carregarDados(true);
                        await mostrarConteudo();
                    }
                } catch (error) {
                    console.error('Erro ao alternar item:', error);
                    showToast('Erro: ' + error.message, 'error');
                }
            })();
        }

        function deletarItemLista(id) {
            if (confirm('Remover item da lista?')) {
                (async () => {
                    try {
                        await App.supabase.from('lista_compras').delete().eq('id', id);
                        await registrarHistorico('exclusao_lista', `Item removido da lista`, { id, usuario: App.usuarioAtual });
                        showToast('Item removido!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao remover item:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function editarItemLista(id) {
            let item = App.dataCache.lista.find(i => i.id === id);
            if (!item) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-sort-numeric-up"></i> Quantidade</label>
                    <input type="number" id="itemQuantidadeEdit" class="form-input" min="1" value="${item.quantidade}">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Descrição</label>
                    <input type="text" id="itemDescricaoEdit" class="form-input" value="${item.descricao}">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoLista('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Item', 'fa-edit', conteudo);
        }

        async function salvarEdicaoLista(id) {
            let qtd = parseInt(document.getElementById('itemQuantidadeEdit')?.value);
            let desc = document.getElementById('itemDescricaoEdit')?.value.trim();

            if (!qtd || !desc) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                await App.supabase.from('lista_compras').update({
                    quantidade: qtd,
                    descricao: desc
                }).eq('id', id);

                await registrarHistorico('edicao_lista', `Item editado: ${desc}`, { id, usuario: App.usuarioAtual });
                showToast('Item atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar item:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirAdicionarValorSaldo(id) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor para Adicionar</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-success" onclick="confirmarAdicionarSaldo('${id}')" style="flex:2"><i class="fas fa-plus"></i> Adicionar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Adicionar ao Saldo', 'fa-plus-circle', conteudo);
        }

        async function confirmarAdicionarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (!valor) {
                showToast('Digite um valor', 'warning');
                return;
            }

            try {
                let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', id).single();
                if (saldoAtual) {
                    let novoValor = saldoAtual.valor + valor;
                    await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', id);
                    if (id === App.saldoCentral.id) {
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('adicao_saldo', `Adicionado ${formatCurrency(valor)} ao saldo`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao adicionar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirRetirarValorSaldo(id) {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor para Retirar</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-warning" onclick="confirmarRetirarSaldo('${id}')" style="flex:2"><i class="fas fa-minus"></i> Retirar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Retirar do Saldo', 'fa-minus-circle', conteudo);
        }

        async function confirmarRetirarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (!valor) {
                showToast('Digite um valor', 'warning');
                return;
            }

            try {
                let { data: saldoAtual } = await App.supabase.from('saldos').select('valor').eq('id', id).single();
                if (saldoAtual) {
                    let novoValor = saldoAtual.valor - valor;
                    await App.supabase.from('saldos').update({ valor: novoValor }).eq('id', id);
                    if (id === App.saldoCentral.id) {
                        App.saldoCentral.valor = novoValor;
                        atualizarSaldoHeader();
                    }
                }

                await registrarHistorico('retirada_saldo', `Retirado ${formatCurrency(valor)} do saldo`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao retirar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function abrirAtualizarValorSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Novo Valor</label>
                    <input type="text" id="saldoValor" class="form-input" value="${saldo.valor.toFixed(2).replace('.', ',')}" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="confirmarAtualizarSaldo('${id}')" style="flex:2"><i class="fas fa-save"></i> Atualizar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Atualizar Saldo', 'fa-sync-alt', conteudo);
        }

        async function confirmarAtualizarSaldo(id) {
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            if (valor === undefined) {
                showToast('Digite um valor válido', 'warning');
                return;
            }

            try {
                await App.supabase.from('saldos').update({ valor: valor }).eq('id', id);
                if (id === App.saldoCentral.id) {
                    App.saldoCentral.valor = valor;
                    atualizarSaldoHeader();
                }

                await registrarHistorico('atualizacao_saldo', `Saldo atualizado para ${formatCurrency(valor)}`, { id, valor, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao atualizar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function editarSaldo(id) {
            let saldo = App.dataCache.saldos.find(s => s.id === id);
            if (!saldo) return;

            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Nome do Saldo</label>
                    <input type="text" id="saldoNomeEdit" class="form-input" value="${saldo.nome || ''}">
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarEdicaoSaldo('${id}')" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Editar Saldo', 'fa-edit', conteudo);
        }

        async function salvarEdicaoSaldo(id) {
            let nome = document.getElementById('saldoNomeEdit')?.value.trim();

            try {
                await App.supabase.from('saldos').update({ nome: nome }).eq('id', id);
                await registrarHistorico('edicao_saldo', `Saldo renomeado para ${nome}`, { id, usuario: App.usuarioAtual });
                showToast('Saldo atualizado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao editar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function deletarSaldo(id) {
            if (confirm('Tem certeza que deseja excluir este saldo?')) {
                (async () => {
                    try {
                        await App.supabase.from('saldos').delete().eq('id', id);
                        await registrarHistorico('exclusao_saldo', `Saldo excluído`, { id, usuario: App.usuarioAtual });
                        showToast('Saldo excluído!', 'success');
                        await carregarDados(true);
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir saldo:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function abrirNovoSaldo() {
            let conteudo = `
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-heading"></i> Nome do Saldo</label>
                    <input type="text" id="saldoNome" class="form-input" placeholder="Ex: Poupança, Carteira...">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor Inicial</label>
                    <input type="text" id="saldoValor" class="form-input" placeholder="0,00" onkeyup="this.value = this.value.replace(/[^0-9,]/g, '')">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-check-circle"></i> Saldo Central?</label>
                    <select id="saldoCentral" class="form-select">
                        <option value="false">Não</option>
                        <option value="true">Sim</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top:20px">
                    <button class="btn btn-primary" onclick="salvarNovoSaldo()" style="flex:2"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn" onclick="fecharModal()" style="flex:1;background:var(--gray);color:#fff">Cancelar</button>
                </div>
            `;
            abrirModal('Novo Saldo', 'fa-wallet', conteudo);
        }

        async function salvarNovoSaldo() {
            let nome = document.getElementById('saldoNome')?.value.trim();
            let valor = parseCurrency(document.getElementById('saldoValor')?.value);
            let isCentral = document.getElementById('saldoCentral')?.value === 'true';

            if (!nome || !valor) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            try {
                if (isCentral) {
                    let centralExistente = App.dataCache.saldos.find(s => s.is_central);
                    if (centralExistente) {
                        showToast('Já existe um saldo central', 'warning');
                        return;
                    }
                }

                await App.supabase.from('saldos').insert({
                    user_id: App.currentUser.id,
                    nome: nome,
                    valor: valor,
                    is_central: isCentral,
                    added_by: App.usuarioAtual || 'desconhecido'
                });

                await registrarHistorico('criacao_saldo', `Saldo criado: ${nome}`, { nome, valor, isCentral, usuario: App.usuarioAtual });
                showToast('Saldo criado!', 'success');
                fecharModal();
                await carregarDados(true);
                await mostrarConteudo();
            } catch (error) {
                console.error('Erro ao criar saldo:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }

        function autenticarSaldos() {
            let senha = prompt('Senha de 4 dígitos:');
            if (senha === App.saldoSenha) {
                App.saldoAutenticado = true;
                App.currentFilter = 'saldos';
                mostrarConteudo();
            } else if (senha) showToast('Senha incorreta', 'error');
        }

        function editarItem(id, tipo, isRecorrente, regraId, isIndividual, individualId) {
            if (tipo === 'gasto') {
                editarGasto(id);
            } else if (tipo === 'evento') {
                let item = App.dataCache.eventos.find(e => e.id === id) || 
                           App.dataCache.eventosIndividuais.find(e => `evento_individual_${e.id}` === id);
                if (!item) return;
                
                let conteudo = `
                    <div style="padding:16px">
                        <h3>${item.titulo}</h3>
                        <p>${item.descricao || ''}</p>
                        <p><i class="fas fa-calendar-day"></i> Dia: ${item.dia} de ${getNomeMes(item.mes)}/${item.ano}</p>
                        ${item.hora ? `<p><i class="fas fa-clock"></i> Hora: ${item.hora}</p>` : ''}
                        ${item.local ? `<p><i class="fas fa-map-marker-alt"></i> Local: ${item.local}</p>` : ''}
                        <div class="btn-group" style="margin-top:20px">
                            <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                        </div>
                    </div>
                `;
                abrirModal('Detalhes do Evento', 'fa-calendar-alt', conteudo);
            } else if (tipo === 'conta') {
                let item = App.dataCache.contas.find(c => c.id === id);
                if (!item) return;
                
                let conteudo = `
                    <div style="padding:16px">
                        <h3>${item.descricao}</h3>
                        <p><strong>Valor:</strong> ${formatCurrency(item.valor_original || item.valor || 0)}</p>
                        <p><strong>Vencimento:</strong> ${item.dia} de ${getNomeMes(item.mes)}/${item.ano}</p>
                        <p><strong>Status:</strong> ${item.status === 'paga' ? 'Paga' : 'Pendente'}</p>
                        ${item.valor_pago > 0 ? `<p><strong>Valor pago:</strong> ${formatCurrency(item.valor_pago)}</p>` : ''}
                        <div class="btn-group" style="margin-top:20px">
                            <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
                        </div>
                    </div>
                `;
                abrirModal('Detalhes da Conta', 'fa-file-invoice-dollar', conteudo);
            }
        }

        function confirmarExclusao(id, tipo, isRecorrente, regraId, dia, mes, ano, isIndividual, individualId) {
            if (tipo === 'evento' && (isRecorrente || regraId)) {
                let conteudo = `
                    <div style="padding:16px">
                        <h3 style="margin-bottom:16px">Excluir Evento</h3>
                        <p>Como deseja excluir este evento?</p>
                        <div class="exclusao-opcoes">
                            <div class="exclusao-opcao" onclick="selecionarExclusao('unica', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoUnica">
                                <strong>Apenas esta ocorrência</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui somente este evento específico</p>
                            </div>
                            <div class="exclusao-opcao" onclick="selecionarExclusao('futuras', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoFuturas">
                                <strong>Desta data em diante</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui este e todos os futuros</p>
                            </div>
                            <div class="exclusao-opcao" onclick="selecionarExclusao('todas', '${id}', '${tipo}', ${isRecorrente}, '${regraId}', ${dia}, ${mes}, ${ano}, ${isIndividual}, '${individualId}')" id="exclusaoTodas">
                                <strong>Todas as ocorrências</strong>
                                <p style="font-size:0.9em;color:var(--gray)">Exclui a regra inteira</p>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top:20px">
                            <button class="btn" onclick="fecharModal()" style="background:var(--gray);color:#fff">Cancelar</button>
                        </div>
                    </div>
                `;
                abrirModal('Excluir Evento', 'fa-trash', conteudo);
            } else if (confirm(`Tem certeza que deseja excluir este ${tipo}?`)) {
                (async () => {
                    try {
                        if (tipo === 'gasto') {
                            await App.supabase.from('gastos').delete().eq('id', id);
                        } else if (tipo === 'evento') {
                            await App.supabase.from('eventos').delete().eq('id', id);
                        } else if (tipo === 'conta') {
                            await App.supabase.from('contas').delete().eq('id', id);
                        }

                        await registrarHistorico('exclusao_item', `${tipo} excluído`, { id, tipo, usuario: App.usuarioAtual });
                        showToast('Item excluído!', 'success');
                        await carregarDados(true);
                        await atualizarCalendario();
                        await mostrarConteudo();
                    } catch (error) {
                        console.error('Erro ao excluir:', error);
                        showToast('Erro: ' + error.message, 'error');
                    }
                })();
            }
        }

        function selecionarExclusao(tipo, id, tipoItem, isRecorrente, regraId, dia, mes, ano, isIndividual, individualId) {
            (async () => {
                try {
                    if (tipo === 'unica') {
                        if (isIndividual && individualId) {
                            await App.supabase.from('eventos_individuais').delete().eq('id', individualId);
                        } else {
                            let dataExcecao = `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                            await App.supabase.from('excecoes_recorrencia').insert({
                                user_id: App.currentUser.id,
                                regra_id: regraId,
                                data_excecao: dataExcecao,
                                acao: 'excluir',
                                added_by: App.usuarioAtual || 'desconhecido'
                            });
                        }
                    } else if (tipo === 'futuras') {
                        await App.supabase
                            .from('regras_eventos')
                            .update({ data_fim: `${ano}-${String(mes).padStart(2, '0')}-${String(dia - 1).padStart(2, '0')}` })
                            .eq('id', regraId);
                    } else if (tipo === 'todas') {
                        await App.supabase.from('regras_eventos').delete().eq('id', regraId);
                        await App.supabase.from('eventos_individuais').delete().eq('regra_id', regraId);
                        await App.supabase.from('excecoes_recorrencia').delete().eq('regra_id', regraId);
                    }

                    await registrarHistorico('exclusao_evento', `Evento excluído (${tipo})`, { id, tipo, usuario: App.usuarioAtual });
                    showToast('Evento excluído!', 'success');
                    fecharModal();
                    await carregarDados(true);
                    await atualizarCalendario();
                    await mostrarConteudo();
                } catch (error) {
                    console.error('Erro ao excluir evento:', error);
                    showToast('Erro: ' + error.message, 'error');
                }
            })();
        }

        function resetarParaHoje() {
            let hoje = new Date();
            App.currentMonthOffset = 0;
            App.selectedDay = hoje.getDate();
            App.activeFilters = { contas: true, eventos: true };
            App.currentFilter = 'all';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                let filter = btn.dataset.filter;
                btn.classList.toggle('active', App.activeFilters[filter]);
            });
            
            atualizarCalendario();
            mostrarConteudo();
        }

        function abrirSideMenu() {
            document.getElementById('sideMenu').classList.add('open');
            document.getElementById('sideMenuOverlay').classList.add('open');
        }

        function fecharSideMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('sideMenuOverlay').classList.remove('open');
        }

        function fecharAddMenu() {
            document.getElementById('addOptionsMenu').classList.remove('show');
            document.getElementById('navAdd').classList.remove('active');
        }

        async function init() {
            try {
                App.supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                let { data: { session } } = await App.supabase.auth.getSession();

                if (session) {
                    App.currentUser = session.user;
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';

                    await carregarUsuariosCadastrados();
                    carregarConfigLocal();

                    await carregarDados(true);

                    let hoje = new Date();
                    App.currentMonthOffset = 0;
                    App.selectedDay = hoje.getDate();
                    App.currentFilter = 'all';
                    App.activeFilters = { contas: true, eventos: true };

                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        let filter = btn.dataset.filter;
                        btn.classList.toggle('active', App.activeFilters[filter]);
                    });

                    await atualizarCalendario();
                    await mostrarConteudo();
                } else {
                    document.getElementById('authContainer').style.display = 'flex';
                }

                document.getElementById('btnLogin').addEventListener('click', async () => {
                    let email = document.getElementById('loginEmail').value.trim();
                    let pass = document.getElementById('loginPassword').value;

                    if (!email || !pass) {
                        showToast('Preencha email e senha', 'warning');
                        return;
                    }

                    try {
                        let { data, error } = await App.supabase.auth.signInWithPassword({ email, password: pass });
                        if (error) showToast(error.message, 'error');
                        else {
                            App.currentUser = data.user;
                            document.getElementById('authContainer').style.display = 'none';
                            document.getElementById('mainContainer').style.display = 'block';
                            await carregarUsuariosCadastrados();
                            await carregarDados(true);
                            resetarParaHoje();
                            showToast('Login realizado!', 'success');
                        }
                    } catch (e) {
                        showToast('Erro no login', 'error');
                    }
                });

                document.getElementById('btnRegister').addEventListener('click', async () => {
                    let email = document.getElementById('registerEmail').value.trim();
                    let pass = document.getElementById('registerPassword').value;

                    if (!email || !pass) {
                        showToast('Preencha email e senha', 'warning');
                        return;
                    }
                    if (pass.length < 6) {
                        showToast('Senha mínimo 6 caracteres', 'warning');
                        return;
                    }

                    try {
                        let { error } = await App.supabase.auth.signUp({ email, password: pass });
                        if (error) showToast(error.message, 'error');
                        else {
                            showToast('Conta criada! Faça login.', 'success');
                            document.getElementById('registerForm').style.display = 'none';
                            document.getElementById('loginForm').style.display = 'block';
                        }
                    } catch (e) {
                        showToast('Erro no registro', 'error');
                    }
                });

                document.getElementById('btnLogout').addEventListener('click', () => {
                    if (confirm('Deseja realmente sair?')) {
                        App.supabase.auth.signOut();
                        App.currentUser = null;
                        App.saldoAutenticado = false;
                        App.usuarioAtual = null;
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('mainContainer').style.display = 'none';
                    }
                });

                document.getElementById('linkRegister').addEventListener('click', () => {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'block';
                });

                document.getElementById('linkLogin').addEventListener('click', () => {
                    document.getElementById('registerForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                });

                document.getElementById('btnToday').addEventListener('click', resetarParaHoje);

                document.getElementById('btnPrevMonth').addEventListener('click', () => {
                    App.currentMonthOffset--;
                    App.selectedDay = null;
                    atualizarCalendario();
                    mostrarConteudo();
                });

                document.getElementById('btnNextMonth').addEventListener('click', () => {
                    App.currentMonthOffset++;
                    App.selectedDay = null;
                    atualizarCalendario();
                    mostrarConteudo();
                });

                document.getElementById('btnSaldoHeader').addEventListener('click', () => {
                    let senha = prompt('Senha de 4 dígitos:');
                    if (senha === App.saldoSenha) {
                        App.saldoAutenticado = true;
                        App.currentFilter = 'saldos';
                        mostrarConteudo();
                    } else if (senha) showToast('Senha incorreta', 'error');
                });

                document.getElementById('btnUsuarioHeader').addEventListener('click', verificarUsuario);

                document.getElementById('navMenu').addEventListener('click', abrirSideMenu);
                document.getElementById('sideMenuOverlay').addEventListener('click', fecharSideMenu);

                document.getElementById('navAdd').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('addOptionsMenu').classList.toggle('show');
                    document.getElementById('navAdd').classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!document.getElementById('navAdd').contains(e.target) && !document.getElementById('addOptionsMenu').contains(e.target)) {
                        fecharAddMenu();
                    }
                });

                document.getElementById('navLista').addEventListener('click', () => {
                    App.currentFilter = 'lista';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.getElementById('navGastos').addEventListener('click', () => {
                    App.currentFilter = 'gastos';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.getElementById('navSaldos').addEventListener('click', () => {
                    if (!App.saldoAutenticado) {
                        let senha = prompt('Senha de 4 dígitos:');
                        if (senha === App.saldoSenha) {
                            App.saldoAutenticado = true;
                            App.currentFilter = 'saldos';
                            mostrarConteudo();
                        } else if (senha) showToast('Senha incorreta', 'error');
                    } else {
                        App.currentFilter = 'saldos';
                        mostrarConteudo();
                    }
                    fecharAddMenu();
                });

                document.getElementById('navGiros').addEventListener('click', () => {
                    App.currentFilter = 'giros';
                    mostrarConteudo();
                    fecharAddMenu();
                });

                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        let filter = this.dataset.filter;
                        if (filter === 'contas' || filter === 'eventos') {
                            App.activeFilters[filter] = !App.activeFilters[filter];
                            this.classList.toggle('active', App.activeFilters[filter]);
                            mostrarConteudo();
                        }
                    });
                });

                document.getElementById('modalOverlay').addEventListener('click', e => {
                    if (e.target === e.currentTarget) fecharModal();
                });

            } catch (error) {
                console.error('Erro na inicialização:', error);
                showToast('Erro ao iniciar: ' + error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
